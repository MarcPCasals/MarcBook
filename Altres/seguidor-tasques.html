<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguidor de Tasques | Profe Dashboard</title>
    
    <!-- React & ReactDOM (CDN estables) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #fff7ed; } /* Fons taronja molt suau */
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Animacions suaus */
        .progress-bar { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.5s ease; }
        .cell-transition { transition: all 0.2s ease; }
        .cell-transition:active { transform: scale(0.9); }
        .tab-transition { transition: all 0.3s ease; }

        /* Estils graella alterns - GRISOS NEUTRES */
        .row-even { background-color: #f8fafc; } /* Slate-50 */
        .row-odd { background-color: #ffffff; }
        .col-highlight { background-color: rgba(241, 245, 249, 0.6); } /* Slate-100 semi-transparent */

        /* Scroll personalitzat */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #fff7ed; }
        ::-webkit-scrollbar-thumb { background: #fdba74; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f97316; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Definici贸 d'Icones SVG Internes ---
        const Icon = ({ children, size = 20, className = "", onClick, title }) => (
            <svg onClick={onClick} title={title} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Award = (p) => <Icon {...p}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></Icon>;
        const Plus = (p) => <Icon {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>;
        const Users = (p) => <Icon {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>;
        const MoreHorizontal = (p) => <Icon {...p}><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></Icon>;
        const Download = (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>;
        const Upload = (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></Icon>;
        const CheckCircle = (p) => <Icon {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const XCircle = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></Icon>;
        const Clock = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>;
        const Trash2 = (p) => <Icon {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Icon>;
        const Calendar = (p) => <Icon {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></Icon>;
        const Edit2 = (p) => <Icon {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></Icon>;
        const AlertTriangle = (p) => <Icon {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>;
        const Layers = (p) => <Icon {...p}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></Icon>;

        // --- Config inicial ---
        const STATUS_TYPES = {
            EMPTY: { value: null, color: 'text-slate-200 hover:text-slate-400', bg: 'bg-transparent', icon: null, label: 'Buit' },
            DONE: { value: 1, color: 'text-emerald-500', bg: 'bg-emerald-100', icon: 'check', label: 'Fet' },
            MISSING: { value: 0, color: 'text-rose-500', bg: 'bg-rose-100', icon: 'x', label: 'No fet' },
            LATE: { value: 0.5, color: 'text-amber-500', bg: 'bg-amber-100', icon: 'clock', label: 'Mig fet / Tard' }
        };

        const MAX_PENALTIES = 3;

        // Estructura UTs per defecte (IDs fixos per facilitar la c貌pia)
        const DEFAULT_UTS = [
            { id: 'ut1', name: 'UT 1' },
            { id: 'ut2', name: 'UT 2' },
            { id: 'ut3', name: 'UT 3' },
            { id: 'ut4', name: 'UT 4' },
            { id: 'default', name: 'General' }
        ];

        // --- Components ---

        const Modal = ({ title, onClose, children, variant = 'default' }) => {
            const colors = variant === 'danger' ? 'border-rose-200 bg-rose-50' : 'bg-white';
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-in fade-in duration-200" onClick={(e) => e.target === e.currentTarget && onClose()}>
                    <div className={`${colors} rounded-2xl shadow-2xl w-full max-w-md p-6 m-4 transform transition-all scale-100 max-h-[90vh] overflow-y-auto`}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className={`text-xl font-bold ${variant === 'danger' ? 'text-rose-700' : 'text-slate-800'}`}>{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><XCircle size={24} /></button>
                        </div>
                        {children}
                    </div>
                </div>
            );
        };

        const App = () => {
            // --- Estat Global ---
            const [classes, setClasses] = useState([{ id: 'default', name: 'Classe Principal' }]);
            const [activeClassId, setActiveClassId] = useState('default');
            const [allData, setAllData] = useState({ 
                'default': { students: [], tasks: [], records: {}, penalties: {}, uts: DEFAULT_UTS } 
            });

            // --- Estat UI Local ---
            const [activeUtId, setActiveUtId] = useState('ut1'); // Per defecte comencem a la UT 1
            
            const [isAddingTask, setIsAddingTask] = useState(false);
            const [isManagingStudents, setIsManagingStudents] = useState(false);
            const [isAddingClass, setIsAddingClass] = useState(false);
            const [isEditingClass, setIsEditingClass] = useState(false);
            const [isAddingUt, setIsAddingUt] = useState(false);
            const [isEditingUt, setIsEditingUt] = useState(false); 
            
            const [editingTaskDate, setEditingTaskDate] = useState(null); 
            const [selectedStudent, setSelectedStudent] = useState(null); 
            const [penaltyAlert, setPenaltyAlert] = useState(null);

            // Form States
            const [newTaskName, setNewTaskName] = useState("");
            const [newTaskDate, setNewTaskDate] = useState(new Date().toISOString().split('T')[0]); 
            const [copyToClasses, setCopyToClasses] = useState({});
            
            const [newStudentList, setNewStudentList] = useState(""); 
            const [newClassName, setNewClassName] = useState("");
            const [editClassName, setEditClassName] = useState("");
            const [newUtName, setNewUtName] = useState("");
            const [editUtName, setEditUtName] = useState(""); 

            // --- Derivats ---
            const currentData = allData[activeClassId] || { students: [], tasks: [], records: {}, penalties: {}, uts: [] };
            const students = currentData.students || [];
            const uts = currentData.uts || DEFAULT_UTS;
            
            // FILTRE DE TASQUES
            const visibleTasks = useMemo(() => {
                const rawTasks = currentData.tasks || [];
                const sortFn = (a, b) => a.date.localeCompare(b.date);

                if (activeUtId === 'default') {
                    // Si estem a GENERAL: Mostrem TOTES les tasques (Unificades)
                    return [...rawTasks].sort(sortFn);
                } else {
                    // Si estem a una UT especifica: Filtrem
                    // Assignem 'default' a tasques velles sense UT, o busquem la UT correcta
                    const tasksWithUt = rawTasks.map(t => ({...t, utId: t.utId || 'default'}));
                    return tasksWithUt.filter(t => t.utId === activeUtId).sort(sortFn);
                }
            }, [currentData.tasks, activeUtId]);

            // CLCUL CAPALERES GRUPADES PER UT (Nom茅s per a vista General)
            const groupedUtHeaders = useMemo(() => {
                if (activeUtId !== 'default' || visibleTasks.length === 0) return [];
                
                const headers = [];
                let currentUt = null;
                let count = 0;

                visibleTasks.forEach(task => {
                    const taskUtId = task.utId || 'default';
                    if (taskUtId !== currentUt) {
                        if (currentUt !== null) {
                            headers.push({ id: currentUt, count });
                        }
                        currentUt = taskUtId;
                        count = 1;
                    } else {
                        count++;
                    }
                });
                if (currentUt !== null) {
                    headers.push({ id: currentUt, count });
                }
                return headers;
            }, [visibleTasks, activeUtId]);

            const allClassTasks = currentData.tasks || []; 
            const records = currentData.records || {};
            const penalties = currentData.penalties || {};

            // Update Active UT when class changes
            useEffect(() => {
                const classUts = allData[activeClassId]?.uts;
                if (classUts && classUts.length > 0) {
                    if (!classUts.find(u => u.id === activeUtId)) {
                        // Si la UT activa no existeix en la nova classe (poc probable amb IDs fixos, per貌 per si de cas)
                        // intentem anar a la mateixa ID (per mantenir context), si no a la primera.
                        const sameIdUt = classUts.find(u => u.id === activeUtId);
                        setActiveUtId(sameIdUt ? sameIdUt.id : classUts[0].id);
                    }
                } else {
                    setActiveUtId('default');
                }
            }, [activeClassId, allData]);

            // Carregar dades
            useEffect(() => {
                const savedData = localStorage.getItem('seguidor_tasques_data');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.version >= 2) {
                            setClasses(parsed.classes);
                            const migratedData = { ...parsed.data };
                            Object.keys(migratedData).forEach(clsId => {
                                if (!migratedData[clsId].uts) {
                                    migratedData[clsId].uts = DEFAULT_UTS;
                                }
                                migratedData[clsId].tasks = migratedData[clsId].tasks.map(t => ({
                                    ...t,
                                    utId: t.utId || 'default'
                                }));
                            });
                            setAllData(migratedData);
                            setActiveClassId(parsed.currentId || 'default');
                        }
                    } catch (e) { console.error("Error loading data", e); }
                } else {
                    const initialClassId = 'c1';
                    const initialData = {
                        [initialClassId]: {
                            students: [{ id: 's1', name: 'Alumne Exemple' }],
                            tasks: [{ id: 't1', title: 'Tasca Inicial', date: new Date().toISOString(), utId: 'ut1' }],
                            records: {},
                            penalties: {},
                            uts: DEFAULT_UTS
                        }
                    };
                    setClasses([{ id: initialClassId, name: '1r A' }]);
                    setAllData(initialData);
                    setActiveClassId(initialClassId);
                    setActiveUtId('ut1');
                }
            }, []);

            useEffect(() => {
                const dataToSave = { version: 5, classes, currentId: activeClassId, data: allData };
                localStorage.setItem('seguidor_tasques_data', JSON.stringify(dataToSave));
            }, [classes, activeClassId, allData]);

            // --- Helpers ---
            
            const updateClassData = (classId, updater) => {
                setAllData(prev => ({
                    ...prev,
                    [classId]: updater(prev[classId] || { students: [], tasks: [], records: {}, penalties: {}, uts: [] })
                }));
            };

            const toggleStatus = (studentId, taskId, forcedStatus) => {
                const key = `${studentId}_${taskId}`;
                const currentStatus = records[key] || 'EMPTY';
                const nextStatus = currentStatus === forcedStatus ? 'EMPTY' : forcedStatus;

                updateClassData(activeClassId, d => {
                    const newRecords = { ...d.records };
                    const newPenalties = { ...(d.penalties || {}) };
                    const currentPenalty = newPenalties[studentId] || 0;

                    if (nextStatus === 'EMPTY') delete newRecords[key];
                    else newRecords[key] = nextStatus;

                    let nextPenalty = currentPenalty;
                    if (nextStatus === 'MISSING' && currentStatus !== 'MISSING') nextPenalty += 1;
                    else if (currentStatus === 'MISSING' && nextStatus !== 'MISSING') nextPenalty = Math.max(0, nextPenalty - 1);

                    newPenalties[studentId] = nextPenalty;

                    if (nextPenalty >= MAX_PENALTIES) {
                        setTimeout(() => setPenaltyAlert({ 
                            studentId, 
                            name: d.students.find(s=>s.id===studentId)?.name,
                            missingTasks: d.tasks.filter(t => newRecords[`${studentId}_${t.id}`] === 'MISSING')
                        }), 0);
                    }

                    return { ...d, records: newRecords, penalties: newPenalties };
                });
            };

            const resetPenalties = (studentId) => {
                updateClassData(activeClassId, d => ({ ...d, penalties: { ...d.penalties, [studentId]: 0 } }));
                setPenaltyAlert(null);
            };

            const handleHardReset = () => {
                if(confirm("Segur que vols esborrar totes les dades? Aquesta funci贸 est pensada per reinicar l'eina a principi de curs")) {
                    localStorage.removeItem('seguidor_tasques_data');
                    window.location.reload();
                }
            };

            const getStudentStats = (studentId, taskList) => {
                let totalPoints = 0;
                let maxPoints = 0;
                let completedCount = 0;
                let lateCount = 0;
                let missingCount = 0;

                taskList.forEach(task => {
                    const statusKey = records[`${studentId}_${task.id}`];
                    maxPoints += 1; 
                    if (statusKey && STATUS_TYPES[statusKey]) {
                        totalPoints += STATUS_TYPES[statusKey].value || 0;
                        if (STATUS_TYPES[statusKey].value === 1) completedCount++;
                        if (statusKey === 'LATE') lateCount++;
                        if (statusKey === 'MISSING') missingCount++;
                    }
                });

                const percentage = maxPoints === 0 ? 0 : Math.round((totalPoints / maxPoints) * 100);
                return { percentage, completedCount, lateCount, missingCount };
            };

            const globalAverage = useMemo(() => {
                if (students.length === 0) return 0;
                const totalSum = students.reduce((acc, s) => acc + getStudentStats(s.id, visibleTasks).percentage, 0);
                return Math.round(totalSum / students.length);
            }, [students, visibleTasks, records]);

            // --- Handlers ---

            const handleAddClass = () => {
                if (!newClassName.trim()) return;
                const newId = Date.now().toString();
                setClasses([...classes, { id: newId, name: newClassName }]);
                setAllData(prev => ({ 
                    ...prev, 
                    [newId]: { students: [], tasks: [], records: {}, penalties: {}, uts: DEFAULT_UTS } 
                }));
                setActiveClassId(newId);
                setNewClassName("");
                setIsAddingClass(false);
            };

            const handleAddUt = () => {
                if (!newUtName.trim()) return;
                const newUtId = 'ut_' + Date.now();
                updateClassData(activeClassId, d => ({
                    ...d,
                    uts: [...(d.uts || []), { id: newUtId, name: newUtName }]
                }));
                setActiveUtId(newUtId);
                setNewUtName("");
                setIsAddingUt(false);
            };

            const handleRenameUt = () => {
                if (!editUtName.trim()) return;
                updateClassData(activeClassId, d => ({
                    ...d,
                    uts: d.uts.map(u => u.id === activeUtId ? { ...u, name: editUtName } : u)
                }));
                setIsEditingUt(false);
            };

            const handleDeleteUt = (utIdToDelete) => {
                if(!confirm("Ests segur? Les tasques no s'esborraran, per貌 deixaran de ser visibles en aquesta pestanya (les podrs veure a General).")) return;
                updateClassData(activeClassId, d => ({
                    ...d,
                    uts: d.uts.filter(u => u.id !== utIdToDelete)
                }));
                if (activeUtId === utIdToDelete) setActiveUtId('default');
            };

            const handleAddTask = () => {
                if (!newTaskName.trim()) return;
                const taskIdBase = Date.now().toString();
                const newTask = { id: taskIdBase, title: newTaskName, date: newTaskDate, utId: activeUtId };
                updateClassData(activeClassId, d => ({ ...d, tasks: [...d.tasks, newTask] }));

                Object.entries(copyToClasses).forEach(([classId, config]) => {
                    if (config.checked) {
                        const targetClassData = allData[classId];
                        
                        // LGICA DE CPIA INTEL路LIGENT DE PESTANYES
                        // Intentem trobar una UT amb la mateixa ID que l'activa (ex: 'ut3')
                        // Si no existeix, anem a General ('default')
                        const targetUtId = targetClassData?.uts?.find(u => u.id === activeUtId)?.id || 'default';
                        
                        const classTask = { id: taskIdBase, title: newTaskName, date: config.date, utId: targetUtId };
                        updateClassData(classId, d => ({ ...d, tasks: [...d.tasks, classTask] }));
                    }
                });

                setIsAddingTask(false);
            };

            const handleRenameClass = () => { if (!editClassName.trim()) return; setClasses(classes.map(c => c.id === activeClassId ? { ...c, name: editClassName } : c)); setIsEditingClass(false); };
            const openAddTaskModal = () => { setNewTaskName(""); setNewTaskDate(new Date().toISOString().split('T')[0]); const initialCopyState = {}; classes.filter(c => c.id !== activeClassId).forEach(c => { initialCopyState[c.id] = { checked: false, date: new Date().toISOString().split('T')[0] }; }); setCopyToClasses(initialCopyState); setIsAddingTask(true); };
            const handleUpdateTaskDate = () => { if (!editingTaskDate) return; updateClassData(activeClassId, d => ({ ...d, tasks: d.tasks.map(t => t.id === editingTaskDate.id ? { ...t, date: editingTaskDate.date } : t) })); setEditingTaskDate(null); };
            const handleAddStudents = () => { const lines = newStudentList.replace(/\r\n/g, "\n").split('\n').filter(line => line.trim() !== ''); const newStudentsObj = lines.map(line => ({ id: Date.now().toString() + Math.random().toString(36).substr(2, 9), name: line.replace(/\t+/g, ' ').trim() })); updateClassData(activeClassId, d => ({ ...d, students: [...d.students, ...newStudentsObj] })); setNewStudentList(""); setIsManagingStudents(false); };
            const deleteStudent = (id) => { if(confirm("Segur que vols eliminar aquest alumne?")) { updateClassData(activeClassId, d => ({ ...d, students: d.students.filter(s => s.id !== id) })); if (selectedStudent?.id === id) setSelectedStudent(null); } };
            const deleteTask = (id) => { if(confirm("Segur que vols eliminar aquesta tasca?")) { updateClassData(activeClassId, d => ({ ...d, tasks: d.tasks.filter(t => t.id !== id) })); } };
            const markTaskForAll = (taskId, status) => { if(!confirm(`Vols marcar "${STATUS_TYPES[status].label}" per a tots els alumnes?`)) return; updateClassData(activeClassId, d => { const newRecords = { ...d.records }; d.students.forEach(s => { newRecords[`${s.id}_${taskId}`] = status; }); return { ...d, records: newRecords }; }); };
            const handleExport = () => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ version: 5, classes, currentId: activeClassId, data: allData })); const a = document.createElement('a'); a.setAttribute("href", dataStr); a.setAttribute("download", `seguidor_tasques_${new Date().toLocaleDateString()}.json`); document.body.appendChild(a); a.click(); a.remove(); };
            const handleImport = (e) => { const fr = new FileReader(); fr.readAsText(e.target.files[0], "UTF-8"); fr.onload = ev => { const parsed = JSON.parse(ev.target.result); if(confirm("Substituir totes les dades?")) { if (parsed.version >= 2) { setClasses(parsed.classes); setAllData(parsed.data); setActiveClassId(parsed.currentId); } } }; };

            const getBarColor = (p) => { if (p >= 80) return 'bg-emerald-500'; if (p >= 50) return 'bg-amber-400'; return 'bg-rose-400'; };
            const getMedal = (p) => { if (p === 100) return ''; if (p >= 90) return ''; if (p >= 75) return ''; if (p >= 50) return ''; return ''; };

            return (
                <div className="min-h-screen flex flex-col text-slate-800 bg-orange-50/30">
                    
                    {/* Header */}
                    <header className="bg-white border-b border-orange-200 sticky top-0 z-30 shadow-sm">
                        <div className="max-w-full mx-auto"> 
                            {/* Top Bar */}
                            <div className="px-4 py-2 flex flex-col md:flex-row justify-between items-center gap-4">
                                <div className="flex items-center gap-4 overflow-hidden w-full md:w-auto">
                                    <h1 className="text-xl font-bold bg-gradient-to-r from-orange-600 to-amber-600 bg-clip-text text-transparent flex items-center gap-2 shrink-0">
                                        <Award className="text-orange-600" /> Seguidor de Tasques
                                    </h1>
                                    
                                    {/* Class Tabs */}
                                    <div className="flex items-center gap-1 overflow-x-auto hide-scroll p-1 flex-1 md:flex-none">
                                        {classes.map(cls => (
                                            <div key={cls.id} className="relative group shrink-0">
                                                <button 
                                                    onClick={() => setActiveClassId(cls.id)}
                                                    className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all whitespace-nowrap flex items-center gap-2 ${activeClassId === cls.id ? 'bg-orange-100 text-orange-700 ring-2 ring-orange-400 ring-offset-1' : 'text-slate-500 hover:bg-slate-100'}`}
                                                >
                                                    {cls.name}
                                                    {activeClassId === cls.id && (
                                                        <span onClick={(e) => { e.stopPropagation(); setEditClassName(cls.name); setIsEditingClass(true); }} className="opacity-50 hover:opacity-100 cursor-pointer p-0.5 rounded hover:bg-orange-200">
                                                            <Edit2 size={10} />
                                                        </span>
                                                    )}
                                                </button>
                                            </div>
                                        ))}
                                        <button onClick={() => setIsAddingClass(true)} className="p-1.5 rounded-full text-slate-400 hover:bg-slate-100 hover:text-orange-600 transition-colors shrink-0" title="Nova Classe">
                                            <Plus size={16} />
                                        </button>
                                    </div>
                                </div>

                                <div className="flex items-center gap-3 shrink-0">
                                    <div className="hidden md:flex items-center gap-3 bg-orange-50 px-4 py-1.5 rounded-full border border-orange-100">
                                        <span className="text-xs font-bold text-slate-400 uppercase">Mitjana</span>
                                        <div className="w-16 h-2 bg-slate-200 rounded-full overflow-hidden">
                                            <div className={`h-full ${getBarColor(globalAverage)}`} style={{ width: `${globalAverage}%` }}></div>
                                        </div>
                                        <span className="text-sm font-bold text-slate-700">{globalAverage}%</span>
                                    </div>
                                    <div className="h-6 w-px bg-slate-200 mx-1"></div>
                                    <div className="flex gap-1">
                                        <button onClick={() => setIsManagingStudents(true)} className="p-2 rounded-lg text-slate-500 hover:bg-slate-100 hover:text-orange-600" title="Alumnes"><Users size={18} /></button>
                                        <div className="relative group">
                                            <button className="p-2 text-slate-500 hover:text-orange-600 rounded-lg hover:bg-slate-100"><MoreHorizontal size={18} /></button>
                                            <div className="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 hidden group-hover:block p-2 z-50">
                                                <button onClick={handleExport} className="flex items-center gap-2 w-full text-left px-3 py-2 text-sm text-slate-600 hover:bg-slate-50 rounded-lg"><Download size={14} /> Exportar JSON</button>
                                                <label className="flex items-center gap-2 w-full text-left px-3 py-2 text-sm text-slate-600 hover:bg-slate-50 rounded-lg cursor-pointer"><Upload size={14} /> Importar JSON<input type="file" accept=".json" onChange={handleImport} className="hidden" /></label>
                                            </div>
                                        </div>
                                        <button onClick={handleHardReset} className="p-2 rounded-lg text-rose-300 hover:bg-rose-50 hover:text-rose-600 ml-1" title="Esborrar tot"><Trash2 size={18} /></button>
                                    </div>
                                </div>
                            </div>

                            {/* Secondary Bar: UT Tabs - MODIFIED: General Fixed Right */}
                            <div className="px-4 pb-0 flex flex-wrap items-center justify-between gap-4 border-t border-slate-100 bg-slate-50/50">
                                <div className="flex items-center gap-1 overflow-x-auto hide-scroll pt-1 pb-0 flex-1">
                                    <span className="text-xs font-bold text-slate-400 uppercase mr-2 tracking-wider flex items-center gap-1"><Layers size={12}/> Unitats:</span>
                                    
                                    {/* Render Specific UTs First */}
                                    {uts.filter(u => u.id !== 'default').map(ut => (
                                        <div key={ut.id} className="relative group shrink-0 flex items-center border-b-2 transition-all border-transparent hover:border-slate-300">
                                            <button 
                                                onClick={() => setActiveUtId(ut.id)}
                                                className={`px-3 py-2 text-sm font-medium whitespace-nowrap flex items-center gap-2 ${activeUtId === ut.id ? 'text-orange-700 bg-orange-50/50' : 'text-slate-500 hover:text-slate-700'}`}
                                                style={{ borderBottom: activeUtId === ut.id ? '2px solid #f97316' : 'none', marginBottom: '-2px' }}
                                            >
                                                {ut.name}
                                            </button>
                                            
                                            {/* Edit/Delete Actions inside the tab strip but visible on active */}
                                            {activeUtId === ut.id && (
                                                <div className="flex items-center ml-1 pr-2 space-x-1 border-b-2 border-orange-500" style={{ marginBottom: '-2px', height: '100%' }}>
                                                    <span onClick={(e) => { e.stopPropagation(); setEditUtName(ut.name); setIsEditingUt(true); }} className="opacity-50 hover:opacity-100 cursor-pointer p-0.5 rounded hover:bg-orange-200 text-slate-500">
                                                        <Edit2 size={12} />
                                                    </span>
                                                    <span onClick={(e) => { e.stopPropagation(); handleDeleteUt(ut.id); }} className="opacity-50 hover:opacity-100 cursor-pointer p-0.5 rounded hover:bg-rose-100 text-rose-400">
                                                        <Trash2 size={12} />
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                    
                                    <button onClick={() => setIsAddingUt(true)} className="px-2 py-2 text-slate-400 hover:text-orange-600 transition-colors border-b-2 border-transparent" title="Nova UT">
                                        <Plus size={16} />
                                    </button>

                                    {/* Spacer to push General to right */}
                                    <div className="flex-1"></div>

                                    {/* Render General Fixed Right */}
                                    {uts.filter(u => u.id === 'default').map(ut => (
                                        <div key={ut.id} className="relative group shrink-0">
                                            <button 
                                                onClick={() => setActiveUtId(ut.id)}
                                                className={`px-4 py-2 text-sm font-bold border-b-2 transition-all whitespace-nowrap flex items-center gap-2 ${activeUtId === ut.id ? 'border-indigo-500 text-indigo-700 bg-indigo-50/50' : 'border-transparent text-slate-500 hover:text-indigo-600 hover:bg-indigo-50/30'}`}
                                            >
                                                {ut.name}
                                            </button>
                                        </div>
                                    ))}
                                </div>

                                <div className="py-2 border-l border-slate-200 pl-4">
                                    <button onClick={openAddTaskModal} className="flex items-center gap-2 bg-orange-600 hover:bg-orange-700 text-white px-4 py-1.5 rounded-lg text-sm font-bold transition-colors shadow-sm">
                                        <Plus size={16} /> Nova Tasca
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 overflow-hidden flex flex-col max-w-full mx-auto w-full p-4">
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 flex-1 flex flex-col overflow-hidden">
                            <div className="overflow-auto custom-scroll flex-1 relative">
                                <table className="w-full border-collapse">
                                    <thead className="bg-slate-50 sticky top-0 z-20 shadow-sm">
                                        {/* Row for UT Groups (Only in General view) */}
                                        {activeUtId === 'default' && visibleTasks.length > 0 && (
                                            <tr>
                                                <th className="sticky left-0 z-30 bg-slate-50 border-r border-slate-200"></th> {/* Spacer Student */}
                                                {groupedUtHeaders.map((header, idx) => (
                                                    <th 
                                                        key={idx} 
                                                        colSpan={header.count} 
                                                        className="p-1 text-[10px] font-bold text-indigo-400 uppercase tracking-wider border-b border-r border-slate-200 bg-indigo-50/30 text-center"
                                                    >
                                                        {uts.find(u => u.id === header.id)?.name || 'General'}
                                                    </th>
                                                ))}
                                                <th className="bg-slate-50"></th> {/* Spacer End */}
                                            </tr>
                                        )}
                                        <tr>
                                            <th className="sticky left-0 z-30 bg-slate-50 p-4 text-left min-w-[200px] border-b border-r border-slate-200 w-64">
                                                <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">Alumne</span>
                                            </th>
                                            {visibleTasks.length === 0 ? (
                                                <th className="p-4 text-center text-slate-400 text-sm italic font-normal border-b border-slate-200">
                                                    Cap tasca visible a {uts.find(u=>u.id===activeUtId)?.name}.
                                                </th>
                                            ) : (
                                                visibleTasks.map((task, idx) => (
                                                    <th key={task.id} className={`min-w-[140px] p-2 border-b border-slate-200 group relative text-center ${idx % 2 !== 0 ? 'bg-slate-50' : 'bg-white'}`}>
                                                        <div className="flex flex-col items-center justify-center">
                                                            <span className="font-semibold text-slate-700 text-sm mb-1 truncate max-w-[120px]" title={task.title}>{task.title}</span>
                                                            <button onClick={() => setEditingTaskDate({ id: task.id, date: task.date })} className="text-[10px] text-slate-500 font-mono flex items-center gap-1 hover:bg-slate-100 px-1 rounded transition-colors">
                                                                <Calendar size={10} />
                                                                {new Date(task.date).toLocaleDateString(undefined, {month:'short', day:'numeric'})}
                                                            </button>
                                                            <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 bg-white/90 backdrop-blur rounded shadow-sm border border-slate-100 p-0.5">
                                                                <button onClick={() => markTaskForAll(task.id, 'DONE')} className="p-1 text-emerald-500 hover:bg-emerald-50 rounded"><CheckCircle size={12}/></button>
                                                                <button onClick={() => deleteTask(task.id)} className="p-1 text-rose-400 hover:bg-rose-50 rounded"><Trash2 size={12}/></button>
                                                            </div>
                                                        </div>
                                                    </th>
                                                ))
                                            )}
                                            <th className="min-w-[50px] border-b border-slate-200 p-2 bg-slate-50"></th> 
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {students.map((student, idx) => {
                                            const stats = getStudentStats(student.id, visibleTasks);
                                            const penaltyCount = penalties[student.id] || 0;
                                            const rowClass = idx % 2 === 0 ? 'row-even' : 'row-odd';

                                            return (
                                                <tr key={student.id} className={`${rowClass} hover:bg-slate-50 group`}>
                                                    <td className={`sticky left-0 ${rowClass} group-hover:bg-slate-50 p-3 border-b border-r border-slate-200 transition-colors z-10`}>
                                                        <div className="flex items-center justify-between mb-2">
                                                            <button onClick={() => setSelectedStudent(student)} className="font-medium text-slate-700 hover:text-indigo-600 hover:underline text-left text-sm flex items-center gap-2">
                                                                {student.name}
                                                                {penaltyCount > 0 && <div className="flex -space-x-1">{[...Array(penaltyCount)].map((_, i) => <span key={i} className="w-2 h-2 rounded-full bg-rose-500 ring-1 ring-white"></span>)}</div>}
                                                            </button>
                                                            <div className="text-base">{getMedal(stats.percentage)}</div>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="flex-1 h-1.5 bg-slate-200 rounded-full overflow-hidden"><div className={`h-full ${getBarColor(stats.percentage)} progress-bar`} style={{ width: `${stats.percentage}%` }}></div></div>
                                                            <span className="text-[10px] font-bold text-slate-400 w-6 text-right">{stats.percentage}%</span>
                                                        </div>
                                                    </td>
                                                    {visibleTasks.map((task, tIdx) => {
                                                        const statusKey = records[`${student.id}_${task.id}`] || 'EMPTY';
                                                        const colClass = tIdx % 2 !== 0 ? 'col-highlight' : '';
                                                        return (
                                                            <td key={task.id} className={`p-2 border-b border-slate-100 text-center align-middle ${colClass}`}>
                                                                <div className="flex items-center justify-center gap-1.5">
                                                                    <button onClick={() => toggleStatus(student.id, task.id, 'DONE')} className={`w-8 h-8 rounded-full flex items-center justify-center transition-all ${statusKey === 'DONE' ? 'bg-emerald-100 text-emerald-600 ring-2 ring-emerald-500 ring-offset-1 scale-110' : 'bg-white border border-slate-200 text-slate-300 hover:border-emerald-300 hover:text-emerald-400 shadow-sm'}`}><CheckCircle size={16} /></button>
                                                                    <button onClick={() => toggleStatus(student.id, task.id, 'LATE')} className={`w-8 h-8 rounded-full flex items-center justify-center transition-all ${statusKey === 'LATE' ? 'bg-amber-100 text-amber-600 ring-2 ring-amber-500 ring-offset-1 scale-110' : 'bg-white border border-slate-200 text-slate-300 hover:border-amber-300 hover:text-amber-400 shadow-sm'}`}><Clock size={16} /></button>
                                                                    <button onClick={() => toggleStatus(student.id, task.id, 'MISSING')} className={`w-8 h-8 rounded-full flex items-center justify-center transition-all ${statusKey === 'MISSING' ? 'bg-rose-100 text-rose-600 ring-2 ring-rose-500 ring-offset-1 scale-110' : 'bg-white border border-slate-200 text-slate-300 hover:border-rose-300 hover:text-rose-400 shadow-sm'}`}><XCircle size={16} /></button>
                                                                </div>
                                                            </td>
                                                        );
                                                    })}
                                                    {visibleTasks.length === 0 && <td className="border-b border-slate-200"></td>}
                                                    <td className="border-b border-slate-100 bg-white"></td>
                                                </tr>
                                            );
                                        })}
                                        {students.length === 0 && (
                                            <tr><td colSpan={visibleTasks.length + 2} className="p-12 text-center text-slate-400"><div className="flex flex-col items-center gap-4"><div className="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center text-orange-300"><Users size={32} /></div><p>Classe buida.</p><button onClick={() => setIsManagingStudents(true)} className="text-orange-600 font-medium hover:underline">Gestionar Alumnes</button></div></td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>

                    {/* Modals */}
                    {penaltyAlert && <Modal title=" Atenci贸: Acumulaci贸 de No Fets" onClose={() => {}} variant="danger"><div className="text-center"><div className="w-16 h-16 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce"><AlertTriangle size={32} /></div><h4 className="text-lg font-bold text-slate-800 mb-2">{penaltyAlert.name} ha acumulat 3 negatius!</h4><p className="text-slate-600 text-sm mb-4">Nota a l'agenda necessria. Tasques pendents:</p><ul className="bg-white border border-rose-200 rounded-lg p-4 text-left mb-6 space-y-2">{penaltyAlert.missingTasks.map(t => <li key={t.id} className="flex items-center gap-2 text-rose-700 font-medium text-sm"><XCircle size={14} /> {t.title} ({new Date(t.date).toLocaleDateString()})</li>)}</ul><button onClick={() => resetPenalties(penaltyAlert.studentId)} className="w-full bg-rose-600 text-white py-3 rounded-xl font-bold hover:bg-rose-700 shadow-lg shadow-rose-200 transition-all">Entesos (Reiniciar punts)</button></div></Modal>}
                    {isEditingClass && <Modal title="Canviar nom de la classe" onClose={() => setIsEditingClass(false)}><div className="space-y-4"><input autoFocus type="text" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" value={editClassName} onChange={e => setEditClassName(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleRenameClass()} /><button onClick={handleRenameClass} className="w-full bg-orange-600 text-white py-3 rounded-lg font-bold hover:bg-orange-700">Guardar canvis</button></div></Modal>}
                    {isEditingUt && <Modal title="Canviar nom de la Unitat" onClose={() => setIsEditingUt(false)}><div className="space-y-4"><input autoFocus type="text" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" value={editUtName} onChange={e => setEditUtName(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleRenameUt()} /><button onClick={handleRenameUt} className="w-full bg-orange-600 text-white py-3 rounded-lg font-bold hover:bg-orange-700">Guardar canvis</button></div></Modal>}
                    {editingTaskDate && <Modal title="Canviar data d'entrega" onClose={() => setEditingTaskDate(null)}><div className="space-y-4"><p className="text-sm text-slate-500">La tasca es reordenar automticament.</p><input type="date" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" value={editingTaskDate.date} onChange={e => setEditingTaskDate({...editingTaskDate, date: e.target.value})} /><button onClick={handleUpdateTaskDate} className="w-full bg-orange-600 text-white py-3 rounded-lg font-bold hover:bg-orange-700">Actualitzar</button></div></Modal>}
                    {isAddingClass && <Modal title="Nova Classe" onClose={() => setIsAddingClass(false)}><div className="space-y-4"><input autoFocus type="text" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Nom de la classe (ex: 3r ESO B)" value={newClassName} onChange={e => setNewClassName(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAddClass()} /><button onClick={handleAddClass} className="w-full bg-orange-600 text-white py-3 rounded-lg font-bold hover:bg-orange-700">Crear Classe</button></div></Modal>}
                    {isAddingUt && <Modal title="Nova Unitat Temporal" onClose={() => setIsAddingUt(false)}><div className="space-y-4"><input autoFocus type="text" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Nom (ex: 2n Trimestre...)" value={newUtName} onChange={e => setNewUtName(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAddUt()} /><button onClick={handleAddUt} className="w-full bg-orange-600 text-white py-3 rounded-lg font-bold hover:bg-orange-700">Crear Unitat</button></div></Modal>}
                    {isAddingTask && <Modal title="Nova Tasca" onClose={() => setIsAddingTask(false)}><div className="space-y-4"><div><label className="block text-sm font-medium text-slate-700 mb-1">Nom de la tasca</label><input autoFocus type="text" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Ex: Exercicis Tema 1..." value={newTaskName} onChange={e => setNewTaskName(e.target.value)} /></div><div className="bg-orange-50 p-4 rounded-xl border border-orange-100 flex gap-4"><div className="flex-1"><label className="block text-xs font-bold text-orange-800 mb-1 uppercase">Classe</label><div className="text-sm font-medium">{classes.find(c=>c.id===activeClassId)?.name}</div></div><div className="flex-1"><label className="block text-xs font-bold text-orange-800 mb-1 uppercase">Unitat</label><div className="text-sm font-medium">{uts.find(u=>u.id===activeUtId)?.name}</div></div></div><div><label className="block text-sm font-medium text-slate-700 mb-1">Data</label><input type="date" className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" value={newTaskDate} onChange={e => setNewTaskDate(e.target.value)} /></div>{classes.length > 1 && <div className="border-t border-slate-100 pt-4"><label className="block text-sm font-bold text-slate-500 mb-2 uppercase tracking-wider">Copiar tamb茅 a:</label><div className="space-y-3 max-h-40 overflow-y-auto custom-scroll pr-2">{classes.filter(c => c.id !== activeClassId).map(cls => <div key={cls.id} className={`flex items-center justify-between p-2 rounded-lg border transition-colors ${copyToClasses[cls.id]?.checked ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200'}`}><label className="flex items-center gap-2 cursor-pointer select-none"><input type="checkbox" className="w-4 h-4 text-orange-600 rounded focus:ring-orange-500" checked={copyToClasses[cls.id]?.checked || false} onChange={e => setCopyToClasses({ ...copyToClasses, [cls.id]: { ...copyToClasses[cls.id], checked: e.target.checked, date: e.target.checked ? newTaskDate : (copyToClasses[cls.id]?.date || newTaskDate) } })} /><span className="text-sm font-medium text-slate-700">{cls.name}</span></label>{copyToClasses[cls.id]?.checked && <input type="date" className="text-xs p-1.5 border border-slate-300 rounded focus:border-indigo-500 outline-none w-32" value={copyToClasses[cls.id]?.date} onChange={e => setCopyToClasses({ ...copyToClasses, [cls.id]: { ...copyToClasses[cls.id], date: e.target.value } })} />}</div>)}</div></div>}<button onClick={handleAddTask} className="w-full bg-orange-600 text-white py-3 rounded-lg font-bold hover:bg-orange-700">Crear Tasca</button></div></Modal>}
                    {isManagingStudents && <Modal title="Gestionar Alumnes" onClose={() => setIsManagingStudents(false)}><div className="space-y-4"><div><label className="block text-sm font-medium text-slate-700 mb-1">Enganxa llista de noms</label><textarea className="w-full p-3 border border-slate-300 rounded-lg h-32 focus:ring-2 focus:ring-orange-500 outline-none text-sm font-mono whitespace-pre" placeholder="Joan P茅rez&#10;Maria Garcia&#10;..." value={newStudentList} onChange={e => setNewStudentList(e.target.value)}></textarea><button onClick={handleAddStudents} className="mt-2 w-full bg-orange-100 text-orange-700 py-2 rounded-lg font-medium hover:bg-orange-200 transition-colors">Afegir a la classe</button></div><div className="border-t border-slate-100 pt-4"><h4 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">Alumnes ({students.length})</h4><div className="max-h-48 overflow-y-auto custom-scroll space-y-1">{students.map(s => <div key={s.id} className="flex justify-between items-center p-2 hover:bg-slate-50 rounded"><span className="text-sm text-slate-700">{s.name}</span><button onClick={() => deleteStudent(s.id)} className="text-rose-400 hover:text-rose-600"><Trash2 size={14}/></button></div>)}</div></div></div></Modal>}
                    {selectedStudent && <Modal title={`Fitxa: ${selectedStudent.name}`} onClose={() => setSelectedStudent(null)}>{(() => { const stats = getStudentStats(selectedStudent.id, allClassTasks); const currentPenalties = penalties[selectedStudent.id] || 0; return (<div className="space-y-6"><div className="grid grid-cols-2 gap-4"><div className="bg-slate-50 p-4 rounded-xl border border-slate-100 text-center"><div className="text-3xl font-bold text-orange-600 mb-1">{stats.percentage}%</div><div className="text-xs text-slate-400 uppercase font-bold">Nota Global</div></div><div className="bg-slate-50 p-4 rounded-xl border border-slate-100 text-center"><div className="text-3xl mb-1">{getMedal(stats.percentage) || ''}</div><div className="text-xs text-slate-400 uppercase font-bold">Nivell</div></div></div><div className="bg-rose-50 border border-rose-100 p-4 rounded-xl flex items-center justify-between"><div><h5 className="text-sm font-bold text-rose-800">Punts Negatius</h5><p className="text-xs text-rose-600">Alarma als 3 punts</p></div><div className="flex gap-1">{[...Array(3)].map((_, i) => <div key={i} className={`w-4 h-4 rounded-full border border-rose-300 ${i < currentPenalties ? 'bg-rose-500' : 'bg-white'}`}></div>)}</div></div><div className="text-center pt-2"><button onClick={() => deleteStudent(selectedStudent.id)} className="text-rose-400 text-sm hover:text-rose-600 hover:underline">Eliminar alumne</button></div></div>); })()}</Modal>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
