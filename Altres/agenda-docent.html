<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador Docent CFN - Andorra</title>
    
    <!-- Estils CSS (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tipografies -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* Fons base (es sobreescriur√† per JS segons el tema) */
        body { font-family: 'Inter', sans-serif; background-color: #fff7ed; color: #374151; transition: background-color 0.3s ease; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Scrollbar Base */
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f9fafb; }
        /* Els colors del thumb es defineixen din√†micament al JS */
        .custom-scroll::-webkit-scrollbar-thumb { border-radius: 4px; }
        
        /* Animacions */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        
        @keyframes expandOpen { from { height: 0; opacity: 0; transform: scaleY(0.9); } to { height: auto; opacity: 1; transform: scaleY(1); } }
        .expand-open { animation: expandOpen 0.15s ease-out forwards; transform-origin: top; }

        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .slide-in-right { animation: slideInRight 0.3s ease-out forwards; }

        /* Estils especials de Text */
        .time-red { color: #dc2626; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        
        /* Estils IMPORTANTS per inputs */
        input.task-skipped { 
            text-decoration: line-through !important; 
            color: #dc2626 !important; 
            opacity: 0.8 !important;
            font-style: italic;
        }
        
        input.task-unfinished { 
            text-decoration: underline !important; 
            text-decoration-color: #d97706 !important; /* Canvi a Groc/Ambre */
            text-decoration-thickness: 2px !important;
            color: #d97706 !important; /* Canvi a Groc/Ambre */
            font-weight: 600 !important;
        }
        
        /* Estil sessi√≥ cancel¬∑lada */
        .session-cancelled {
            background-color: #d1d5db !important; /* gray-300 */
            color: #6b7280 !important; /* gray-500 */
        }
        
        .session-cancelled input.task-input {
             pointer-events: none;
        }
        
        .session-cancelled .reactivate-btn, .session-cancelled textarea {
            pointer-events: auto !important;
        }

        /* Loading Overlay */
        #app-loader {
            position: fixed; inset: 0; z-index: 9999;
            background: white; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .loader-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #f97316; /* Color per defecte, canvia per JS */
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; mb-4;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .error-box {
            background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c;
            padding: 20px; rounded: 8px; max-width: 500px; text-align: center;
            display: none;
        }
    </style>
</head>
<body>

    <!-- PANTALLA DE C√ÄRREGA -->
    <div id="app-loader">
        <div id="loader-content">
            <div class="loader-spinner" style="margin-bottom: 20px;"></div>
            <h2 class="text-xl font-bold text-gray-700">Carregant Planificador...</h2>
        </div>
        <div id="error-content" class="error-box">
            <h3 class="font-bold text-lg mb-2">Error de c√†rrega</h3>
            <p id="error-message">No s'ha pogut iniciar l'aplicaci√≥.</p>
        </div>
    </div>

    <div id="root"></div>

    <!-- LLIBRERIES -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        setTimeout(function() {
            var loader = document.getElementById('app-loader');
            if (loader && loader.style.display !== 'none' && !document.getElementById('root').hasChildNodes()) {
                document.getElementById('loader-content').innerHTML = '<h3 class="text-red-600 font-bold">Error de c√†rrega. Revisa la connexi√≥.</h3>';
            }
        }, 8000);
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONES ---
        const Icon = ({ children, size = 18, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            Settings: () => <Icon><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>,
            Check: () => <Icon><polyline points="20 6 9 17 4 12"/></Icon>,
            CheckCircle: () => <Icon><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>,
            Calendar: () => <Icon><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></Icon>,
            Save: () => <Icon><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>,
            Clock: () => <Icon size={12}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>,
            Moon: () => <Icon><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></Icon>,
            AlertCircle: () => <Icon><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>,
            ChevronLeft: () => <Icon><polyline points="15 18 9 12 15 6"/></Icon>,
            ChevronRight: () => <Icon><polyline points="9 18 15 12 9 6"/></Icon>,
            ChevronUp: () => <Icon><polyline points="18 15 12 9 6 15"/></Icon>,
            ChevronDown: () => <Icon><polyline points="6 9 12 15 18 9"/></Icon>,
            FileJson: () => <Icon><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>,
            Table: () => <Icon><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/></Icon>,
            AlertTriangle: () => <Icon><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>,
            ArrowRight: () => <Icon><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></Icon>,
            Trash: () => <Icon><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></Icon>,
            Plus: () => <Icon><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>,
            Copy: () => <Icon><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></Icon>,
            XCircle: () => <Icon><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></Icon>,
            MoreHorizontal: () => <Icon><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></Icon>,
            AlertOctagon: () => <Icon><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>,
            FileText: () => <Icon><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>,
            Link: () => <Icon><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></Icon>,
            Edit: () => <Icon><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>,
            Undo: () => <Icon><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 7"/></Icon>,
            Redo: () => <Icon><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 7"/></Icon>,
            Lightbulb: () => <Icon><path d="M9 18h6"/><path d="M10 22h4"/><path d="M12 2v1"/><path d="M12 14v-2"/><path d="M2 12h1"/><path d="M21 12h1"/><path d="M4.22 19.78l.71-.71"/><path d="M19.07 4.93l.71.71"/><path d="M4.22 4.22l.71.71"/><path d="M19.07 19.07l.71.71"/><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2v-2.26C6.19 13.47 5 10.38 5 9a7 7 0 0 1 7-7z"/></Icon>,
            Paste: () => <Icon><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></Icon>,
            Menu: () => <Icon><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></Icon>
        };

        // --- CONSTANTS & THEMES ---
        const APP_THEMES = {
            orange: { name: "Taronja", bg: "#fff7ed", primary: "orange", thumb: "#fdba74", hover: "#f97316" },
            blue: { name: "Blau", bg: "#eff6ff", primary: "blue", thumb: "#93c5fd", hover: "#2563eb" },
            green: { name: "Verd", bg: "#f0fdf4", primary: "green", thumb: "#86efac", hover: "#16a34a" },
            purple: { name: "Lila", bg: "#faf5ff", primary: "purple", thumb: "#d8b4fe", hover: "#9333ea" },
            slate: { name: "Gris", bg: "#f8fafc", primary: "slate", thumb: "#cbd5e1", hover: "#475569" }
        };

        const TIME_SLOTS = [
            { id: 0, label: "8:30h - 9:30h", type: "class", endH: 9, endM: 30 },
            { id: 1, label: "9:30h - 10:30h", type: "class", endH: 10, endM: 30 },
            { id: 2, label: "10:30h - 11:00h", type: "break", name: "PATI", endH: 11, endM: 0 },
            { id: 3, label: "11:00h - 12:00h", type: "class", endH: 12, endM: 0 },
            { id: 4, label: "12:00h - 13:00h", type: "class", endH: 13, endM: 0 },
            { id: 5, label: "13:00h - 14:00h", type: "class", endH: 14, endM: 0 },
            { id: 6, label: "14:00h - 15:00h", type: "class", endH: 15, endM: 0 },
            { id: 7, label: "15:00h - 16:00h", type: "class", endH: 16, endM: 0 },
            { id: 8, label: "16:00h - 17:00h", type: "class", endH: 17, endM: 0 },
            { id: 9, label: "17:00h - 18:00h", type: "class", endH: 18, endM: 0 },
            { id: 10, label: "18:00h - 19:00h", type: "class", endH: 19, endM: 0 }
        ];

        const WORK_DAYS = ["Dilluns", "Dimarts", "Dimecres", "Dijous", "Divendres"];
        const WEEKEND_DAYS = ["Dissabte", "Diumenge"];
        const MONTHS = ["Gener", "Febrer", "Mar√ß", "Abril", "Maig", "Juny", "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre"];
        
        const DEFAULT_COLORS = [
            { name: "Blau Clar", value: "bg-sky-100 border-sky-300 text-sky-900", hex: "#e0f2fe" },
            { name: "Blau Fosc", value: "bg-indigo-200 border-indigo-400 text-indigo-900", hex: "#c7d2fe" },
            { name: "Verd Clar", value: "bg-lime-100 border-lime-300 text-lime-900", hex: "#ecfccb" },
            { name: "Verd Fosc", value: "bg-emerald-200 border-emerald-400 text-emerald-900", hex: "#a7f3d0" },
            { name: "Vermell", value: "bg-red-200 border-red-400 text-red-900", hex: "#fecaca" },
            { name: "Corall", value: "bg-rose-100 border-rose-300 text-rose-900", hex: "#ffe4e6" },
            { name: "Groc", value: "bg-yellow-200 border-yellow-400 text-yellow-900", hex: "#fef08a" },
            { name: "Taronja", value: "bg-orange-200 border-orange-400 text-orange-900", hex: "#fed7aa" },
            { name: "Lila", value: "bg-purple-200 border-purple-400 text-purple-900", hex: "#e9d5ff" },
            { name: "Gris", value: "bg-gray-200 border-gray-400 text-gray-900", hex: "#e5e7eb" },
        ];

        // Component Personalitzat Select Color
        const ColorSelect = ({ value, onChange }) => {
            const [open, setOpen] = useState(false);
            const selected = DEFAULT_COLORS.find(c => c.value === value) || DEFAULT_COLORS[0];
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(e.target)) setOpen(false);
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            return (
                <div className="relative" ref={dropdownRef}>
                    <div onClick={() => setOpen(!open)} className="border p-2 rounded-md w-full flex items-center justify-between cursor-pointer bg-white">
                        <div className="flex items-center gap-2">
                            <div className="w-4 h-4 rounded-full border border-black/10 shadow-inner" style={{ backgroundColor: selected.hex }}></div>
                            <span className="text-sm">{selected.name}</span>
                        </div>
                        <Icons.ChevronDown size={14} className="text-gray-500" />
                    </div>
                    {open && (
                        <div className="absolute top-full left-0 mt-1 w-full bg-white border rounded shadow-lg z-50 max-h-48 overflow-y-auto">
                            {DEFAULT_COLORS.map(c => (
                                <div key={c.name} onClick={() => {onChange(c.value); setOpen(false)}} className="p-2 hover:bg-gray-100 flex items-center gap-2 cursor-pointer">
                                     <div className="w-4 h-4 rounded-full border border-black/10 shadow-inner" style={{ backgroundColor: c.hex }}></div>
                                     <span className="text-sm">{c.name}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            )
        };

        // FUNCI√ì DE FORMATATGE LOCAL SEGURA (Evita el bug UTC vs Hora Local)
        const getLocalISODate = (d) => {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const generateAllWeeks = (yearStr) => {
            const weeks = [];
            const year = parseInt(yearStr) || new Date().getFullYear();
            let current = new Date(year, 8, 1, 12, 0, 0); 
            const day = current.getDay();
            const diff = current.getDate() - day + (day == 0 ? -6 : 1);
            current.setDate(diff);
            const end = new Date(year + 1, 6, 15, 12, 0, 0);
            while (current < end) {
                const weekStart = new Date(current);
                const weekEnd = new Date(current);
                weekEnd.setDate(weekEnd.getDate() + 6); // Diumenge
                weeks.push({
                    id: getLocalISODate(weekStart),
                    label: `Setmana ${weekStart.getDate()} ${MONTHS[weekStart.getMonth()]}`,
                    startDate: new Date(weekStart),
                    endDate: new Date(weekEnd),
                    month: weekStart.getMonth(),
                    year: weekStart.getFullYear()
                });
                current.setDate(current.getDate() + 7);
            }
            return weeks;
        };

        const addDays = (dateStr, days) => {
            const [y, m, d] = dateStr.split('-');
            const result = new Date(y, m - 1, d, 12, 0, 0); 
            result.setDate(result.getDate() + days);
            return getLocalISODate(result);
        };

        // --- COMPONENTS ---

        const ConfigScreen = ({ config, onSave }) => {
            const [localConfig, setLocalConfig] = useState(config);
            const [newClass, setNewClass] = useState({ name: "", color: DEFAULT_COLORS[0].value });
            const [newUT, setNewUT] = useState({ name: "", date: "" });
            
            const theme = localConfig.theme || 'orange';

            const addClass = () => {
                if (!newClass.name) return;
                setLocalConfig(prev => ({
                    ...prev,
                    classes: [...prev.classes, { ...newClass, id: Date.now().toString() }]
                }));
                setNewClass(prev => ({ ...prev, name: "" }));
            };

            const removeClass = (id) => {
                setLocalConfig(prev => ({ ...prev, classes: prev.classes.filter(c => c.id !== id) }));
            };

            const updateSchedule = (dayIndex, slotId, classId) => {
                setLocalConfig(prev => {
                    const newSchedule = { ...prev.schedule };
                    if (!newSchedule[dayIndex]) newSchedule[dayIndex] = {};
                    newSchedule[dayIndex][slotId] = classId;
                    return { ...prev, schedule: newSchedule };
                });
            };

            const toggleDuration = (dayIndex, slotId) => {
                setLocalConfig(prev => {
                    const key = `${dayIndex}-${slotId}`;
                    const currentDurations = prev.durations || {};
                    const is2h = currentDurations[key] === 2;
                    const newDurations = { ...currentDurations };
                    if (is2h) { delete newDurations[key]; } else { newDurations[key] = 2; }
                    return { ...prev, durations: newDurations };
                });
            };

            // Funci√≥ per les UTs
            const addUT = () => {
                if (!newUT.name || !newUT.date) return;
                setLocalConfig(prev => ({
                    ...prev,
                    utDates: [...(prev.utDates || []), { ...newUT, id: Date.now().toString() }].sort((a,b) => new Date(a.date) - new Date(b.date))
                }));
                setNewUT({ name: "", date: "" });
            };

            const removeUT = (id) => {
                setLocalConfig(prev => ({ ...prev, utDates: (prev.utDates || []).filter(ut => ut.id !== id) }));
            };

            return (
                <div className="max-w-6xl mx-auto p-6 bg-white rounded-xl shadow-lg mt-10 fade-in border border-gray-200 mb-20">
                    <h1 className={`text-3xl font-bold text-gray-800 mb-6 flex items-center gap-2 border-b pb-4`}>
                        <Icons.Settings /> Configuraci√≥ Inicial
                    </h1>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Nom del Professor/a</label>
                            <input type="text" className={`w-full rounded-md border p-2 bg-gray-50 focus:ring-${theme}-500 focus:outline-none`} value={localConfig.teacherName} onChange={(e) => setLocalConfig({...localConfig, teacherName: e.target.value})} placeholder="Ex: Marc P√©rez" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Any d'inici (Ex: 2025)</label>
                            <input type="number" className={`w-full rounded-md border p-2 bg-gray-50 focus:ring-${theme}-500 focus:outline-none`} value={localConfig.schoolYear} onChange={(e) => setLocalConfig({...localConfig, schoolYear: e.target.value})} placeholder="2025" />
                        </div>
                    </div>

                    <div className="mb-8 p-6 bg-gray-50 rounded-xl border border-gray-200">
                        <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-gray-800">Tema de l'aplicaci√≥</h2>
                        <div className="flex flex-wrap gap-4">
                            {Object.entries(APP_THEMES).map(([key, t]) => (
                                <button 
                                    key={key} 
                                    onClick={() => setLocalConfig({...localConfig, theme: key})}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg border-2 transition-all ${localConfig.theme === key ? `border-${t.primary}-500 bg-${t.primary}-50 text-${t.primary}-700 font-bold` : 'border-gray-200 hover:border-gray-300'}`}
                                >
                                    <div className={`w-4 h-4 rounded-full bg-${t.primary}-500`}></div>
                                    {t.name}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* DATES FINAL UT */}
                    <div className="mb-8 p-6 bg-gray-50 rounded-xl border border-gray-200">
                        <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-gray-800"><Icons.Calendar /> Dates de final d'UT</h2>
                        <div className="flex flex-wrap gap-2 mb-6">
                            {(!localConfig.utDates || localConfig.utDates.length === 0) && <span className="text-gray-400 italic">No has afegit cap data.</span>}
                            {(localConfig.utDates || []).map(ut => (
                                <span key={ut.id} className="px-3 py-1 rounded-full text-sm font-medium flex items-center gap-2 shadow-sm bg-blue-100 text-blue-800 border border-blue-200">
                                    {ut.name}: {new Date(ut.date).toLocaleDateString()}
                                    <button onClick={() => removeUT(ut.id)} className="hover:bg-blue-200 rounded-full w-5 h-5 flex justify-center items-center text-blue-600 font-bold">√ó</button>
                                </span>
                            ))}
                        </div>
                        <div className="flex flex-col md:flex-row gap-4 items-end bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <div className="flex-1 w-full">
                                <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Nom de la UT</label>
                                <input type="text" className="border p-2 rounded-md w-full" value={newUT.name} onChange={(e) => setNewUT({...newUT, name: e.target.value})} placeholder="Ex: UT1" />
                            </div>
                            <div className="w-full md:w-48">
                                <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Data de finalitzaci√≥</label>
                                <input type="date" className="border p-2 rounded-md w-full" value={newUT.date} onChange={(e) => setNewUT({...newUT, date: e.target.value})} />
                            </div>
                            <button onClick={addUT} className={`bg-${theme}-600 text-white px-6 py-2 rounded-md hover:bg-${theme}-700 font-medium transition-colors`}>Afegir</button>
                        </div>
                    </div>

                    <div className="mb-8 p-6 bg-gray-50 rounded-xl border border-gray-200">
                        <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-gray-800"><Icons.Table /> Les meves classes</h2>
                        <div className="flex flex-wrap gap-2 mb-6">
                            {localConfig.classes.length === 0 && <span className="text-gray-400 italic">No has creat cap grup encara.</span>}
                            {localConfig.classes.map(c => (
                                <span key={c.id} className={`px-3 py-1 rounded-full text-sm font-medium flex items-center gap-2 shadow-sm ${c.color}`}>
                                    {c.name} <button onClick={() => removeClass(c.id)} className="hover:bg-black/10 rounded-full w-5 h-5 flex justify-center items-center">√ó</button>
                                </span>
                            ))}
                        </div>
                        <div className="flex flex-col md:flex-row gap-4 items-end bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <div className="flex-1 w-full">
                                <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Nom del Grup</label>
                                <input type="text" className="border p-2 rounded-md w-full" value={newClass.name} onChange={(e) => setNewClass({...newClass, name: e.target.value})} placeholder="Ex: 2n B" onKeyDown={(e) => e.key === 'Enter' && addClass()} />
                            </div>
                            <div className="w-full md:w-48">
                                <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Color</label>
                                <ColorSelect value={newClass.color} onChange={(val) => setNewClass({...newClass, color: val})} />
                            </div>
                            <button onClick={addClass} className={`bg-${theme}-600 text-white px-6 py-2 rounded-md hover:bg-${theme}-700 font-medium transition-colors`}>Afegir</button>
                        </div>
                    </div>
                    <div className="overflow-x-auto rounded-lg border border-gray-200 shadow-sm mb-6">
                        <table className="min-w-full bg-white">
                            <thead>
                                <tr className="bg-gray-100 text-gray-700 text-xs uppercase"><th className="py-3 px-4 text-left w-32 border-b">Hora</th>{WORK_DAYS.map((day, i) => <th key={i} className="py-3 px-4 text-center border-b">{day}</th>)}</tr>
                            </thead>
                            <tbody className="text-gray-600 text-sm">
                                {TIME_SLOTS.map((slot, index) => (
                                    <tr key={slot.id} className="border-b hover:bg-gray-50">
                                        <td className="py-2 px-4 border-r font-mono text-xs font-bold text-gray-500">{slot.label}</td>
                                        {slot.type === 'break' ? (
                                            <td colSpan={5} className="py-3 bg-gray-100 text-center text-gray-400 font-bold tracking-widest text-xs">‚òï {slot.name}</td>
                                        ) : (
                                            WORK_DAYS.map((_, dayIndex) => {
                                                const prevSlot = TIME_SLOTS[index - 1];
                                                const prevKey = prevSlot ? `${dayIndex}-${prevSlot.id}` : null;
                                                const isCovered = prevSlot && localConfig.durations?.[prevKey] === 2;

                                                if (isCovered) return null; // No renderitzar si est√† coberta per la de sobre

                                                const currentClassId = localConfig.schedule[dayIndex]?.[slot.id];
                                                const currentClass = localConfig.classes.find(c => c.id === currentClassId);
                                                
                                                const currentKey = `${dayIndex}-${slot.id}`;
                                                const is2h = localConfig.durations?.[currentKey] === 2;
                                                const nextSlot = TIME_SLOTS[index + 1];
                                                const canExtend = nextSlot && nextSlot.type === 'class';

                                                return (
                                                    <td key={dayIndex} rowSpan={is2h ? 2 : 1} className={`p-1 border-r border-gray-100 relative ${currentClass ? currentClass.color.split(' ')[0] : ''}`}>
                                                        <div className="flex items-center gap-1">
                                                            <select className="w-full p-2 bg-transparent border-none text-center cursor-pointer appearance-none font-medium" value={currentClassId || ""} onChange={(e) => updateSchedule(dayIndex, slot.id, e.target.value)}>
                                                                <option value="">-</option>
                                                                {localConfig.classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                                            </select>
                                                            {canExtend && (
                                                                <button 
                                                                    onClick={() => toggleDuration(dayIndex, slot.id)}
                                                                    className={`text-[10px] px-1 rounded hover:bg-black/10 ${is2h ? 'text-blue-600 font-bold bg-blue-100' : 'text-gray-400'}`}
                                                                    title={is2h ? "Reduir a 1h" : "Ampliar a 2h"}
                                                                >
                                                                    ‚Üì
                                                                </button>
                                                            )}
                                                        </div>
                                                    </td>
                                                );
                                            })
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="flex justify-end"><button onClick={() => onSave(localConfig)} className="bg-green-600 text-white px-8 py-3 rounded-lg text-lg font-bold hover:bg-green-700 flex items-center gap-2 transition-all"><Icons.Check /> Guardar Configuraci√≥</button></div>
                </div>
            );
        };

        const DashboardScreen = ({ config, radar, setRadar, completedWeeks, onToggleWeekComplete, onSelectWeek, onSelectClassView, onExport, onImport, goToConfig, onReset, onSaveConfig, holidayWeeks, onToggleHoliday, reminders }) => {
            const [currentViewDate, setCurrentViewDate] = useState(new Date());
            const [showResetModal, setShowResetModal] = useState(false);
            const [showInfoModal, setShowInfoModal] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [editingLink, setEditingLink] = useState(false);
            const [tempLink, setTempLink] = useState(config.googleSheetUrl || "");
            const [editingTaskLink, setEditingTaskLink] = useState(false);
            const [tempTaskLink, setTempTaskLink] = useState(config.taskTrackingUrl || "");
            const fileInputRef = useRef(null);
            
            const [newRadarText, setNewRadarText] = useState("");
            const [newRadarDate, setNewRadarDate] = useState("");

            const theme = config.theme || 'orange';

            const allWeeks = useMemo(() => generateAllWeeks(config.schoolYear), [config.schoolYear]);
            const currentMonthWeeks = allWeeks.filter(w => w.month === currentViewDate.getMonth() && w.year === currentViewDate.getFullYear());

            const calculateProgress = () => {
                if (allWeeks.length === 0) return 0;
                return ((completedWeeks.length / allWeeks.length) * 100).toFixed(1);
            };

            const changeMonth = (delta) => {
                const newDate = new Date(currentViewDate);
                newDate.setMonth(newDate.getMonth() + delta);
                setCurrentViewDate(newDate);
            };

            const isCurrentWeek = (w) => {
                const now = new Date();
                const start = new Date(w.startDate);
                start.setHours(0, 0, 0, 0);
                const end = new Date(w.startDate);
                end.setDate(end.getDate() + 6); 
                end.setHours(23, 59, 59, 999);
                return now >= start && now <= end;
            };

            const handleImportClick = () => setShowImportModal(true);
            const confirmImport = () => { setShowImportModal(false); if(fileInputRef.current) fileInputRef.current.click(); };

            const handleSaveLink = () => {
                onSaveConfig({ ...config, googleSheetUrl: tempLink });
                setEditingLink(false);
            };

            const handleSaveTaskLink = () => {
                onSaveConfig({ ...config, taskTrackingUrl: tempTaskLink });
                setEditingTaskLink(false);
            };

            const getUTForWeek = (week) => {
                if (!config.utDates || config.utDates.length === 0) return null;
                return config.utDates.find(ut => {
                    const [y, m, d] = ut.date.split('-');
                    const utDate = new Date(y, m - 1, d, 12, 0, 0); 
                    return utDate >= week.startDate && utDate <= week.endDate;
                });
            };

            const handleAddRadar = () => {
                if (!newRadarText.trim()) return;
                const newEntry = {
                    id: Date.now(),
                    text: newRadarText.trim(),
                    date: newRadarDate || null,
                    fromTask: false
                };
                setRadar([...radar, newEntry]);
                setNewRadarText("");
                setNewRadarDate("");
            };

            const handleRemoveRadar = (id) => {
                setRadar(radar.filter(item => item.id !== id));
            };

            // L√≤gica per trobar la setmana actual i calcular les claus de data correctes
            const currentWeekObj = allWeeks.find(isCurrentWeek);
            let activeReminders = [];
            
            if (currentWeekObj && reminders) {
                const todayIndex = new Date().getDay() - 1; // Dilluns=0, Divendres=4, Diumenge=6
                if (todayIndex >= 0 && todayIndex <= 4) {
                    const todayKey = addDays(currentWeekObj.id, todayIndex);
                    if (reminders[todayKey]) {
                        activeReminders.push(...reminders[todayKey].map(r => ({...r, day: 'AVUI'})));
                    }
                }
                const tomorrowIndex = todayIndex + 1;
                if (tomorrowIndex >= 0 && tomorrowIndex <= 4) {
                    const tomorrowKey = addDays(currentWeekObj.id, tomorrowIndex);
                    if (reminders[tomorrowKey]) {
                        activeReminders.push(...reminders[tomorrowKey].map(r => ({...r, day: 'DEM√Ä'})));
                    }
                }
            }

            return (
                <div className="max-w-7xl mx-auto p-6 fade-in pb-20">
                    <header className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div>
                            <h1 className="text-3xl font-extrabold text-gray-800">Hola, {config.teacherName || 'Professor'} üëã</h1>
                            <p className={`text-${theme}-500 font-medium`}>Curs {config.schoolYear} - {parseInt(config.schoolYear)+1}</p>
                        </div>

                        {/* TARGETA DE RECORDATORIS AL HEADER */}
                        {activeReminders.length > 0 && (
                            <div className="flex-1 mx-4 max-w-xl w-full">
                                <div className="bg-yellow-50 border-l-4 border-yellow-400 rounded-lg p-3 shadow-sm animate-in fade-in zoom-in duration-300">
                                    <div className="flex items-center gap-2 mb-2">
                                        <Icons.Lightbulb className="text-yellow-600" size={18}/>
                                        <h3 className="font-bold text-yellow-800 text-sm uppercase">Recordatoris Actius</h3>
                                    </div>
                                    <div className="space-y-2 max-h-[80px] overflow-y-auto custom-scroll pr-1">
                                        {activeReminders.map((r, i) => (
                                            <div key={i} className="flex justify-between items-center bg-white/80 p-1.5 rounded border border-yellow-200 text-sm">
                                                <span className="font-medium text-gray-700 truncate mr-2">{r.text}</span>
                                                <div className="flex items-center gap-1 shrink-0">
                                                    <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${r.day === 'AVUI' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>{r.day}</span>
                                                    <span className="text-[10px] text-gray-500 font-mono bg-gray-100 px-1 rounded">{r.time || 'Tot el dia'}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="flex gap-2 items-center">
                             <button onClick={() => setShowResetModal(true)} className="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-1 transition-colors mr-4" title="Reiniciar"><Icons.Trash size={18}/></button>
                             <button onClick={() => setShowInfoModal(true)} className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex gap-2 items-center text-gray-700 font-medium"><Icons.FileJson /> Guardar</button>
                             <button onClick={handleImportClick} className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex gap-2 items-center text-gray-700 font-medium cursor-pointer"><Icons.ArrowRight /> Carregar</button>
                             <input type="file" className="hidden" ref={fileInputRef} onChange={onImport} accept=".json"/>
                            <button onClick={goToConfig} className="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 text-gray-600"><Icons.Settings /></button>
                        </div>
                    </header>

                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
                        <div className="flex justify-between text-sm font-bold text-gray-600 mb-2"><span>Progr√©s Real del Curs</span><span>{calculateProgress()}%</span></div>
                        <div className="w-full bg-gray-100 rounded-full h-4 overflow-hidden"><div className={`bg-${theme}-500 h-4 rounded-full transition-all duration-500`} style={{ width: `${calculateProgress()}%` }}></div></div>
                    </div>

                    {/* NOVA SECCI√ì: PROGRAMACI√ì PER CLASSES */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
                        <h2 className="text-lg font-bold mb-4 text-gray-800 flex items-center gap-2"><Icons.Table /> Programaci√≥ per Classes</h2>
                        {config.classes.length === 0 ? (
                            <p className="text-sm text-gray-500 italic">No tens cap classe configurada encara.</p>
                        ) : (
                            <div className="flex flex-wrap gap-3">
                                {config.classes.map(c => (
                                    <button 
                                        key={c.id} 
                                        onClick={() => onSelectClassView(c.id)} 
                                        className={`px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition-all hover:scale-105 border ${c.color.replace('text-', 'text-gray-900 border-').replace('bg-', 'bg-').split(' ')[0]}`}
                                    >
                                        {c.name}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2">
                            <div className="flex justify-between items-center mb-4">
                                <button onClick={() => changeMonth(-1)} className="p-2 bg-white rounded-full shadow hover:bg-gray-50 text-gray-600"><Icons.ChevronLeft /></button>
                                <h2 className="text-xl font-bold flex items-center gap-2 capitalize text-gray-800">{MONTHS[currentViewDate.getMonth()]} {currentViewDate.getFullYear()}</h2>
                                <button onClick={() => changeMonth(1)} className="p-2 bg-white rounded-full shadow hover:bg-gray-50 text-gray-600"><Icons.ChevronRight /></button>
                            </div>
                            
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {currentMonthWeeks.map(week => {
                                    const isCompleted = completedWeeks.includes(week.id);
                                    const isHoliday = holidayWeeks?.includes(week.id);
                                    const isCurrent = isCurrentWeek(week);
                                    const utEnding = getUTForWeek(week);
                                    
                                    // Afegim classes de color segons si √©s final de UT
                                    let cardClasses = `relative p-5 rounded-xl border transition-all h-full flex flex-col justify-between `;
                                    if (isCurrent) {
                                        cardClasses += `ring-2 ring-${theme}-500 bg-${theme}-300 shadow-lg scale-[1.02]`;
                                    } else if (utEnding) {
                                        cardClasses += `bg-red-50 border-red-300 hover:border-red-400 shadow-sm`;
                                    } else {
                                        cardClasses += `bg-white border-gray-200 hover:border-${theme}-200`;
                                    }

                                    return (
                                        <div key={week.id} className={cardClasses}>
                                            <div onClick={() => onSelectWeek(week.id)} className="cursor-pointer h-full">
                                                <h3 className={`font-bold text-lg pr-12 ${isCurrent ? `text-${theme}-900` : (utEnding ? 'text-red-900' : 'text-gray-800')}`}>{week.label}</h3>
                                                <p className={`text-sm mb-2 ${isCurrent ? `text-${theme}-800` : (utEnding ? 'text-red-700' : 'text-gray-500')}`}>{week.startDate.toLocaleDateString()} - {week.endDate.toLocaleDateString()}</p>
                                                {isCurrent && <span className={`bg-${theme}-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase shadow-sm inline-block mr-1`}>Actual</span>}
                                            </div>
                                            
                                            {/* Etiqueta final UT inferior dreta */}
                                            {utEnding && <div className="absolute bottom-3 right-3 bg-red-600 text-white text-[10px] px-2 py-1 rounded shadow-md font-bold uppercase">Final {utEnding.name}</div>}

                                            <button onClick={(e) => { e.stopPropagation(); onToggleWeekComplete(week.id); }} className={`absolute top-4 right-4 p-2 rounded-full transition-all ${isCompleted ? 'bg-green-100 text-green-600 shadow-inner' : (isCurrent ? 'bg-white/50 text-orange-700 hover:bg-white' : 'bg-gray-100 text-gray-300 hover:bg-gray-200')}`}>{isCompleted ? <Icons.CheckCircle /> : <Icons.Check />}</button>
                                            <button onClick={(e) => { e.stopPropagation(); onToggleHoliday(week.id); }} className={`absolute top-4 right-16 w-9 h-9 flex items-center justify-center rounded-full transition-all ${isHoliday ? 'bg-purple-100 text-purple-600 shadow-inner' : 'bg-gray-100 text-gray-300 hover:bg-gray-200'}`} title="Marcar com Vacances">üéâ</button>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <div className="lg:col-span-1 h-full flex flex-col gap-6">
                            {/* RADAR NOU FORMAT LLISTA */}
                            <div className="bg-white rounded-xl shadow-lg border border-gray-200 flex flex-col overflow-hidden h-[350px]">
                                <div className="bg-gray-800 text-white p-4 flex justify-between items-center shrink-0">
                                    <h2 className="font-bold flex items-center gap-2"><Icons.AlertCircle /> RADAR</h2>
                                </div>
                                <div className="flex-1 bg-yellow-50/30 p-4 overflow-y-auto custom-scroll space-y-3">
                                    {radar.length === 0 && <p className="text-gray-400 italic text-sm text-center mt-4">Cap entrada pendent.</p>}
                                    {radar.map(item => (
                                        <div key={item.id} className="relative group bg-white border border-gray-200 rounded p-2 shadow-sm flex gap-2">
                                            {item.date && (
                                                <div className="absolute -top-2 right-2 bg-red-100 text-red-800 text-[9px] font-bold px-1.5 py-0.5 rounded shadow-sm border border-red-200">
                                                    {new Date(item.date).toLocaleDateString()}
                                                </div>
                                            )}
                                            <button onClick={() => handleRemoveRadar(item.id)} className="shrink-0 mt-0.5 text-gray-300 hover:text-green-500 transition-colors" title="Marcar com a fet">
                                                <Icons.CheckCircle size={18} />
                                            </button>
                                            <p className={`text-sm text-gray-700 pt-0.5 ${item.date ? 'mt-1' : ''}`}>{item.text}</p>
                                        </div>
                                    ))}
                                    
                                    {/* Entrada buida al final per afegir */}
                                    <div className="border-t border-gray-200 pt-3 mt-4">
                                        <div className="bg-white border-2 border-dashed border-gray-200 rounded p-2 flex flex-col gap-2">
                                            <textarea 
                                                className="w-full text-sm resize-none outline-none focus:bg-gray-50"
                                                placeholder="Nova nota o tasca al radar..."
                                                value={newRadarText}
                                                onChange={(e) => setNewRadarText(e.target.value)}
                                                onKeyDown={(e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleAddRadar(); }}}
                                            />
                                            <div className="flex justify-between items-center">
                                                <input 
                                                    type="date" 
                                                    className="text-[10px] text-gray-500 border rounded p-1 outline-none"
                                                    value={newRadarDate}
                                                    onChange={(e) => setNewRadarDate(e.target.value)}
                                                />
                                                <button onClick={handleAddRadar} disabled={!newRadarText.trim()} className="bg-gray-800 text-white text-xs px-3 py-1 rounded font-bold disabled:opacity-50">Afegir</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* CONTAINER FOR BOTH LINK BOXES */}
                            <div className="grid grid-cols-2 gap-4">
                                {/* SEGUIMENT TASQUES (BLUE) */}
                                <div className="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                                    <div className="bg-blue-600 text-white p-3 flex justify-between items-center">
                                        <h2 className="font-bold flex items-center gap-1 text-sm"><Icons.CheckCircle size={16} /> Seguiment</h2>
                                        <button onClick={() => setEditingTaskLink(!editingTaskLink)} className="text-white hover:text-blue-100"><Icons.Edit size={14}/></button>
                                    </div>
                                    <div className="p-3 bg-blue-50 text-center h-24 flex items-center justify-center">
                                        {editingTaskLink ? (
                                            <div className="flex flex-col gap-2 w-full">
                                                <input 
                                                    type="text" 
                                                    className="w-full p-1 border rounded text-xs focus:outline-none focus:border-blue-500" 
                                                    placeholder="URL..." 
                                                    value={tempTaskLink} 
                                                    onChange={(e) => setTempTaskLink(e.target.value)}
                                                />
                                                <button onClick={handleSaveTaskLink} className="bg-blue-600 text-white px-2 py-0.5 rounded text-xs font-bold hover:bg-blue-700">Guardar</button>
                                            </div>
                                        ) : (
                                            config.taskTrackingUrl ? (
                                                <a href={config.taskTrackingUrl} target="_blank" rel="noreferrer" className="flex flex-col items-center gap-1 text-blue-700 font-bold hover:text-blue-900 text-xs">
                                                    <Icons.Link size={24}/> Obrir
                                                </a>
                                            ) : (
                                                <span className="text-xs text-gray-400 italic cursor-pointer" onClick={() => setEditingTaskLink(true)}>Afegir Link</span>
                                            )
                                        )}
                                    </div>
                                </div>

                                {/* PROGRAMACI√ì LINK (GREEN) */}
                                <div className="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                                    <div className="bg-green-600 text-white p-3 flex justify-between items-center">
                                        <h2 className="font-bold flex items-center gap-1 text-sm"><Icons.Link size={16} /> Programaci√≥</h2>
                                        <button onClick={() => setEditingLink(!editingLink)} className="text-white hover:text-green-100"><Icons.Edit size={14}/></button>
                                    </div>
                                    <div className="p-3 bg-green-50 text-center h-24 flex items-center justify-center">
                                        {editingLink ? (
                                            <div className="flex flex-col gap-2 w-full">
                                                <input 
                                                    type="text" 
                                                    className="w-full p-1 border rounded text-xs focus:outline-none focus:border-green-500" 
                                                    placeholder="URL..." 
                                                    value={tempLink} 
                                                    onChange={(e) => setTempLink(e.target.value)}
                                                />
                                                <button onClick={handleSaveLink} className="bg-green-600 text-white px-2 py-0.5 rounded text-xs font-bold hover:bg-green-700">Guardar</button>
                                            </div>
                                        ) : (
                                            config.googleSheetUrl ? (
                                                <a href={config.googleSheetUrl} target="_blank" rel="noreferrer" className="flex flex-col items-center gap-1 text-green-700 font-bold hover:text-green-900 text-xs">
                                                    <Icons.Link size={24}/> Obrir
                                                </a>
                                            ) : (
                                                <span className="text-xs text-gray-400 italic cursor-pointer" onClick={() => setEditingLink(true)}>Afegir Link</span>
                                            )
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showResetModal && ReactDOM.createPortal(
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] fade-in">
                            <div className="bg-white p-6 rounded-xl max-w-sm w-full shadow-2xl border-t-4 border-red-500">
                                <h3 className="text-lg font-bold text-red-600 mb-2">Atenci√≥! Zona de perill</h3>
                                <p className="text-gray-600 mb-6 text-sm">Segur que vols eliminar tota la informaci√≥? Aquest bot√≥ est√† pensat per reiniciar l'agenda per al proper curs.</p>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowResetModal(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Cancel¬∑lar</button>
                                    <button onClick={() => { onReset(); setShowResetModal(false); }} className="px-4 py-2 bg-red-600 text-white rounded font-bold hover:bg-red-700">S√≠, eliminar tot</button>
                                </div>
                            </div>
                        </div>, document.body
                    )}

                    {showInfoModal && ReactDOM.createPortal(
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] fade-in">
                            <div className="bg-white p-6 rounded-xl max-w-md w-full shadow-2xl border-t-4 border-blue-500">
                                <h3 className="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2"><Icons.FileJson /> C√≤pia de Seguretat</h3>
                                <p className="text-gray-600 mb-4 text-sm">Aquest bot√≥ descarregar√† un arxiu <b>.json</b> al teu ordinador.</p>
                                <ul className="list-disc list-inside text-xs text-gray-500 mb-6 space-y-1"><li>L'aplicaci√≥ ja guarda autom√†ticament les dades al navegador.</li><li>Fes servir aquesta opci√≥ per moure les dades a un altre dispositiu.</li><li>O per guardar una c√≤pia de seguretat externa.</li></ul>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowInfoModal(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Cancel¬∑lar</button>
                                    <button onClick={() => { setShowInfoModal(false); onExport(); }} className="px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Entesos, descarregar</button>
                                </div>
                            </div>
                        </div>, document.body
                    )}

                    {showImportModal && ReactDOM.createPortal(
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] fade-in">
                            <div className="bg-white p-6 rounded-xl max-w-md w-full shadow-2xl border-t-4 border-green-500">
                                <h3 className="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2"><Icons.ArrowRight /> Carregar C√≤pia</h3>
                                <p className="text-gray-600 mb-4 text-sm">Aquesta opci√≥ serveix per <b>restaurar</b> una c√≤pia de seguretat que tinguis guardada al teu ordinador (arxiu .json).</p>
                                <p className="text-gray-600 text-sm mb-6">Aix√≤ substituir√† les dades actuals per les de l'arxiu.</p>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowImportModal(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Cancel¬∑lar</button>
                                    <button onClick={confirmImport} className="px-4 py-2 bg-green-600 text-white rounded font-bold hover:bg-green-700">Seleccionar Arxiu</button>
                                </div>
                            </div>
                        </div>, document.body
                    )}
                </div>
            );
        };

        const TaskListInput = ({ tasks, onChange, disabled, onAction, theme }) => {
            const [focusedIndex, setFocusedIndex] = useState(null);
            const [draggedIdx, setDraggedIdx] = useState(null);
            const [dragOverIdx, setDragOverIdx] = useState(null);
            const [dragEnabled, setDragEnabled] = useState(false);
            const containerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (containerRef.current && !containerRef.current.contains(e.target)) {
                        setFocusedIndex(null);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const updateTask = (idx, field, value) => {
                const newTasks = [...tasks];
                newTasks[idx] = { ...newTasks[idx], [field]: value };
                if (idx === tasks.length - 1 && field === 'text' && value.trim() !== '') {
                    newTasks.push({ text: '', time: '', status: null });
                }
                onChange(newTasks);
            };

            const deleteTask = (idx) => {
                setFocusedIndex(null); // Tanca el men√∫
                const newTasks = tasks.filter((_, i) => i !== idx);
                if(newTasks.length === 0) newTasks.push({ text: '', time: '', status: null });
                if(newTasks[newTasks.length-1].text.trim() !== '') newTasks.push({ text: '', time: '', status: null });
                onChange(newTasks);
            };

            // Drag and Drop
            const onDragStart = (e, index) => {
                setDraggedIdx(index);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', index);
            };

            const onDragOver = (e, index) => {
                e.preventDefault(); 
                e.dataTransfer.dropEffect = 'move';
                if (dragOverIdx !== index) setDragOverIdx(index);
            };

            const onDrop = (e, targetIndex) => {
                e.preventDefault();
                if (draggedIdx === null) return;
                if (draggedIdx === targetIndex) {
                    setDragOverIdx(null);
                    setDraggedIdx(null);
                    return;
                }

                const newTasks = [...tasks];
                const draggedTask = newTasks[draggedIdx];
                newTasks.splice(draggedIdx, 1);
                newTasks.splice(targetIndex, 0, draggedTask);

                // Neteja els buits que hagin pogut quedar pel mig i afegeix-ne un al final
                let filtered = newTasks.filter(t => t.text.trim() !== '');
                filtered.push({ text: '', time: '', status: null });
                while(filtered.length < 3) filtered.push({ text: '', time: '', status: null });

                onChange(filtered);
                setDragOverIdx(null);
                setDraggedIdx(null);
                setDragEnabled(false);
            };

            const onDragEnd = () => {
                setDragOverIdx(null);
                setDraggedIdx(null);
                setDragEnabled(false);
            };

            const getInputClass = (status) => {
                if (status === 'skipped') return "task-skipped";
                if (status === 'unfinished') return "task-unfinished";
                return "";
            };

            return (
                <div className="flex flex-col gap-1 w-full pb-2" ref={containerRef}>
                    {tasks.map((task, idx) => (
                        <div 
                            key={idx} 
                            draggable={dragEnabled && !disabled && task.text.trim() !== ''}
                            onDragStart={(e) => onDragStart(e, idx)}
                            onDragOver={(e) => onDragOver(e, idx)}
                            onDrop={(e) => onDrop(e, idx)}
                            onDragEnd={onDragEnd}
                            className={`flex flex-col group relative border-dashed border-gray-100 last:border-0 pl-6 ${dragOverIdx === idx ? 'border-t-2 border-t-blue-500 pt-1 mt-1' : 'border-b pb-1 mt-1'} ${draggedIdx === idx ? 'opacity-40' : ''}`}
                        >
                            <div className="flex items-center gap-1.5 relative">
                                {!disabled && task.text.trim() !== '' && (
                                    <div 
                                        className="absolute -left-6 top-1.5 z-20 flex items-center text-gray-300 hover:text-gray-500 cursor-grab active:cursor-grabbing" 
                                        title="Arrossega per moure"
                                        onMouseEnter={() => setDragEnabled(true)}
                                        onMouseLeave={() => setDragEnabled(false)}
                                    >
                                        <Icons.Menu size={16}/>
                                    </div>
                                )}

                                <span className={`text-${theme}-400 font-bold mt-1`}>‚Ä¢</span>
                                {task.tag === 'skipped' && <span className="text-red-500 text-[10px] mr-1" title="No feta">üî¥</span>}
                                {task.tag === 'unfinished' && <span className="text-red-600 text-[10px] mr-1" title="Inacabada">‚ö†Ô∏è</span>}

                                <div className="flex-shrink-0 flex items-center justify-end w-[35px]">
                                    <input 
                                        type="text" 
                                        className="w-6 bg-transparent text-right text-xs font-bold time-red focus:bg-white focus:ring-1 focus:ring-red-200 rounded outline-none"
                                        placeholder="-"
                                        value={task.time || ''}
                                        onChange={(e) => {
                                            const val = e.target.value.replace(/\D/g, ''); // Nom√©s n√∫meros
                                            updateTask(idx, 'time', val);
                                        }}
                                        onFocus={() => { setFocusedIndex(idx); }}
                                        disabled={disabled}
                                    />
                                    <span className="text-xs font-bold time-red select-none">'</span>
                                </div>
                                <input 
                                    type="text" 
                                    className={`flex-1 bg-transparent hover:bg-gray-50 focus:bg-white rounded px-1 focus:ring-1 focus:ring-${theme}-200 focus:outline-none text-sm py-0.5 transition-colors task-input ${getInputClass(task.status)}`}
                                    placeholder={disabled ? "" : "Activitat..."}
                                    value={task.text}
                                    onChange={(e) => updateTask(idx, 'text', e.target.value)}
                                    onFocus={() => { setFocusedIndex(idx); }}
                                    disabled={disabled}
                                />
                            </div>
                            
                            {focusedIndex === idx && task.text.trim() !== '' && !disabled && (
                                <div className="w-full flex justify-center mt-1 expand-open relative z-30">
                                    <div className="flex gap-2 bg-white border border-gray-200 shadow-sm rounded-full px-2 py-0.5">
                                        <button 
                                            onMouseDown={(e) => { e.preventDefault(); deleteTask(idx); }}
                                            className="flex items-center justify-center bg-red-50 text-red-600 border border-red-200 px-2 py-0.5 rounded hover:bg-red-100 transition-colors"
                                            title="Eliminar activitat"
                                        >
                                            <Icons.Trash size={12}/>
                                        </button>
                                        
                                        <button 
                                            onMouseDown={(e) => { e.preventDefault(); onAction(task, 'save'); }}
                                            className="flex items-center gap-1 text-[10px] bg-yellow-50 text-yellow-700 border border-yellow-200 px-2 py-0.5 rounded hover:bg-yellow-100 transition-colors"
                                            title="Guardar al Radar"
                                        >
                                            <Icons.Save size={12}/> Guardar
                                        </button>
                                        
                                        <button 
                                            onMouseDown={(e) => { e.preventDefault(); onAction(task, 'alert_menu'); }}
                                            className="flex items-center gap-1 text-[10px] bg-orange-50 text-orange-700 border border-orange-200 px-2 py-0.5 rounded hover:bg-orange-100 transition-colors"
                                            title="Apla√ßar / No feta"
                                        >
                                            <Icons.AlertTriangle size={12}/> Apla√ßar
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            );
        };

        const SessionNotepadModal = ({ dayIndex, slotId, className, slotLabel, planData, onClose, onSave }) => {
            const key = `${dayIndex}-${slotId}`;
            const [data, setData] = useState({
                notes: planData[key]?.notes || "",
                materials: planData[key]?.materials || "",
                links: planData[key]?.links || []
            });
            const [linkInput, setLinkInput] = useState({url: "", title: ""});

            useEffect(() => {
                const timer = setTimeout(() => {
                    onSave(dayIndex, slotId, data);
                }, 500);
                return () => clearTimeout(timer);
            }, [data, dayIndex, slotId]);

            const handleChange = (field, value) => {
                setData(prev => ({ ...prev, [field]: value }));
            };

            const addLink = () => {
                if (linkInput.url && linkInput.url.trim()) {
                    setData(prev => ({ ...prev, links: [...(prev.links || []), { url: linkInput.url.trim(), title: linkInput.title.trim() }] }));
                    setLinkInput({url: "", title: ""});
                }
            };

            const removeLink = (index) => {
                setData(prev => ({ ...prev, links: (prev.links || []).filter((_, i) => i !== index) }));
            };

            return (
                <div 
                    className="fixed inset-0 z-[10000] flex items-center justify-center p-4"
                    onClick={onClose}
                >
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
                    <div 
                        className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl flex flex-col max-h-[90vh] animate-in fade-in zoom-in duration-200 relative overflow-hidden"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="bg-gradient-to-r from-orange-100 to-white p-5 border-b border-orange-100 flex justify-between items-center">
                            <div>
                                <h3 className="text-2xl font-bold text-gray-800">{className}</h3>
                                <p className="text-orange-600 font-medium text-sm">{slotLabel}</p>
                            </div>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors">‚úï</button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto custom-scroll space-y-6">
                            {/* Notes Section */}
                            <div className="space-y-2">
                                <label className="flex items-center gap-2 text-sm font-bold text-gray-700 uppercase tracking-wide">
                                    <Icons.FileText size={16} className="text-orange-500"/> Notes de la Sessi√≥
                                </label>
                                <textarea 
                                    className="w-full p-4 border border-gray-200 rounded-xl resize-none focus:ring-2 focus:ring-orange-200 focus:border-orange-300 outline-none text-gray-700 bg-gray-50/50 min-h-[120px] transition-all"
                                    placeholder="Escriu aqu√≠ les observacions, idees o punts clau..."
                                    value={data.notes}
                                    onChange={(e) => handleChange('notes', e.target.value)}
                                />
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Materials Section */}
                                <div className="space-y-2">
                                    <label className="flex items-center gap-2 text-sm font-bold text-gray-700 uppercase tracking-wide">
                                        <Icons.Table size={16} className="text-blue-500"/> Materials Necessaris
                                    </label>
                                    <textarea 
                                        className="w-full p-4 border border-gray-200 rounded-xl resize-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300 outline-none text-gray-700 bg-gray-50/50 min-h-[150px] transition-all"
                                        placeholder="Llista de materials..."
                                        value={data.materials}
                                        onChange={(e) => handleChange('materials', e.target.value)}
                                    />
                                </div>

                                {/* Links Section */}
                                <div className="space-y-2 flex flex-col">
                                    <label className="flex items-center gap-2 text-sm font-bold text-gray-700 uppercase tracking-wide">
                                        <Icons.Link size={16} className="text-green-500"/> Enlla√ßos i Recursos
                                    </label>
                                    <div className="flex-1 bg-gray-50/50 border border-gray-200 rounded-xl p-4 flex flex-col">
                                        <div className="flex flex-col gap-2 mb-3">
                                            <input 
                                                type="text" 
                                                className="w-full border border-gray-300 p-2 rounded-lg text-sm focus:outline-none focus:border-green-500" 
                                                placeholder="T√≠tol del link (opcional)..." 
                                                value={linkInput.title} 
                                                onChange={(e) => setLinkInput({...linkInput, title: e.target.value})}
                                            />
                                            <div className="flex gap-2">
                                                <input 
                                                    type="text" 
                                                    className="flex-1 border border-gray-300 p-2 rounded-lg text-sm focus:outline-none focus:border-green-500" 
                                                    placeholder="URL (https://...)" 
                                                    value={linkInput.url} 
                                                    onChange={(e) => setLinkInput({...linkInput, url: e.target.value})}
                                                    onKeyDown={(e) => e.key === 'Enter' && addLink()}
                                                />
                                                <button onClick={addLink} className="bg-green-500 text-white px-3 py-1 rounded-lg font-bold hover:bg-green-600 transition-colors">+</button>
                                            </div>
                                        </div>
                                        <div className="flex-1 overflow-y-auto max-h-[100px] space-y-2 custom-scroll pr-1">
                                            {(!data.links || data.links.length === 0) && <p className="text-gray-400 text-xs italic text-center mt-4">No hi ha enlla√ßos</p>}
                                            {(data.links || []).map((l, i) => {
                                                const url = typeof l === 'string' ? l : l.url;
                                                const title = typeof l === 'string' ? l : (l.title || l.url);
                                                return (
                                                    <div key={i} className="flex items-center justify-between bg-white p-2 rounded border border-gray-200 shadow-sm text-xs group hover:border-green-300 transition-colors">
                                                        <a href={url} target="_blank" className="text-blue-600 hover:underline truncate max-w-[200px] block font-medium" title={url}>{title}</a>
                                                        <button onClick={()=>removeLink(i)} className="text-gray-300 hover:text-red-500 font-bold px-1 transition-colors">√ó</button>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="bg-gray-50 p-4 border-t border-gray-100 text-right">
                            <span className="text-xs text-gray-400 italic mr-2">Es guarda autom√†ticament...</span>
                            <button onClick={onClose} className="bg-gray-800 text-white px-6 py-2 rounded-lg font-medium hover:bg-gray-900 transition-colors">Tancar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const DailyNotepadModal = ({ dayIndex, dayName, config, planData, extraClasses, onClose, onSave }) => {
            // Include extra classes in the day view
            const daySlots = TIME_SLOTS.filter(slot => slot.type !== 'break' && (config.schedule[dayIndex]?.[slot.id] || extraClasses?.[dayIndex]?.[slot.id]));

            const [formData, setFormData] = useState(() => {
                const init = {};
                daySlots.forEach(slot => {
                    const key = `${dayIndex}-${slot.id}`;
                    init[slot.id] = {
                        notes: planData[key]?.notes || "",
                        materials: planData[key]?.materials || "",
                        links: planData[key]?.links || []
                    };
                });
                return init;
            });

            const [linkInputs, setLinkInputs] = useState({});

            useEffect(() => {
                const timer = setTimeout(() => {
                    onSave(dayIndex, formData);
                }, 500);
                return () => clearTimeout(timer);
            }, [formData, dayIndex]);

            const handleChange = (slotId, field, value) => {
                setFormData(prev => ({
                    ...prev,
                    [slotId]: { ...prev[slotId], [field]: value }
                }));
            };

            const addLink = (slotId) => {
                const input = linkInputs[slotId] || {url: "", title: ""};
                if (input.url && input.url.trim()) {
                    const currentLinks = formData[slotId]?.links || [];
                    setFormData(prev => ({
                        ...prev,
                        [slotId]: { ...prev[slotId], links: [...currentLinks, { url: input.url.trim(), title: input.title.trim() }] }
                    }));
                    setLinkInputs(prev => ({ ...prev, [slotId]: {url: "", title: ""} }));
                }
            };

            const removeLink = (slotId, index) => {
                 const currentLinks = formData[slotId]?.links || [];
                 setFormData(prev => ({
                    ...prev,
                    [slotId]: { ...prev[slotId], links: currentLinks.filter((_, i) => i !== index) }
                }));
            };

            return (
                <div 
                    className="fixed top-20 right-4 w-[600px] bg-white border-2 border-yellow-300 shadow-2xl rounded-xl z-[9999] flex flex-col slide-in-right h-[calc(100vh-100px)]"
                    onClick={(e) => e.stopPropagation()}
                >
                    <div className="bg-yellow-100 p-4 rounded-t-xl border-b border-yellow-200 flex justify-between items-center">
                        <h3 className="font-bold text-yellow-800 flex items-center gap-2"><Icons.FileText /> Bloc de Notes - {dayName}</h3>
                        <button onClick={onClose} className="text-yellow-600 hover:text-yellow-800 font-bold px-2">‚úï</button>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-6 bg-yellow-50/20">
                        {daySlots.length === 0 ? (
                            <p className="text-center text-gray-500 italic p-4">No hi ha classes programades per avui.</p>
                        ) : (
                            daySlots.map(slot => {
                                const classId = config.schedule[dayIndex]?.[slot.id] || extraClasses?.[dayIndex]?.[slot.id];
                                const className = config.classes.find(c => c.id === classId)?.name || "Classe";
                                const data = formData[slot.id] || { notes: "", materials: "", links: [] };

                                return (
                                    <div key={slot.id} className="bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                                        <div className="flex items-center justify-between mb-2 border-b pb-2">
                                            <span className="font-bold text-gray-700 text-sm">{slot.label} - {className}</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="flex flex-col">
                                                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1">Notes</label>
                                                <textarea 
                                                    className="w-full p-2 border rounded resize-none focus:ring-1 focus:ring-yellow-400 text-xs bg-gray-50 min-h-[80px]"
                                                    placeholder="Notes..."
                                                    value={data.notes}
                                                    onChange={(e) => handleChange(slot.id, 'notes', e.target.value)}
                                                />
                                            </div>
                                            <div className="flex flex-col">
                                                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1">Materials</label>
                                                <textarea 
                                                    className="w-full p-2 border rounded resize-none focus:ring-1 focus:ring-yellow-400 text-xs bg-gray-50 min-h-[60px] mb-2"
                                                    placeholder="Materials..."
                                                    value={data.materials}
                                                    onChange={(e) => handleChange(slot.id, 'materials', e.target.value)}
                                                />
                                                {/* Links Section */}
                                                <div className="border-t pt-2">
                                                    <div className="flex flex-col gap-1 mb-2">
                                                        <input 
                                                            type="text" 
                                                            className="flex-1 border p-1 text-[10px] rounded" 
                                                            placeholder="T√≠tol..." 
                                                            value={(linkInputs[slot.id] || {}).title || ""} 
                                                            onChange={(e) => setLinkInputs({...linkInputs, [slot.id]: { ...(linkInputs[slot.id] || {}), title: e.target.value}})} 
                                                        />
                                                        <div className="flex gap-1">
                                                            <input 
                                                                type="text" 
                                                                className="flex-1 border p-1 text-[10px] rounded" 
                                                                placeholder="https://..." 
                                                                value={(linkInputs[slot.id] || {}).url || ""} 
                                                                onChange={(e) => setLinkInputs({...linkInputs, [slot.id]: { ...(linkInputs[slot.id] || {}), url: e.target.value}})} 
                                                            />
                                                            <button onClick={() => addLink(slot.id)} className="bg-yellow-500 text-white px-2 py-0.5 rounded text-[10px] font-bold">+</button>
                                                        </div>
                                                    </div>
                                                    <div className="space-y-1 max-h-[60px] overflow-y-auto">
                                                        {(!data.links || data.links.length === 0) && <p className="text-gray-400 text-xs italic text-center mt-4">No hi ha enlla√ßos</p>}
                                                        {(data.links || []).map((l, i) => {
                                                            const url = typeof l === 'string' ? l : l.url;
                                                            const title = typeof l === 'string' ? l : (l.title || l.url);
                                                            return (
                                                                <div key={i} className="flex items-center justify-between bg-gray-50 p-1 rounded border text-[10px]">
                                                                    <a href={url} target="_blank" className="text-blue-600 underline truncate max-w-[150px] block" title={url}>{title}</a>
                                                                    <button onClick={()=>removeLink(slot.id, i)} className="text-red-500 font-bold ml-1">√ó</button>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        };

        const SmartPasteModal = ({ onPaste, onClose }) => {
            const [text, setText] = useState("");

            const handlePaste = () => {
                if (!text.trim()) return;
                const lines = text.split('\n').filter(l => l.trim());
                const parsedTasks = lines.map(line => {
                    // Regex per detectar "‚Ä¢ 10' text" o "10 min text" o "text"
                    const timeMatch = line.match(/^[\‚Ä¢\-\*]?\s*(\d+)['‚Äôm\s]*(.*)/i);
                    if (timeMatch) {
                        return { 
                            time: timeMatch[1], 
                            text: timeMatch[2].replace(/^in\s+/, '').trim(), 
                            status: null 
                        };
                    } else {
                        return { 
                            time: "", 
                            text: line.replace(/^[\‚Ä¢\-\*]\s*/, '').trim(), 
                            status: null 
                        };
                    }
                });
                onPaste(parsedTasks);
                onClose();
            };

            return (
                <div className="fixed inset-0 z-[10000] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative animate-in zoom-in duration-200">
                        <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <Icons.Paste className="text-blue-500"/> Enganxar Programaci√≥
                        </h3>
                        <p className="text-xs text-gray-500 mb-2">Enganxa les l√≠nies del teu document (Ex: "‚Ä¢ 10' Introducci√≥"). S'afegiran autom√†ticament sota les tasques existents.</p>
                        <textarea 
                            className="w-full p-3 border rounded-lg h-40 text-sm font-mono mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="‚Ä¢ 10' Activitat 1&#10;‚Ä¢ 20' Activitat 2..."
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                        />
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Cancel¬∑lar</button>
                            <button onClick={handlePaste} className="px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Processar i Enganxar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ReminderModal = ({ dateStr, dayName, reminders, onSave, onClose }) => {
            const [localReminders, setLocalReminders] = useState(reminders || []);
            const [newReminder, setNewReminder] = useState({ text: "", time: "" });

            const addReminder = () => {
                if (newReminder.text.trim()) {
                    setLocalReminders([...localReminders, newReminder]);
                    setNewReminder({ text: "", time: "" });
                }
            };

            const removeReminder = (index) => {
                setLocalReminders(localReminders.filter((_, i) => i !== index));
            };

            const handleSave = () => {
                onSave(dateStr, localReminders);
                onClose();
            };

            return (
                <div className="fixed inset-0 z-[10000] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative animate-in zoom-in duration-200">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <Icons.Lightbulb className="text-yellow-500"/> Recordatoris {dayName}
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600">‚úï</button>
                        </div>
                        
                        <div className="space-y-3 mb-6">
                            <div className="flex gap-2 items-end">
                                <div className="flex-1">
                                    <label className="text-xs font-bold text-gray-500">Recordatori</label>
                                    <input 
                                        type="text" 
                                        className="w-full border p-2 rounded" 
                                        placeholder="Ex: Avaluaci√≥..." 
                                        value={newReminder.text}
                                        onChange={(e) => setNewReminder({...newReminder, text: e.target.value})}
                                        onKeyDown={(e) => e.key === 'Enter' && addReminder()}
                                    />
                                </div>
                                <div className="w-24">
                                    <label className="text-xs font-bold text-gray-500">Hora</label>
                                    <input 
                                        type="time" 
                                        className="w-full border p-2 rounded" 
                                        value={newReminder.time}
                                        onChange={(e) => setNewReminder({...newReminder, time: e.target.value})}
                                    />
                                </div>
                                <button onClick={addReminder} className="bg-yellow-500 text-white px-3 py-2 rounded font-bold hover:bg-yellow-600">+</button>
                            </div>
                            
                            <div className="bg-yellow-50 rounded-lg p-3 min-h-[100px] max-h-[200px] overflow-y-auto">
                                {localReminders.length === 0 && <p className="text-gray-400 text-sm italic text-center">Cap recordatori.</p>}
                                {localReminders.map((r, i) => (
                                    <div key={i} className="flex justify-between items-center bg-white p-2 rounded mb-2 shadow-sm">
                                        <div>
                                            <p className="font-medium text-gray-800 text-sm">{r.text}</p>
                                            <p className="text-xs text-gray-500">{r.time || "Tot el dia"}</p>
                                        </div>
                                        <button onClick={() => removeReminder(i)} className="text-red-400 hover:text-red-600 font-bold px-2">√ó</button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Cancel¬∑lar</button>
                            <button onClick={handleSave} className="px-4 py-2 bg-yellow-500 text-white rounded font-bold hover:bg-yellow-600">Guardar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const PlannerScreen = ({ weekId, weeksData, config, onConfigChange, onUpdateWeekData, onSaveWeek, onBack, onAddToRadar, allWeeks, holidayWeeks, reminders, onSaveReminder }) => {
            const [planData, setPlanData] = useState(weeksData[weekId] || {});
            const [history, setHistory] = useState([]);
            const [future, setFuture] = useState([]);
            const [reviewMode, setReviewMode] = useState(false);
            const [showExportModal, setShowExportModal] = useState(false);
            const [exportClassId, setExportClassId] = useState("");
            const [exportConfig, setExportConfig] = useState({ curs: "", ut: "", fase: "FASE DE PREPARACI√ì" });
            const [showAddClassModal, setShowAddClassModal] = useState(false);
            const [newExtra, setNewExtra] = useState({ day: 0, slot: 0, classId: "" });
            const [showWeekends, setShowWeekends] = useState(false);
            
            const [showCopyModal, setShowCopyModal] = useState(false);
            const [copySource, setCopySource] = useState(null);
            const [targetClassId, setTargetClassId] = useState("");
            const [targetDay, setTargetDay] = useState(0);
            const [targetSlot, setTargetSlot] = useState(0);

            const [pendingActionTask, setPendingActionTask] = useState(null);
            const [activeDayNotepad, setActiveDayNotepad] = useState(null); 
            const [activeSessionNotepad, setActiveSessionNotepad] = useState(null);
            const [activeReminderModal, setActiveReminderModal] = useState(null); 
            const [activeSmartPaste, setActiveSmartPaste] = useState(null); 

            const theme = config.theme || 'orange';
            const viewDays = showWeekends ? [...WORK_DAYS, ...WEEKEND_DAYS] : WORK_DAYS;

            useEffect(() => {
                setPlanData(weeksData[weekId] || {});
            }, [weekId, weeksData]);

            const updatePlanData = (newData, saveToHistory = true) => {
                if (saveToHistory) {
                    setHistory(prev => [...prev, planData]);
                    setFuture([]); 
                }
                setPlanData(newData);
                onUpdateWeekData(weekId, newData);
            }

            const handleUndo = () => {
                if (history.length === 0) return;
                const previous = history[history.length - 1];
                const newHistory = history.slice(0, -1);
                setFuture(prev => [planData, ...prev]); 
                setHistory(newHistory);
                setPlanData(previous);
                onUpdateWeekData(weekId, previous);
            };

            const handleRedo = () => {
                if (future.length === 0) return;
                const next = future[0];
                const newFuture = future.slice(1);
                setHistory(prev => [...prev, planData]); 
                setFuture(newFuture);
                setPlanData(next);
                onUpdateWeekData(weekId, next);
            };

            const getTasks = (d, s, dataObj = planData) => {
                const k = `${d}-${s}`;
                const existing = dataObj[k]?.tasks;
                if (existing && Array.isArray(existing) && existing.length > 0) return existing;
                return [{ text: '', time: '', status: null }, { text: '', time: '', status: null }, { text: '', time: '', status: null }];
            };

            const getTotalTime = (d, s) => {
                const tasks = getTasks(d, s);
                return tasks.reduce((acc, t) => acc + (parseInt(t.time) || 0), 0);
            };

            const handleTasksChange = (d, s, newTasks) => {
                const newData = { ...planData, [`${d}-${s}`]: { ...planData[`${d}-${s}`], tasks: newTasks } };
                updatePlanData(newData);
            };

            const handleReviewChange = (d, s, val) => {
                const newData = { ...planData, [`${d}-${s}`]: { ...planData[`${d}-${s}`], review: val } };
                updatePlanData(newData);
            };

            const handleStatusChange = (d, s, val) => {
                const newData = { ...planData, [`${d}-${s}`]: { ...planData[`${d}-${s}`], status: val } };
                if (val === null) {
                    newData[`${d}-${s}`].zzzReason = "";
                }
                updatePlanData(newData);
            };

            const handleDailyNotepadSave = (dayIndex, dayData) => {
                let newData = { ...planData };
                Object.keys(dayData).forEach(slotId => {
                    const k = `${dayIndex}-${slotId}`;
                    const currentCell = newData[k] || {};
                    newData[k] = { 
                        ...currentCell, 
                        notes: dayData[slotId].notes, 
                        materials: dayData[slotId].materials,
                        links: dayData[slotId].links
                    };
                });
                updatePlanData(newData);
            };

            const handleSessionNotepadSave = (dayIndex, slotId, data) => {
                let newData = { ...planData };
                const k = `${dayIndex}-${slotId}`;
                const currentCell = newData[k] || {};
                newData[k] = {
                    ...currentCell,
                    notes: data.notes,
                    materials: data.materials,
                    links: data.links
                };
                updatePlanData(newData);
            }

            const handleSmartPaste = (tasks) => {
                if (!activeSmartPaste) return;
                const { day, slot } = activeSmartPaste;
                
                const currentTasks = getTasks(day, slot).filter(t => t.text.trim() !== '');
                const combinedTasks = [...currentTasks, ...tasks];
                
                while(combinedTasks.length < 3) {
                    combinedTasks.push({text: "", time: "", status: null});
                }
                
                const newData = { ...planData };
                const key = `${day}-${slot}`;
                newData[key] = { ...(newData[key] || {}), tasks: combinedTasks };
                updatePlanData(newData);
            };

            const findNextSession = (d, s, cid) => {
                let found = null;
                const currentDuration = config.durations?.[`${d}-${s}`] === 2 ? 2 : 1;
                let startSlot = s + currentDuration;

                for(let i=d; i<5; i++) { 
                    for(let j=0; j<TIME_SLOTS.length; j++) { 
                        if(i===d && j < startSlot) continue; 
                        if(config.schedule[i]?.[j] === cid) { found={d:i, s:j, w:0}; break; } 
                    } 
                    if(found) break; 
                }
                if(!found) { 
                    for(let i=0; i<5; i++) { 
                        for(let j=0; j<TIME_SLOTS.length; j++) { 
                            if(config.schedule[i]?.[j] === cid) { found={d:i, s:j, w:1}; break; } 
                        } 
                        if(found) break; 
                    } 
                }
                return found;
            };

            const handleTaskAction = (d, s, cid, task, action) => {
                if (action === 'save') {
                    onAddToRadar(task.text, d);
                } else if (action === 'alert_menu') {
                    const tasks = getTasks(d, s);
                    const idx = tasks.findIndex(t => t === task);
                    setPendingActionTask({ d, s, cid, idx, task });
                }
            };

            const executePendingAction = (type) => {
                if (!pendingActionTask) return;
                const { d, s, cid, idx, task } = pendingActionTask;
                const newPlanData = { ...planData };
                const sourceKey = `${d}-${s}`;
                const sourceTasks = getTasks(d, s, newPlanData); 
                const newSourceTasks = [...sourceTasks];
                newSourceTasks[idx] = { ...newSourceTasks[idx], status: type }; 
                newPlanData[sourceKey] = { ...(newPlanData[sourceKey] || {}), tasks: newSourceTasks };

                const found = findNextSession(d, s, cid);
                if(found) {
                    const newTaskObj = { 
                        text: task.text, 
                        time: task.time, 
                        status: null, 
                        tag: type === 'skipped' ? 'skipped' : 'unfinished' 
                    };
                    
                    if(found.w === 0) {
                        const targetKey = `${found.d}-${found.s}`;
                        const targetTasks = getTasks(found.d, found.s, newPlanData);
                        const newTargetTasks = [newTaskObj, ...targetTasks];
                        newPlanData[targetKey] = { ...(newPlanData[targetKey] || {}), tasks: newTargetTasks };
                        updatePlanData(newPlanData); 
                        alert(`Activitat moguda a ${DAYS[found.d]}`);
                    } else {
                        updatePlanData(newPlanData);
                        
                        const getNextActiveWeekId = (currentWid) => {
                            const currentIndex = allWeeks.findIndex(w => w.id === currentWid);
                            if (currentIndex === -1) return null;
                            let nextIndex = currentIndex + 1;
                            while (nextIndex < allWeeks.length) {
                                const w = allWeeks[nextIndex];
                                if (!holidayWeeks.includes(w.id)) return w.id;
                                nextIndex++;
                            }
                            return null;
                        };

                        const nextWeekId = getNextActiveWeekId(weekId);
                        if (nextWeekId) {
                            const nextWeekData = weeksData[nextWeekId] || {};
                            const targetKey = `${found.d}-${found.s}`;
                            const targetTasks = getTasks(found.d, found.s, nextWeekData);
                            const newTargetTasks = [newTaskObj, ...targetTasks];
                            const updatedNextWeekData = { ...nextWeekData, [targetKey]: { ...(nextWeekData[targetKey] || {}), tasks: newTargetTasks } };
                            onUpdateWeekData(nextWeekId, updatedNextWeekData);
                            alert(`Activitat moguda a la setmana vinent (${DAYS[found.d]})`);
                        } else {
                            alert("No s'ha trobat cap setmana lectiva disponible.");
                        }
                    }
                } else {
                    updatePlanData(newPlanData);
                    alert("No s'ha trobat cap altra sessi√≥ per moure l'activitat.");
                }
                setPendingActionTask(null);
            };

            const handleZzzAction = (d, s, cid) => {
                const currentTasks = getTasks(d, s).filter(t => t.text.trim());
                let newData = { ...planData };
                
                const currentKey = `${d}-${s}`;
                newData[currentKey] = { 
                    ...newData[currentKey], 
                    status: 'zzz', 
                    zzzReason: newData[currentKey]?.zzzReason || "", 
                    tasks: [{text: "", time: "", status: null}, {text: "", time: "", status: null}, {text: "", time: "", status: null}] 
                };

                if (currentTasks.length > 0) {
                    const found = findNextSession(d, s, cid);
                    if (found) {
                        const movedTasks = currentTasks.map(t => ({...t, text: `(Del ${DAYS[d]}) ${t.text}`, status: null}));
                        
                        if (found.w === 0) {
                            const targetKey = `${found.d}-${found.s}`;
                            const targetTasks = getTasks(found.d, found.s, planData); 
                            newData[targetKey] = {
                                ...newData[targetKey],
                                tasks: [...movedTasks, ...targetTasks]
                            };
                            alert(`Classe cancel¬∑lada. Mogut a ${DAYS[found.d]}.`);
                        } else {
                            const getNextActiveWeekId = (currentWid) => {
                                const currentIndex = allWeeks.findIndex(w => w.id === currentWid);
                                if (currentIndex === -1) return null;
                                let nextIndex = currentIndex + 1;
                                while (nextIndex < allWeeks.length) {
                                    const w = allWeeks[nextIndex];
                                    if (!holidayWeeks.includes(w.id)) return w.id;
                                    nextIndex++;
                                }
                                return null;
                            };

                            const nextWeekId = getNextActiveWeekId(weekId);
                            if (nextWeekId) {
                                const nextWeekData = weeksData[nextWeekId] || {};
                                const targetKey = `${found.d}-${found.s}`;
                                const targetTasks = getTasks(found.d, found.s, nextWeekData);
                                const updatedNextWeekData = { ...nextWeekData, [targetKey]: { ...(nextWeekData[targetKey] || {}), tasks: [...movedTasks, ...targetTasks] } };
                                onUpdateWeekData(nextWeekId, updatedNextWeekData);
                                alert(`Classe cancel¬∑lada. Mogut a la setmana vinent (${DAYS[found.d]}).`);
                            } else {
                                alert("No s'ha trobat cap setmana lectiva disponible per moure les tasques.");
                            }
                        }
                    } else {
                        alert("Zzz marcat (sense moure, no hi ha propera sessi√≥).");
                    }
                }
                
                updatePlanData(newData);
            };

            const handleAddExtraClass = () => {
                if (!newExtra.classId) return;
                const newExtraClasses = { ...(planData.extraClasses || {}) };
                if (!newExtraClasses[newExtra.day]) newExtraClasses[newExtra.day] = {};
                newExtraClasses[newExtra.day][newExtra.slot] = newExtra.classId;

                const newData = { ...planData, extraClasses: newExtraClasses };
                updatePlanData(newData);
                setShowAddClassModal(false);
            };

            const handleRemoveExtraClass = (d, s) => {
                if (confirm("Segur que vols eliminar aquesta classe extra?")) {
                    const newExtraClasses = { ...(planData.extraClasses || {}) };
                    if (newExtraClasses[d]) {
                        delete newExtraClasses[d][s];
                    }
                    const newData = { ...planData, extraClasses: newExtraClasses };
                    updatePlanData(newData);
                }
            };

            const openCopyModal = (d, s, cid) => {
                setCopySource({ day: d, slot: s, classId: cid });
                setShowCopyModal(true);
            };

            const executeCopy = (targetType) => {
                const sourceTasks = getTasks(copySource.day, copySource.slot).filter(t => t.text.trim());
                if(sourceTasks.length === 0) { alert("No hi ha activitats."); setShowCopyModal(false); return; }
                let found = null;
                if (targetType === 'next_same') found = findNextSession(copySource.day, copySource.slot, copySource.classId);
                else if (targetType === 'next_other') { if(!targetClassId) return alert("Selecciona un grup."); found = findNextSession(copySource.day, copySource.slot, targetClassId); }
                else if (targetType === 'manual') found = { d: targetDay, s: targetSlot, w: 0 };

                if (found && found.w === 0) {
                    const existingTasks = getTasks(found.d, found.s);
                    const combined = [...existingTasks.filter(t => t.text.trim()), ...sourceTasks.map(t => ({...t, status: null}))];
                    while(combined.length < 3) combined.push({text:"", time:"", status: null});
                    handleTasksChange(found.d, found.s, combined);
                    alert("Copiades!");
                    setShowCopyModal(false);
                } else { alert("Nom√©s es pot copiar dins la mateixa setmana actualment."); }
            };

            const generateHTML = (onlyRows = false) => {
                let html = onlyRows ? '' : `<table style="width:100%; border-collapse:collapse; font-family:Arial, sans-serif;"><tbody>`;
                
                DAYS.forEach((day, d) => {
                    TIME_SLOTS.forEach((slot, s) => {
                        const cid = config.schedule[d]?.[slot.id] || planData.extraClasses?.[d]?.[slot.id];
                        if (cid && slot.type !== 'break' && (!exportClassId || cid === exportClassId)) {
                            const data = planData[`${d}-${slot.id}`] || {};
                            const tasks = data.tasks || [];
                            const validTasks = tasks.filter(t => t.text.trim());
                            
                            let contentHtml = "";
                            if (data.status === 'zzz') {
                                const rao = data.zzzReason ? ` (${data.zzzReason})` : '';
                                contentHtml = `üí§ NO ES FA CLASSE${rao}`;
                            } else {
                                contentHtml = validTasks.map(t => {
                                    let style = "margin-bottom: 4px;";
                                    let prefix = "";
                                    if(t.status === 'skipped') style += "text-decoration:line-through;color:#DC2626;font-style:italic;";
                                    if(t.status === 'unfinished') style += "text-decoration:underline;text-decoration-color:#DC2626;font-weight:600;color:#b91c1c;";
                                    
                                    if(t.tag === 'skipped') prefix = "üî¥ ";
                                    if(t.tag === 'unfinished') prefix = "‚ö†Ô∏è ";

                                    const timeStr = t.time ? `<span style="color:#DC2626;font-weight:bold;">${t.time}'</span> ` : "";
                                    return `<div style="${style}">‚Ä¢ ${prefix}${timeStr}${t.text}</div>`;
                                }).join('');
                                if (data.review) contentHtml += `<div style="color:#DC2626; margin-top: 4px; font-weight: bold;">[REV: ${data.review}]</div>`;
                            }

                            if (contentHtml || validTasks.length > 0 || data.notes || data.materials) {
                                const linksHtml = data.links && data.links.length > 0 ? `<div style="margin-top: 6px;"><b>Enlla√ßos:</b><br>` + data.links.map(l => {
                                    const url = typeof l === 'string' ? l : l.url;
                                    const title = typeof l === 'string' ? l : (l.title || l.url);
                                    return `<a href="${url}" target="_blank" style="color:#2563EB;text-decoration:underline;">${title}</a>`;
                                }).join('<br>') + `</div>` : '';
                                
                                html += `<tr style="border-bottom: 1px solid #E5E7EB;">
                                    <td style="padding:12px; vertical-align:top; border-right: 1px solid #E5E7EB; width: 40%;">${contentHtml}</td>
                                    <td style="padding:12px; vertical-align:top; border-right: 1px solid #E5E7EB; width: 30%;">${data.materials ? data.materials.replace(/\n/g, '<br>') : ''}${linksHtml}</td>
                                    <td style="padding:12px; font-style:italic; vertical-align:top; width: 30%; color: #4B5563;">${data.notes ? data.notes.replace(/\n/g, '<br>') : ''}</td>
                                </tr>`;
                            }
                        }
                    });
                });
                
                if (!onlyRows) html += `</tbody></table>`;
                return html;
            };

            const handleExportToProgramacio = () => {
                const htmlRows = generateHTML(true); 
                const payload = {
                    action: 'SYNC_TABLE',
                    curs: exportConfig.curs.trim(),
                    ut: exportConfig.ut.trim(),
                    fase: exportConfig.fase,
                    html: htmlRows,
                    mode: 'append',
                    timestamp: Date.now()
                };
                localStorage.setItem('cfn_sync_payload', JSON.stringify(payload));
                window.open('https://marcpcasals.github.io/MarcBook/Altres/programador.html', '_blank');
                setShowExportModal(false);
            };

            const visibleSlots = TIME_SLOTS.filter((slot, index) => {
                if (slot.type === 'break') return false; 
                
                const hasAnySchedule = viewDays.some((_, d) => TIME_SLOTS.some(s => config.schedule[d]?.[s.id] || planData.extraClasses?.[d]?.[s.id]));
                if (!hasAnySchedule) return true;
                
                const hasClass = viewDays.some((_, d) => config.schedule[d]?.[slot.id] || planData.extraClasses?.[d]?.[slot.id]);
                if (hasClass) return true;

                const prevSlotIndex = slot.id - 1;
                if (prevSlotIndex >= 0) {
                    const prevSlot = TIME_SLOTS[prevSlotIndex];
                    if (prevSlot && prevSlot.type === 'class') {
                         const isCovered = viewDays.some((_, d) => config.durations?.[`${d}-${prevSlot.id}`] === 2);
                         if (isCovered) return true;
                    }
                }
                
                return false;
            });

            return (
                <div className="max-w-full mx-auto p-4 fade-in pb-20">
                    <div className="sticky top-0 z-40 bg-white/95 backdrop-blur shadow-md p-3 rounded-xl border border-gray-200 mb-4 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <button onClick={() => { onBack(); }} className="p-2 hover:bg-gray-100 rounded-full text-gray-600"><Icons.ChevronLeft /></button>
                            <h2 className="font-bold text-gray-800">Planificador {config.schoolYear}</h2>
                        </div>
                        <button onClick={handleUndo} className={`bg-gray-100 text-gray-600 px-3 py-1 rounded text-sm hover:bg-gray-200 border border-gray-300 font-medium ${history.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}`} disabled={history.length === 0} title="Desfer √∫ltima acci√≥"><Icons.Undo /></button>
                        <button onClick={handleRedo} className={`bg-gray-100 text-gray-600 px-3 py-1 rounded text-sm hover:bg-gray-200 border border-gray-300 font-medium ${future.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}`} disabled={future.length === 0} title="Refer √∫ltima acci√≥ desfeta"><Icons.Redo /></button>
                        <button onClick={() => setShowAddClassModal(true)} className="bg-gray-100 text-gray-600 px-3 py-1 rounded text-sm hover:bg-gray-200 border border-gray-300 font-medium">+ Afegir classe extra</button>
                        <div className="flex gap-2">
                            <button onClick={() => setShowWeekends(!showWeekends)} className={`px-3 py-1 rounded-lg text-sm border font-medium transition-colors ${showWeekends ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-white text-gray-600 hover:bg-gray-50'}`}>
                                {showWeekends ? 'Amagar Cap de Setmana' : 'Mostrar Cap de Setmana'}
                            </button>
                            <button onClick={() => setReviewMode(!reviewMode)} className={`px-3 py-1 rounded-lg font-bold border flex gap-1 items-center transition-colors ${reviewMode ? 'bg-red-50 text-red-600 border-red-200 shadow-inner' : 'bg-white text-gray-600 hover:bg-gray-50'}`}>
                                {reviewMode ? <Icons.AlertTriangle /> : <Icons.Settings />} {reviewMode ? 'MODE REVISI√ì' : 'Revisar'}
                            </button>
                            <button onClick={() => setShowExportModal(true)} className={`bg-${theme}-600 text-white px-4 py-1 rounded-lg font-bold flex items-center gap-2 hover:bg-${theme}-700 shadow-md`}><Icons.Table /> Exportar</button>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow border border-gray-200 overflow-auto h-[calc(100vh-140px)] custom-scroll relative">
                        <div className={`min-w-[1200px] grid`} style={{ gridTemplateColumns: `6rem repeat(${viewDays.length}, minmax(0, 1fr))` }}>
                            {/* Cantonada superior esquerra fixada */}
                            <div className="sticky top-0 left-0 z-30 p-3 border-r border-b border-gray-200 bg-gray-100 text-gray-700 font-bold text-center uppercase text-sm tracking-wider flex items-center justify-center">Hores</div>
                            
                            {/* Fila de dies fixada a dalt */}
                            {viewDays.map((d, i) => {
                                const dateStr = addDays(weekId, i);
                                const hasReminder = reminders && reminders[dateStr] && reminders[dateStr].length > 0;
                                return (
                                    <div key={i} className="sticky top-0 z-20 p-3 border-r border-b border-gray-200 bg-gray-50 text-gray-700 font-bold text-center uppercase text-sm tracking-wider flex justify-center items-center gap-2 group">
                                        {d} {parseInt(dateStr.split('-')[2])}
                                        <button 
                                            onClick={() => setActiveDayNotepad({ dayIndex: i })}
                                            className={`text-gray-400 hover:text-${theme}-600 transition-colors`}
                                            title="Bloc de Notes del Dia"
                                        >
                                            <Icons.FileText size={16}/>
                                        </button>
                                        <button 
                                            onClick={() => setActiveReminderModal({ dateStr: dateStr, dayName: d })}
                                            className={`${hasReminder ? 'text-yellow-500 animate-pulse' : 'text-gray-300 hover:text-yellow-400'} transition-colors`}
                                            title="Recordatoris"
                                        >
                                            <Icons.Lightbulb size={16}/>
                                        </button>
                                    </div>
                                );
                            })}
                            
                            {visibleSlots.map((slot, visibleIndex) => (
                                <React.Fragment key={slot.id}>
                                    {/* Columna d'hores fixada a l'esquerra */}
                                    <div className="sticky left-0 z-10 p-2 border-r border-b border-gray-200 bg-gray-50 text-xs font-mono font-bold flex items-center justify-center text-gray-500 min-h-[160px]">{slot.label}</div>
                                    
                                    {/* Cel¬∑les */}
                                    {viewDays.map((_, d) => {
                                        const prevSlot = visibleSlots[visibleIndex - 1];
                                        const isSequential = prevSlot && (slot.id === prevSlot.id + 1);
                                        const prevKey = prevSlot ? `${d}-${prevSlot.id}` : null;
                                        const isCovered = isSequential && config.durations?.[prevKey] === 2;

                                        if (isCovered) return null;

                                        const globalClassId = config.schedule[d]?.[slot.id];
                                        const extraClassId = planData.extraClasses?.[d]?.[slot.id];
                                        const cid = globalClassId || extraClassId;
                                        const isExtraClass = !!extraClassId;
                                        
                                        // Comprovaci√≥ de si la classe ja ha passat
                                        const now = new Date();
                                        const dateStr = addDays(weekId, d);
                                        const [y, m, day] = dateStr.split('-');
                                        const cellEndTime = new Date(y, m - 1, day, slot.endH, slot.endM, 0);
                                        const isPast = now > cellEndTime;

                                        if (!cid && !isExtraClass && d > 4) {
                                            // Cap de setmana sense classe extra assignada: permetre escriure text pla
                                            const key = `${d}-${slot.id}`;
                                            const data = planData[key] || {};
                                            const tasks = getTasks(d, slot.id);
                                            return (
                                                <div key={d} className={`border-r border-b border-gray-100 p-2 flex flex-col gap-1 relative group transition-colors ${isPast ? 'bg-gray-100 opacity-60' : 'bg-white hover:bg-gray-50/50'}`}>
                                                    <div className="text-xs font-bold text-gray-400 mb-1 text-center italic">Temps lliure</div>
                                                    <div className="flex-1 overflow-y-auto custom-scroll">
                                                        <TaskListInput tasks={tasks} onChange={(t) => handleTasksChange(d, slot.id, t)} onAction={(task, action) => handleTaskAction(d, slot.id, cid, task, action)} disabled={false} theme={theme} />
                                                    </div>
                                                </div>
                                            );
                                        }

                                        if (!cid) return <div key={d} className={`border-r border-b border-gray-100 ${isPast ? 'bg-gray-100 opacity-60' : 'bg-gray-50/30'}`}></div>;
                                        
                                        const cinfo = config.classes.find(c => c.id === cid) || { name: "Extra", color: "bg-gray-100 text-gray-800 border-gray-300" };
                                        const key = `${d}-${slot.id}`;
                                        const data = planData[key] || {};
                                        const isZzz = data.status === 'zzz';
                                        const tasks = getTasks(d, slot.id);
                                        const totalTime = getTotalTime(d, slot.id);
                                        const is2h = config.durations?.[key] === 2 && !isExtraClass;
                                        const hasContent = data.materials?.trim() || data.notes?.trim() || data.links?.length > 0;

                                        let cellBgClass = isZzz ? 'session-cancelled' : `bg-white hover:bg-${theme}-50/10`;
                                        if (isPast && !isZzz) cellBgClass += ' bg-gray-100 opacity-60'; // Efecte de passat

                                        return (
                                            <div key={d} style={is2h ? { gridRow: 'span 2' } : {}} className={`border-r border-b border-gray-100 p-2 flex flex-col gap-1 relative group transition-all ${cellBgClass}`}>
                                                <div className={`flex justify-between items-center px-2 py-1.5 rounded text-xs font-bold mb-1 shadow-sm ${cinfo.color} ${isZzz ? 'opacity-50 grayscale' : ''}`}>
                                                    <div className="flex items-center gap-1 overflow-hidden">
                                                        <span className="truncate">{cinfo.name} {is2h && "(2h)"}</span>
                                                        {isExtraClass && (
                                                            <button onClick={() => handleRemoveExtraClass(d, slot.id)} className="ml-1 text-red-500 hover:text-red-700" title="Eliminar classe extra puntual"><Icons.XCircle size={12}/></button>
                                                        )}
                                                        <button 
                                                            onClick={() => setActiveSessionNotepad({dayIndex: d, slotId: slot.id, className: cinfo.name, slotLabel: slot.label})} 
                                                            className={`p-0.5 rounded ml-1 transition-colors ${hasContent ? 'text-orange-500 hover:bg-orange-50' : 'text-inherit hover:bg-black/10'}`} 
                                                            title={hasContent ? "Notes (amb contingut)" : "Notes de sessi√≥"}
                                                        >
                                                            <Icons.FileText size={12}/>
                                                        </button>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <button onClick={() => setActiveSmartPaste({day: d, slot: slot.id})} className="p-0.5 rounded hover:bg-white/20 text-gray-700 transition-colors" title="Enganxar des de text"><Icons.Paste size={14}/></button>
                                                        <button onClick={() => openCopyModal(d, slot.id, cid)} className="p-0.5 rounded hover:bg-white/20 text-gray-700 transition-colors" title="Copiar"><Icons.Copy size={14}/></button>
                                                        <button onClick={() => { if(isZzz) { handleStatusChange(d, slot.id, null); } else { handleZzzAction(d, slot.id, cid); } }} className={`p-0.5 rounded hover:bg-white/20 transition-colors reactivate-btn ${isZzz ? 'text-gray-800' : ''}`} title={isZzz ? "Reactivar" : "No fer classe"}><Icons.Moon size={14}/></button>
                                                        <span className="bg-white/90 px-1.5 rounded text-[10px] min-w-[24px] text-center font-mono font-bold text-gray-700">{totalTime}'</span>
                                                    </div>
                                                </div>
                                                <div className={`flex-1 overflow-y-auto custom-scroll ${reviewMode ? 'opacity-50 pointer-events-none' : ''}`}>
                                                    {isZzz ? (
                                                        <div className="flex-1 flex items-center justify-center p-2 h-full">
                                                            <textarea
                                                                className="w-full h-full min-h-[80px] bg-transparent border-none resize-none text-center text-sm font-bold text-gray-600 focus:ring-0 focus:outline-none placeholder-gray-500"
                                                                style={{ pointerEvents: 'auto' }}
                                                                placeholder="Motiu (ex: Excursi√≥)"
                                                                value={data.zzzReason || ""}
                                                                onChange={(e) => {
                                                                    const newData = { ...planData, [key]: { ...planData[key], zzzReason: e.target.value } };
                                                                    setPlanData(newData); 
                                                                }}
                                                                onBlur={(e) => {
                                                                    const newData = { ...planData, [key]: { ...planData[key], zzzReason: e.target.value } };
                                                                    updatePlanData(newData, true); 
                                                                }}
                                                            />
                                                        </div>
                                                    ) : (
                                                        <TaskListInput tasks={tasks} onChange={(t) => handleTasksChange(d, slot.id, t)} onAction={(task, action) => handleTaskAction(d, slot.id, cid, task, action)} disabled={isZzz} theme={theme} />
                                                    )}
                                                </div>
                                                {(reviewMode || data.review) && (
                                                    <textarea className="w-full text-sm p-1 border border-red-300 bg-red-50 text-red-800 rounded mt-1 resize-none h-16 shadow-inner" placeholder="Revisi√≥..." value={data.review||""} onChange={(e)=>handleReviewChange(d,slot.id,e.target.value)}></textarea>
                                                )}
                                            </div>
                                        );
                                    })}
                                </React.Fragment>
                            ))}
                        </div>
                    </div>

                    {/* BLOC DE NOTES LATERAL (PORTAL) */}
                    {activeDayNotepad && ReactDOM.createPortal(
                        <div className="fixed inset-0 z-[9999]" onClick={() => setActiveDayNotepad(null)}>
                            <div className="absolute inset-0 bg-black/10 backdrop-blur-[1px]"></div>
                            <div onClick={(e) => e.stopPropagation()}>
                                <DailyNotepadModal 
                                    dayIndex={activeDayNotepad.dayIndex}
                                    dayName={viewDays[activeDayNotepad.dayIndex]}
                                    config={config}
                                    planData={planData}
                                    extraClasses={planData.extraClasses}
                                    onClose={() => setActiveDayNotepad(null)}
                                    onSave={handleDailyNotepadSave}
                                />
                            </div>
                        </div>,
                        document.body
                    )}

                    {/* SESSION NOTEPAD MODAL (PORTAL) */}
                    {activeSessionNotepad && ReactDOM.createPortal(
                        <SessionNotepadModal 
                            dayIndex={activeSessionNotepad.dayIndex}
                            slotId={activeSessionNotepad.slotId}
                            className={activeSessionNotepad.className}
                            slotLabel={activeSessionNotepad.slotLabel}
                            planData={planData}
                            onClose={() => setActiveSessionNotepad(null)}
                            onSave={handleSessionNotepadSave}
                        />,
                        document.body
                    )}

                    {/* SMART PASTE MODAL (PORTAL) */}
                    {activeSmartPaste && ReactDOM.createPortal(
                        <SmartPasteModal 
                            onPaste={handleSmartPaste}
                            onClose={() => setActiveSmartPaste(null)}
                        />,
                        document.body
                    )}

                    {/* REMINDER MODAL (PORTAL) */}
                    {activeReminderModal && ReactDOM.createPortal(
                        <ReminderModal 
                            dateStr={activeReminderModal.dateStr}
                            dayName={activeReminderModal.dayName}
                            reminders={reminders[activeReminderModal.dateStr]}
                            onSave={onSaveReminder}
                            onClose={() => setActiveReminderModal(null)}
                        />,
                        document.body
                    )}

                    {showExportModal && ReactDOM.createPortal(
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 fade-in">
                            <div className={`bg-white p-6 rounded-xl max-w-2xl w-full m-4 shadow-2xl border-t-4 border-${theme}-500`}>
                                <h3 className="text-xl font-bold mb-4 flex gap-2 text-gray-800"><Icons.Table /> Exportar Dades</h3>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-bold text-gray-700 mb-2">1. Selecciona la classe per filtrar les dades:</label>
                                    <select className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" value={exportClassId} onChange={(e) => setExportClassId(e.target.value)}>
                                        <option value="">-- Totes les classes --</option>
                                        {config.classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                    </select>
                                </div>
                                
                                <div className="flex justify-end mb-6">
                                    <button onClick={() => { const el = document.createElement('div'); el.innerHTML = generateHTML(false); document.body.appendChild(el); window.getSelection().selectAllChildren(el); document.execCommand('copy'); document.body.removeChild(el); alert("Taula copiada al portapapers!"); }} className={`px-4 py-2 bg-gray-100 text-gray-700 rounded font-bold hover:bg-gray-200 shadow-sm border border-gray-300`}>Copiar nom√©s al portapapers</button>
                                </div>

                                <hr className="border-gray-200 mb-6"/>

                                <div className="p-5 bg-blue-50 border border-blue-200 rounded-xl mb-4">
                                    <h4 className="font-bold text-blue-800 mb-2 flex items-center gap-2"><Icons.Link size={18} /> 2. Sincronitzar amb Programaci√≥ Docent</h4>
                                    <p className="text-xs text-blue-600 mb-4">L'artefacte de programaci√≥ s'obrir√† i la taula s'enganxar√† autom√†ticament on indiquis a continuaci√≥.</p>
                                    
                                    <div className="flex gap-4 mb-4">
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-blue-700 mb-1 uppercase tracking-wide">Curs / Pestanya</label>
                                            <input type="text" placeholder="Ex: 2n ESO" className="w-full p-2 border border-blue-300 rounded shadow-inner text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" value={exportConfig.curs} onChange={e=>setExportConfig({...exportConfig, curs: e.target.value})} />
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-blue-700 mb-1 uppercase tracking-wide">UT</label>
                                            <input type="text" placeholder="Ex: UT1" className="w-full p-2 border border-blue-300 rounded shadow-inner text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" value={exportConfig.ut} onChange={e=>setExportConfig({...exportConfig, ut: e.target.value})} />
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-blue-700 mb-1 uppercase tracking-wide">Fase</label>
                                            <select className="w-full p-2 border border-blue-300 rounded shadow-inner text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" value={exportConfig.fase} onChange={e=>setExportConfig({...exportConfig, fase: e.target.value})}>
                                                <option value="FASE DE PREPARACI√ì">FASE DE PREPARACI√ì</option>
                                                <option value="FASE DE RESOLUCI√ì">FASE DE RESOLUCI√ì</option>
                                                <option value="FASE D'INTEGRACI√ì">FASE D'INTEGRACI√ì</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button onClick={handleExportToProgramacio} disabled={!exportConfig.curs || !exportConfig.ut || !exportConfig.fase} className="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-bold text-lg hover:bg-blue-700 disabled:opacity-50 transition-colors shadow-md flex items-center justify-center gap-2">
                                        Exportar a la meva Programaci√≥ <Icons.ArrowRight size={20}/>
                                    </button>
                                </div>

                                <div className="flex justify-end gap-2 mt-2">
                                    <button onClick={() => setShowExportModal(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Cancel¬∑lar i Tancar</button>
                                </div>
                            </div>
                        </div>,
                        document.body
                    )}
                    
                    {/* Modal Opcions Apla√ßar (PORTAL) */}
                    {pendingActionTask && ReactDOM.createPortal(
                        <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-50 fade-in">
                            <div className="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                                <h3 className="text-lg font-bold mb-4">Qu√® ha passat amb l'activitat?</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => executePendingAction('skipped')} className="p-4 bg-red-50 text-red-700 border border-red-200 rounded hover:bg-red-100 font-bold flex flex-col items-center">
                                        <span className="text-2xl mb-2">‚ùå</span>
                                        No feta
                                        <span className="text-xs font-normal mt-1 text-center">(Es tatxa i es mou a la propera amb icona üî¥)</span>
                                    </button>
                                    <button onClick={() => executePendingAction('unfinished')} className="p-4 bg-orange-50 text-orange-700 border border-orange-200 rounded hover:bg-orange-100 font-bold flex flex-col items-center">
                                        <span className="text-2xl mb-2">üöß</span>
                                        Inacabada
                                        <span className="text-xs font-normal mt-1 text-center">(Es subratlla i es mou a la propera amb icona ‚ö†Ô∏è)</span>
                                    </button>
                                </div>
                                <button onClick={() => setPendingActionTask(null)} className="mt-4 w-full py-2 text-gray-500 hover:bg-gray-100 rounded">Cancel¬∑lar</button>
                            </div>
                        </div>,
                        document.body
                    )}

                    {showCopyModal && copySource && ReactDOM.createPortal(
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 fade-in">
                            <div className="bg-white p-6 rounded-xl max-w-md w-full shadow-2xl border-t-4 border-blue-500">
                                <h3 className="text-xl font-bold mb-4 flex gap-2 text-blue-800"><Icons.Copy /> Copiar Sessi√≥</h3>
                                <div className="space-y-3">
                                    <button onClick={() => executeCopy('next_same')} className="w-full text-left px-4 py-3 bg-blue-50 hover:bg-blue-100 rounded border border-blue-200 font-semibold text-blue-800 transition-colors">1. Enganxar a la propera sessi√≥ d'aquest grup</button>
                                    <div className="bg-gray-50 p-3 rounded border border-gray-200">
                                        <p className="text-xs font-bold text-gray-500 mb-2 uppercase">2. Enganxar a propera sessi√≥ de:</p>
                                        <div className="flex gap-2">
                                            <select className="flex-1 p-2 border rounded text-sm" value={targetClassId} onChange={(e) => setTargetClassId(e.target.value)}><option value="">Selecciona grup...</option>{config.classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select>
                                            <button onClick={() => executeCopy('next_other')} className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Enganxar</button>
                                        </div>
                                    </div>
                                    <div className="bg-gray-50 p-3 rounded border border-gray-200">
                                        <p className="text-xs font-bold text-gray-500 mb-2 uppercase">3. Enganxar manualment a:</p>
                                        <div className="flex gap-2 mb-2">
                                            <select className="flex-1 p-2 border rounded text-sm" value={targetDay} onChange={(e) => setTargetDay(parseInt(e.target.value))}>{viewDays.map((d, i) => <option key={i} value={i}>{d}</option>)}</select>
                                            <select className="flex-1 p-2 border rounded text-sm" value={targetSlot} onChange={(e) => setTargetSlot(parseInt(e.target.value))}>{TIME_SLOTS.filter(s => s.type !== 'break').map(s => <option key={s.id} value={s.id}>{s.label}</option>)}</select>
                                        </div>
                                        <button onClick={() => executeCopy('manual')} className="w-full px-3 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700">Enganxar Aqu√≠</button>
                                    </div>
                                </div>
                                <div className="flex justify-end gap-2 mt-4"><button onClick={() => setShowCopyModal(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Cancel¬∑lar</button></div>
                            </div>
                        </div>,
                        document.body
                    )}

                    {showAddClassModal && ReactDOM.createPortal(
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 fade-in">
                            <div className="bg-white p-6 rounded-xl max-w-sm w-full shadow-2xl">
                                <h3 className="text-lg font-bold text-gray-800 mb-4">Afegir Classe Extra Puntual</h3>
                                <div className="space-y-3">
                                    <div><label className="text-xs font-bold text-gray-500 uppercase">Dia</label><select className="w-full border p-2 rounded" value={newExtra.day} onChange={(e) => setNewExtra({...newExtra, day: parseInt(e.target.value)})}>{viewDays.map((d, i) => <option key={i} value={i}>{d}</option>)}</select></div>
                                    <div><label className="text-xs font-bold text-gray-500 uppercase">Hora</label><select className="w-full border p-2 rounded" value={newExtra.slot} onChange={(e) => setNewExtra({...newExtra, slot: parseInt(e.target.value)})}>{TIME_SLOTS.filter(s => s.type !== 'break').map(s => <option key={s.id} value={s.id}>{s.label}</option>)}</select></div>
                                    <div><label className="text-xs font-bold text-gray-500 uppercase">Classe</label><select className="w-full border p-2 rounded" value={newExtra.classId} onChange={(e) => setNewExtra({...newExtra, classId: e.target.value})}><option value="">Selecciona grup...</option>{config.classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                                </div>
                                <div className="flex justify-end gap-2 mt-6"><button onClick={() => setShowAddClassModal(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Cancel¬∑lar</button><button onClick={handleAddExtraClass} disabled={!newExtra.classId} className="px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 disabled:opacity-50">Afegir per aquesta setmana</button></div>
                            </div>
                        </div>,
                        document.body
                    )}
                </div>
            );
        };

        const ClassPlannerScreen = ({ classId, config, weeksData, allWeeks, holidayWeeks, onUpdateWeekData, onBack, onAddToRadar }) => {
            const classInfo = config.classes.find(c => c.id === classId);
            const theme = config.theme || 'orange';

            const [history, setHistory] = useState([]);
            const [future, setFuture] = useState([]);
            const [reviewMode, setReviewMode] = useState(false);
            const [showExportModal, setShowExportModal] = useState(false);
            const [exportConfig, setExportConfig] = useState({ curs: classInfo ? classInfo.name : "", ut: "", fase: "FASE DE PREPARACI√ì" });
            const [selectedUTId, setSelectedUTId] = useState("");

            const [pendingActionTask, setPendingActionTask] = useState(null);
            const [activeSessionNotepad, setActiveSessionNotepad] = useState(null);
            const [activeSmartPaste, setActiveSmartPaste] = useState(null);
            const [showCopyModal, setShowCopyModal] = useState(false);
            const [copySource, setCopySource] = useState(null);
            const [targetClassId, setTargetClassId] = useState("");
            const [targetDay, setTargetDay] = useState(0);
            const [targetSlot, setTargetSlot] = useState(0);

            // Compute current UT context
            const utList = useMemo(() => {
                return [...(config.utDates || [])].sort((a,b) => new Date(a.date) - new Date(b.date));
            }, [config.utDates]);

            useEffect(() => {
                if (utList.length > 0 && !selectedUTId) {
                    const now = new Date();
                    const nextUT = utList.find(ut => new Date(ut.date) >= now);
                    setSelectedUTId(nextUT ? nextUT.id : utList[utList.length - 1].id);
                }
            }, [utList]);

            const currentUT = useMemo(() => utList.find(ut => ut.id === selectedUTId), [utList, selectedUTId]);

            // All sessions globally for this class
            const allClassSessions = useMemo(() => {
                let counter = 1;
                const sessions = [];
                allWeeks.forEach(w => {
                    const wData = weeksData[w.id] || {};
                    const isHoliday = holidayWeeks?.includes(w.id);
                    
                    for (let d = 0; d < 5; d++) {
                        for (let s = 0; s < TIME_SLOTS.length; s++) {
                            const slot = TIME_SLOTS[s];
                            if (slot.type === 'break') continue;
                            
                            const isGlobal = config.schedule[d]?.[slot.id] === classId;
                            const isExtra = wData.extraClasses?.[d]?.[slot.id] === classId;
                            
                            if (isGlobal || isExtra) {
                                const prevSlot = TIME_SLOTS[s - 1];
                                const isCovered = prevSlot && !isExtra && config.durations?.[`${d}-${prevSlot.id}`] === 2 && config.schedule[d]?.[prevSlot.id] === classId;
                                if (isCovered) continue;

                                const dateStr = addDays(w.id, d);
                                const cellData = wData[`${d}-${slot.id}`] || {};
                                const isZzz = cellData.status === 'zzz';
                                
                                let sessionNumber = null;
                                if (!isHoliday && !isZzz) {
                                    sessionNumber = counter++;
                                }

                                const now = new Date();
                                const [y, m, day] = dateStr.split('-');
                                const cellEndTime = new Date(y, m - 1, day, slot.endH, slot.endM, 0);
                                const isPast = now > cellEndTime;

                                sessions.push({
                                    weekId: w.id,
                                    weekLabel: w.label,
                                    dayIndex: d,
                                    slot: slot,
                                    dateStr: dateStr,
                                    sessionNumber: sessionNumber,
                                    isHoliday: isHoliday,
                                    isZzz: isZzz,
                                    isExtra: isExtra,
                                    isPast: isPast,
                                    data: cellData
                                });
                            }
                        }
                    }
                });
                return sessions;
            }, [allWeeks, weeksData, config, holidayWeeks, classId]);

            // Filter weeks to show based on selected UT
            const visibleWeeks = useMemo(() => {
                if (!currentUT) return allWeeks;
                const currentIdx = utList.findIndex(ut => ut.id === currentUT.id);
                const prevUT = currentIdx > 0 ? utList[currentIdx - 1] : null;
                
                const start = prevUT ? new Date(prevUT.date) : new Date(config.schoolYear, 8, 1);
                const end = new Date(currentUT.date);
                end.setHours(23, 59, 59, 999);

                return allWeeks.filter(w => {
                    const wStart = new Date(w.startDate);
                    const wEnd = new Date(w.endDate);
                    return wEnd >= start && wStart <= end;
                });
            }, [allWeeks, currentUT, utList, config.schoolYear]);

            const updatePlanData = (wId, newData, saveToHistory = true) => {
                if (saveToHistory) {
                    setHistory(prev => [...prev, weeksData]);
                    setFuture([]); 
                }
                onUpdateWeekData(wId, newData);
            };

            const handleUndo = () => {
                if (history.length === 0) return;
                const previous = history[history.length - 1];
                const newHistory = history.slice(0, -1);
                setFuture(prev => [weeksData, ...prev]); 
                setHistory(newHistory);
                // Requires restoring full weeksData, but we can only update one by one or need a global state setter
                // For simplicity in this local scope, we'll restore all weeks that changed
                Object.keys(previous).forEach(wId => {
                    if (JSON.stringify(previous[wId]) !== JSON.stringify(weeksData[wId])) {
                        onUpdateWeekData(wId, previous[wId]);
                    }
                });
            };

            const handleRedo = () => {
                if (future.length === 0) return;
                const next = future[0];
                const newFuture = future.slice(1);
                setHistory(prev => [...prev, weeksData]); 
                setFuture(newFuture);
                Object.keys(next).forEach(wId => {
                    if (JSON.stringify(next[wId]) !== JSON.stringify(weeksData[wId])) {
                        onUpdateWeekData(wId, next[wId]);
                    }
                });
            };

            const getTasks = (wId, d, s) => {
                const wData = weeksData[wId] || {};
                const k = `${d}-${s}`;
                const existing = wData[k]?.tasks;
                if (existing && Array.isArray(existing) && existing.length > 0) return existing;
                return [{ text: '', time: '', status: null }, { text: '', time: '', status: null }, { text: '', time: '', status: null }];
            };

            const getTotalTime = (wId, d, s) => {
                const tasks = getTasks(wId, d, s);
                return tasks.reduce((acc, t) => acc + (parseInt(t.time) || 0), 0);
            };

            const handleTasksChange = (wId, d, s, newTasks) => {
                const wData = { ...(weeksData[wId] || {}) };
                wData[`${d}-${s}`] = { ...wData[`${d}-${s}`], tasks: newTasks };
                updatePlanData(wId, wData);
            };

            const handleReviewChange = (wId, d, s, val) => {
                const wData = { ...(weeksData[wId] || {}) };
                wData[`${d}-${s}`] = { ...wData[`${d}-${s}`], review: val };
                updatePlanData(wId, wData);
            };

            const handleStatusChange = (wId, d, s, val) => {
                const wData = { ...(weeksData[wId] || {}) };
                wData[`${d}-${s}`] = { ...wData[`${d}-${s}`], status: val };
                if (val === null) {
                    wData[`${d}-${s}`].zzzReason = "";
                }
                updatePlanData(wId, wData);
            };

            const handleSessionNotepadSave = (wId, dayIndex, slotId, data) => {
                const wData = { ...(weeksData[wId] || {}) };
                const k = `${dayIndex}-${slotId}`;
                wData[k] = { ...wData[k], notes: data.notes, materials: data.materials, links: data.links };
                updatePlanData(wId, wData);
            };

            const handleSmartPaste = (tasks) => {
                if (!activeSmartPaste) return;
                const { wId, day, slot } = activeSmartPaste;
                const currentTasks = getTasks(wId, day, slot).filter(t => t.text.trim() !== '');
                const combinedTasks = [...currentTasks, ...tasks];
                while(combinedTasks.length < 3) combinedTasks.push({text: "", time: "", status: null});
                const wData = { ...(weeksData[wId] || {}) };
                wData[`${day}-${slot}`] = { ...(wData[`${day}-${slot}`] || {}), tasks: combinedTasks };
                updatePlanData(wId, wData);
            };

            const handleTaskAction = (wId, d, s, cid, task, action) => {
                if (action === 'save') {
                    onAddToRadar(task.text, d);
                    alert("Afegit al Radar!");
                } else if (action === 'alert_menu') {
                    const tasks = getTasks(wId, d, s);
                    const idx = tasks.findIndex(t => t === task);
                    setPendingActionTask({ wId, d, s, cid, idx, task });
                }
            };

            const executePendingAction = (type) => {
                if (!pendingActionTask) return;
                const { wId, d, s, idx, task } = pendingActionTask;
                const wData = { ...(weeksData[wId] || {}) };
                const sourceKey = `${d}-${s}`;
                const sourceTasks = getTasks(wId, d, s); 
                const newSourceTasks = [...sourceTasks];
                newSourceTasks[idx] = { ...newSourceTasks[idx], status: type }; 
                wData[sourceKey] = { ...(wData[sourceKey] || {}), tasks: newSourceTasks };

                // Find next session globally
                const currentIdx = allClassSessions.findIndex(sess => sess.weekId === wId && sess.dayIndex === d && sess.slot.id === s);
                let nextSession = null;
                for (let i = currentIdx + 1; i < allClassSessions.length; i++) {
                    if (!allClassSessions[i].isZzz && !allClassSessions[i].isHoliday) {
                        nextSession = allClassSessions[i];
                        break;
                    }
                }

                if(nextSession) {
                    const newTaskObj = { text: task.text, time: task.time, status: null, tag: type === 'skipped' ? 'skipped' : 'unfinished' };
                    if (nextSession.weekId === wId) {
                        const targetKey = `${nextSession.dayIndex}-${nextSession.slot.id}`;
                        const targetTasks = getTasks(wId, nextSession.dayIndex, nextSession.slot.id);
                        wData[targetKey] = { ...(wData[targetKey] || {}), tasks: [newTaskObj, ...targetTasks] };
                        updatePlanData(wId, wData);
                        alert(`Activitat moguda al proper dia d'aquesta setmana.`);
                    } else {
                        updatePlanData(wId, wData); // Save source week
                        const targetWData = { ...(weeksData[nextSession.weekId] || {}) };
                        const targetKey = `${nextSession.dayIndex}-${nextSession.slot.id}`;
                        const targetTasks = getTasks(nextSession.weekId, nextSession.dayIndex, nextSession.slot.id);
                        targetWData[targetKey] = { ...(targetWData[targetKey] || {}), tasks: [newTaskObj, ...targetTasks] };
                        onUpdateWeekData(nextSession.weekId, targetWData); // Save target week
                        alert(`Activitat moguda a la sessi√≥ del ${new Date(nextSession.dateStr).toLocaleDateString()}`);
                    }
                } else {
                    updatePlanData(wId, wData);
                    alert("No s'ha trobat cap altra sessi√≥ per moure l'activitat.");
                }
                setPendingActionTask(null);
            };

            const handleZzzAction = (wId, d, s) => {
                const currentTasks = getTasks(wId, d, s).filter(t => t.text.trim());
                const wData = { ...(weeksData[wId] || {}) };
                const currentKey = `${d}-${s}`;
                wData[currentKey] = { 
                    ...wData[currentKey], 
                    status: 'zzz', 
                    zzzReason: wData[currentKey]?.zzzReason || "", 
                    tasks: [{text: "", time: "", status: null}, {text: "", time: "", status: null}, {text: "", time: "", status: null}] 
                };

                if (currentTasks.length > 0) {
                    const currentIdx = allClassSessions.findIndex(sess => sess.weekId === wId && sess.dayIndex === d && sess.slot.id === s);
                    let nextSession = null;
                    for (let i = currentIdx + 1; i < allClassSessions.length; i++) {
                        if (!allClassSessions[i].isZzz && !allClassSessions[i].isHoliday) {
                            nextSession = allClassSessions[i];
                            break;
                        }
                    }

                    if (nextSession) {
                        const movedTasks = currentTasks.map(t => ({...t, text: `(Del ${DAYS[d]}) ${t.text}`, status: null}));
                        if (nextSession.weekId === wId) {
                            const targetKey = `${nextSession.dayIndex}-${nextSession.slot.id}`;
                            const targetTasks = getTasks(wId, nextSession.dayIndex, nextSession.slot.id);
                            wData[targetKey] = { ...(wData[targetKey] || {}), tasks: [...movedTasks, ...targetTasks] };
                            alert(`Classe cancel¬∑lada. Mogut al seg√ºent dia.`);
                        } else {
                            const targetWData = { ...(weeksData[nextSession.weekId] || {}) };
                            const targetKey = `${nextSession.dayIndex}-${nextSession.slot.id}`;
                            const targetTasks = getTasks(nextSession.weekId, nextSession.dayIndex, nextSession.slot.id);
                            targetWData[targetKey] = { ...(targetWData[targetKey] || {}), tasks: [...movedTasks, ...targetTasks] };
                            onUpdateWeekData(nextSession.weekId, targetWData);
                            alert(`Classe cancel¬∑lada. Mogut a la sessi√≥ del ${new Date(nextSession.dateStr).toLocaleDateString()}`);
                        }
                    } else {
                        alert("Zzz marcat (sense moure, no hi ha propera sessi√≥).");
                    }
                }
                updatePlanData(wId, wData);
            };

            const generateHTML = () => {
                let html = `<table style="width:100%; border-collapse:collapse; font-family:Arial, sans-serif;"><tbody>`;
                
                visibleWeeks.forEach(w => {
                    const sessions = allClassSessions.filter(sess => sess.weekId === w.id);
                    sessions.forEach(sess => {
                        if (sess.isHoliday) return;
                        const data = sess.data || {};
                        const tasks = data.tasks || [];
                        const validTasks = tasks.filter(t => t.text.trim());
                        
                        let contentHtml = "";
                        if (data.status === 'zzz') {
                            const rao = data.zzzReason ? ` (${data.zzzReason})` : '';
                            contentHtml = `üí§ NO ES FA CLASSE${rao}`;
                        } else {
                            contentHtml = validTasks.map(t => {
                                let style = "margin-bottom: 4px;";
                                let prefix = "";
                                if(t.status === 'skipped') style += "text-decoration:line-through;color:#DC2626;font-style:italic;";
                                if(t.status === 'unfinished') style += "text-decoration:underline;text-decoration-color:#DC2626;font-weight:600;color:#b91c1c;";
                                if(t.tag === 'skipped') prefix = "üî¥ ";
                                if(t.tag === 'unfinished') prefix = "‚ö†Ô∏è ";
                                const timeStr = t.time ? `<span style="color:#DC2626;font-weight:bold;">${t.time}'</span> ` : "";
                                return `<div style="${style}">‚Ä¢ ${prefix}${timeStr}${t.text}</div>`;
                            }).join('');
                            if (data.review) contentHtml += `<div style="color:#DC2626; margin-top: 4px; font-weight: bold;">[REV: ${data.review}]</div>`;
                        }

                        if (contentHtml || validTasks.length > 0 || data.notes || data.materials) {
                            const linksHtml = data.links && data.links.length > 0 ? `<div style="margin-top: 6px;"><b>Enlla√ßos:</b><br>` + data.links.map(l => {
                                const url = typeof l === 'string' ? l : l.url;
                                const title = typeof l === 'string' ? l : (l.title || l.url);
                                return `<a href="${url}" target="_blank" style="color:#2563EB;text-decoration:underline;">${title}</a>`;
                            }).join('<br>') + `</div>` : '';
                            
                            html += `<tr style="border-bottom: 1px solid #E5E7EB;">
                                <td style="padding:12px; vertical-align:top; border-right: 1px solid #E5E7EB; width: 40%;">${contentHtml}</td>
                                <td style="padding:12px; vertical-align:top; border-right: 1px solid #E5E7EB; width: 30%;">${data.materials ? data.materials.replace(/\n/g, '<br>') : ''}${linksHtml}</td>
                                <td style="padding:12px; font-style:italic; vertical-align:top; width: 30%; color: #4B5563;">${data.notes ? data.notes.replace(/\n/g, '<br>') : ''}</td>
                            </tr>`;
                        }
                    });
                });
                
                html += `</tbody></table>`;
                return html;
            };

            const handleExportToProgramacio = () => {
                const htmlRows = generateHTML();
                // Netejar el codi the `<table><tbody>` nom√©s per enviar les files
                const strippedRows = htmlRows.replace('<table style="width:100%; border-collapse:collapse; font-family:Arial, sans-serif;"><tbody>', '').replace('</tbody></table>', '');
                
                const payload = {
                    action: 'SYNC_TABLE',
                    curs: exportConfig.curs.trim(),
                    ut: exportConfig.ut.trim(),
                    fase: exportConfig.fase,
                    html: strippedRows,
                    mode: 'append',
                    timestamp: Date.now()
                };
                localStorage.setItem('cfn_sync_payload', JSON.stringify(payload));
                window.open('https://marcpcasals.github.io/MarcBook/Altres/programador.html', '_blank');
                setShowExportModal(false);
            };

            return (
                <div className="max-w-full mx-auto p-4 fade-in pb-20">
                    <div className="sticky top-0 z-40 bg-white/95 backdrop-blur shadow-md p-3 rounded-xl border border-gray-200 mb-4 flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <button onClick={() => { onBack(); }} className="p-2 hover:bg-gray-100 rounded-full text-gray-600"><Icons.ChevronLeft /></button>
                            <div>
                                <h2 className="font-bold text-gray-800 text-lg flex items-center gap-2">
                                    <div className={`w-3 h-3 rounded-full ${classInfo?.color.split(' ')[0]}`}></div>
                                    Programaci√≥: {classInfo?.name || 'Classe'}
                                </h2>
                            </div>
                            <div className="ml-4 flex items-center gap-2 border-l pl-4">
                                <span className="text-xs font-bold text-gray-500 uppercase">Filtrar per UT:</span>
                                <select 
                                    className="border p-1.5 rounded text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={selectedUTId}
                                    onChange={(e) => setSelectedUTId(e.target.value)}
                                >
                                    <option value="">Totes les setmanes</option>
                                    {utList.map(ut => <option key={ut.id} value={ut.id}>{ut.name}</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={handleUndo} className={`p-2 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 border border-gray-300 ${history.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}`} disabled={history.length === 0} title="Desfer √∫ltima acci√≥"><Icons.Undo size={16}/></button>
                            <button onClick={handleRedo} className={`p-2 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 border border-gray-300 ${future.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}`} disabled={future.length === 0} title="Refer √∫ltima acci√≥ desfeta"><Icons.Redo size={16}/></button>
                            <button onClick={() => setReviewMode(!reviewMode)} className={`px-3 py-1 rounded-lg font-bold border flex gap-1 items-center transition-colors ${reviewMode ? 'bg-red-50 text-red-600 border-red-200 shadow-inner' : 'bg-white text-gray-600 hover:bg-gray-50'}`}>
                                {reviewMode ? <Icons.AlertTriangle /> : <Icons.Settings />} {reviewMode ? 'MODE REVISI√ì' : 'Revisar'}
                            </button>
                            <button onClick={() => setShowExportModal(true)} className={`bg-${theme}-600 text-white px-4 py-1 rounded-lg font-bold flex items-center gap-2 hover:bg-${theme}-700 shadow-md`}><Icons.Table /> Exportar</button>
                        </div>
                    </div>

                    <div className="flex flex-col gap-4">
                        {visibleWeeks.map(w => {
                            const sessions = allClassSessions.filter(s => s.weekId === w.id);
                            if (sessions.length === 0) return null;
                            
                            return (
                                <div key={w.id} className="flex flex-col bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden fade-in">
                                    <div className="bg-gray-100 p-2 font-bold text-gray-700 text-sm border-b">
                                        {w.label} <span className="text-gray-500 font-normal">({w.startDate.toLocaleDateString()} - {w.endDate.toLocaleDateString()})</span>
                                    </div>
                                    <div className="flex overflow-x-auto p-3 gap-3 custom-scroll">
                                        {sessions.map(sess => {
                                            const isZzz = sess.isZzz;
                                            const isHoliday = sess.isHoliday;
                                            const tasks = getTasks(sess.weekId, sess.dayIndex, sess.slot.id);
                                            const totalTime = getTotalTime(sess.weekId, sess.dayIndex, sess.slot.id);
                                            const hasContent = sess.data.materials?.trim() || sess.data.notes?.trim() || sess.data.links?.length > 0;
                                            
                                            let cellBgClass = isZzz || isHoliday ? 'session-cancelled' : `bg-white hover:bg-${theme}-50/10`;
                                            if (sess.isPast && !isZzz && !isHoliday) cellBgClass += ' bg-gray-50 opacity-70';

                                            return (
                                                <div key={`${w.id}-${sess.dayIndex}-${sess.slot.id}`} className={`min-w-[300px] max-w-[320px] shrink-0 border border-gray-200 rounded-lg flex flex-col relative group transition-all ${cellBgClass} shadow-sm`}>
                                                    {/* Header de Sessi√≥ Espec√≠fic */}
                                                    <div className="bg-gray-50 border-b border-gray-200 px-3 py-1.5 flex justify-between items-center rounded-t-lg">
                                                        <span className={`text-xs font-extrabold uppercase ${sess.sessionNumber ? 'text-blue-700' : 'text-gray-400'}`}>
                                                            {sess.sessionNumber ? `Sessi√≥ ${sess.sessionNumber}` : (isHoliday ? 'Festiu üéâ' : 'No Lectiu')}
                                                        </span>
                                                        <span className="text-[10px] text-gray-500 font-mono font-bold">
                                                            {new Date(sess.dateStr).toLocaleDateString('ca-ES', {weekday: 'short', day:'numeric', month:'short'})} | {sess.slot.label.split(' - ')[0]}
                                                        </span>
                                                    </div>

                                                    {/* Contingut Estandard Cel¬∑la */}
                                                    <div className="p-2 flex-1 flex flex-col">
                                                        <div className={`flex justify-between items-center px-2 py-1.5 rounded text-xs font-bold mb-2 shadow-sm ${classInfo?.color || 'bg-gray-100'} ${isZzz || isHoliday ? 'opacity-50 grayscale' : ''}`}>
                                                            <div className="flex items-center gap-1 overflow-hidden">
                                                                <span className="truncate">{classInfo?.name}</span>
                                                                <button 
                                                                    onClick={() => setActiveSessionNotepad({weekId: sess.weekId, dayIndex: sess.dayIndex, slotId: sess.slot.id, className: classInfo?.name, slotLabel: sess.slot.label, data: sess.data})} 
                                                                    className={`p-0.5 rounded ml-1 transition-colors ${hasContent ? 'text-orange-500 hover:bg-orange-50' : 'text-inherit hover:bg-black/10'}`} 
                                                                    title={hasContent ? "Notes (amb contingut)" : "Notes de sessi√≥"}
                                                                >
                                                                    <Icons.FileText size={12}/>
                                                                </button>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <button onClick={() => setActiveSmartPaste({wId: sess.weekId, day: sess.dayIndex, slot: sess.slot.id})} className="p-0.5 rounded hover:bg-white/20 text-gray-700 transition-colors" title="Enganxar des de text"><Icons.Paste size={14}/></button>
                                                                {/* Copiar nom√©s per refer√®ncia (no obre modal aqu√≠ per complexitat, opcional afegir-ho) */}
                                                                <button onClick={() => { if(isZzz || isHoliday) { handleStatusChange(sess.weekId, sess.dayIndex, sess.slot.id, null); } else { handleZzzAction(sess.weekId, sess.dayIndex, sess.slot.id, classId); } }} className={`p-0.5 rounded hover:bg-white/20 transition-colors reactivate-btn ${isZzz || isHoliday ? 'text-gray-800' : ''}`} title={isZzz || isHoliday ? "Reactivar" : "No fer classe"}><Icons.Moon size={14}/></button>
                                                                <span className="bg-white/90 px-1.5 rounded text-[10px] min-w-[24px] text-center font-mono font-bold text-gray-700">{totalTime}'</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className={`flex-1 overflow-y-auto custom-scroll ${reviewMode ? 'opacity-50 pointer-events-none' : ''}`}>
                                                            {isZzz || isHoliday ? (
                                                                <div className="flex-1 flex items-center justify-center p-2 h-full">
                                                                    <textarea
                                                                        className="w-full h-full min-h-[60px] bg-transparent border-none resize-none text-center text-sm font-bold text-gray-600 focus:ring-0 focus:outline-none placeholder-gray-500"
                                                                        style={{ pointerEvents: 'auto' }}
                                                                        placeholder={isHoliday ? "Festiu" : "Motiu (ex: Excursi√≥)"}
                                                                        value={sess.data.zzzReason || (isHoliday ? 'Festiu üéâ' : '')}
                                                                        onChange={(e) => {
                                                                            const wData = { ...(weeksData[sess.weekId] || {}) };
                                                                            wData[`${sess.dayIndex}-${sess.slot.id}`] = { ...wData[`${sess.dayIndex}-${sess.slot.id}`], zzzReason: e.target.value };
                                                                            setWeeksData(prev => ({...prev, [sess.weekId]: wData}));
                                                                        }}
                                                                        onBlur={(e) => {
                                                                            const wData = { ...(weeksData[sess.weekId] || {}) };
                                                                            wData[`${sess.dayIndex}-${sess.slot.id}`] = { ...wData[`${sess.dayIndex}-${sess.slot.id}`], zzzReason: e.target.value };
                                                                            updatePlanData(sess.weekId, wData, true);
                                                                        }}
                                                                        disabled={isHoliday}
                                                                    />
                                                                </div>
                                                            ) : (
                                                                <TaskListInput tasks={tasks} onChange={(t) => handleTasksChange(sess.weekId, sess.dayIndex, sess.slot.id, t)} onAction={(task, action) => handleTaskAction(sess.weekId, sess.dayIndex, sess.slot.id, classId, task, action)} disabled={isZzz || isHoliday} theme={theme} />
                                                            )}
                                                        </div>
                                                        {(reviewMode || sess.data.review) && (
                                                            <textarea className="w-full text-sm p-1 border border-red-300 bg-red-50 text-red-800 rounded mt-1 resize-none h-16 shadow-inner" placeholder="Revisi√≥..." value={sess.data.review||""} onChange={(e)=>handleReviewChange(sess.weekId, sess.dayIndex, sess.slot.id, e.target.value)}></textarea>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                        {visibleWeeks.filter(w => allClassSessions.some(s => s.weekId === w.id)).length === 0 && (
                            <div className="text-center p-12 bg-gray-50 rounded-xl border border-dashed border-gray-300 text-gray-500">
                                No hi ha sessions programades per aquesta classe en la UT seleccionada.
                            </div>
                        )}
                    </div>

                    {/* MODALS REUTILITZATS */}
                    {activeSessionNotepad && ReactDOM.createPortal(
                        <SessionNotepadModal 
                            dayIndex={activeSessionNotepad.dayIndex}
                            slotId={activeSessionNotepad.slotId}
                            className={activeSessionNotepad.className}
                            slotLabel={activeSessionNotepad.slotLabel}
                            planData={weeksData[activeSessionNotepad.weekId] || {}}
                            onClose={() => setActiveSessionNotepad(null)}
                            onSave={(d, s, data) => handleSessionNotepadSave(activeSessionNotepad.weekId, d, s, data)}
                        />,
                        document.body
                    )}

                    {activeSmartPaste && ReactDOM.createPortal(
                        <SmartPasteModal 
                            onPaste={handleSmartPaste}
                            onClose={() => setActiveSmartPaste(null)}
                        />,
                        document.body
                    )}

                    {showExportModal && ReactDOM.createPortal(
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 fade-in">
                            <div className={`bg-white p-6 rounded-xl max-w-2xl w-full m-4 shadow-2xl border-t-4 border-${theme}-500`}>
                                <h3 className="text-xl font-bold mb-6 flex gap-2 text-gray-800"><Icons.Table /> Exportar Programaci√≥: {classInfo?.name}</h3>
                                
                                <div className="p-5 bg-blue-50 border border-blue-200 rounded-xl mb-4">
                                    <h4 className="font-bold text-blue-800 mb-2 flex items-center gap-2"><Icons.Link size={18} /> Sincronitzar amb Programaci√≥ Docent</h4>
                                    <p className="text-xs text-blue-600 mb-4">L'artefacte de programaci√≥ s'obrir√† i la taula d'aquesta UT s'enganxar√† autom√†ticament on indiquis.</p>
                                    
                                    <div className="flex gap-4 mb-4">
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-blue-700 mb-1 uppercase tracking-wide">Curs / Pestanya</label>
                                            <input type="text" placeholder="Ex: 2n ESO" className="w-full p-2 border border-blue-300 rounded shadow-inner text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" value={exportConfig.curs} onChange={e=>setExportConfig({...exportConfig, curs: e.target.value})} />
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-blue-700 mb-1 uppercase tracking-wide">UT</label>
                                            <input type="text" placeholder="Ex: UT1" className="w-full p-2 border border-blue-300 rounded shadow-inner text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" value={exportConfig.ut} onChange={e=>setExportConfig({...exportConfig, ut: e.target.value})} />
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-blue-700 mb-1 uppercase tracking-wide">Fase</label>
                                            <select className="w-full p-2 border border-blue-300 rounded shadow-inner text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" value={exportConfig.fase} onChange={e=>setExportConfig({...exportConfig, fase: e.target.value})}>
                                                <option value="FASE DE PREPARACI√ì">FASE DE PREPARACI√ì</option>
                                                <option value="FASE DE RESOLUCI√ì">FASE DE RESOLUCI√ì</option>
                                                <option value="FASE D'INTEGRACI√ì">FASE D'INTEGRACI√ì</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button onClick={handleExportToProgramacio} disabled={!exportConfig.curs || !exportConfig.ut || !exportConfig.fase} className="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-bold text-lg hover:bg-blue-700 disabled:opacity-50 transition-colors shadow-md flex items-center justify-center gap-2">
                                        Exportar a la meva Programaci√≥ <Icons.ArrowRight size={20}/>
                                    </button>
                                </div>

                                <div className="flex justify-end gap-2 mt-2">
                                    <button onClick={() => setShowExportModal(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Cancel¬∑lar</button>
                                </div>
                            </div>
                        </div>,
                        document.body
                    )}

                    {pendingActionTask && ReactDOM.createPortal(
                        <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-[9999] fade-in">
                            <div className="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                                <h3 className="text-lg font-bold mb-4">Qu√® ha passat amb l'activitat?</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => executePendingAction('skipped')} className="p-4 bg-red-50 text-red-700 border border-red-200 rounded hover:bg-red-100 font-bold flex flex-col items-center">
                                        <span className="text-2xl mb-2">‚ùå</span>
                                        No feta
                                    </button>
                                    <button onClick={() => executePendingAction('unfinished')} className="p-4 bg-orange-50 text-orange-700 border border-orange-200 rounded hover:bg-orange-100 font-bold flex flex-col items-center">
                                        <span className="text-2xl mb-2">üöß</span>
                                        Inacabada
                                    </button>
                                </div>
                                <button onClick={() => setPendingActionTask(null)} className="mt-4 w-full py-2 text-gray-500 hover:bg-gray-100 rounded">Cancel¬∑lar</button>
                            </div>
                        </div>,
                        document.body
                    )}
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('config'); // 'config', 'dashboard', 'planner', 'class_planner'
            const [config, setConfig] = useState({ teacherName: "", schoolYear: "2025", classes: [], schedule: {}, googleSheetUrl: "", taskTrackingUrl: "", theme: "orange", utDates: [] });
            const [radar, setRadar] = useState([]);
            const [weeksData, setWeeksData] = useState({});
            const [currentWeekId, setCurrentWeekId] = useState(null);
            const [selectedClassId, setSelectedClassId] = useState(null);
            const [completedWeeks, setCompletedWeeks] = useState([]);
            const [holidayWeeks, setHolidayWeeks] = useState([]);
            const [reminders, setReminders] = useState({});

            // Efecte per actualitzar el fons i scrollbar segons el tema
            useEffect(() => {
                const themeData = APP_THEMES[config.theme || 'orange'];
                if (themeData) {
                    document.body.style.backgroundColor = themeData.bg;
                    
                    let styleTag = document.getElementById('dynamic-theme-styles');
                    if (!styleTag) {
                        styleTag = document.createElement('style');
                        styleTag.id = 'dynamic-theme-styles';
                        document.head.appendChild(styleTag);
                    }
                    styleTag.innerHTML = `
                        .custom-scroll::-webkit-scrollbar-thumb { background-color: ${themeData.thumb}; }
                        .custom-scroll::-webkit-scrollbar-thumb:hover { background-color: ${themeData.hover}; }
                        .loader-spinner { border-top-color: ${themeData.hover}; }
                    `;
                }
            }, [config.theme]);

            // CARREGADOR I AUTO-RESCAT DE DADES (AMB MIGRACI√ì)
            useEffect(() => {
                const loader = document.getElementById('app-loader');
                if (loader) loader.style.display = 'none';
                
                let saved = localStorage.getItem('cfnPlannerData_v23'); 
                if (!saved) {
                    saved = localStorage.getItem('cfnPlannerData_v22') || localStorage.getItem('cfnPlannerData_v21') || localStorage.getItem('cfnPlannerData');
                }

                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        let needsSave = false;

                        // Migraci√≥ UT (de utEnds a utDates)
                        if (data.config && data.config.utEnds && (!data.config.utDates || data.config.utDates.length === 0)) {
                            data.config.utDates = Object.entries(data.config.utEnds).map(([date, name], idx) => ({
                                id: 'migrated_' + idx,
                                name: name,
                                date: date
                            }));
                            delete data.config.utEnds;
                            needsSave = true;
                        }

                        // Migraci√≥ Radar (Text a Array) + Neteja de dates passades
                        let parsedRadar = [];
                        if (typeof data.radar === 'string') {
                            if (data.radar.trim() !== '') {
                                parsedRadar = [{ id: Date.now(), text: data.radar, date: null, fromTask: false }];
                            }
                            needsSave = true;
                        } else if (Array.isArray(data.radar)) {
                            const today = new Date();
                            today.setHours(0,0,0,0);
                            parsedRadar = data.radar.filter(item => {
                                if (!item.date) return true;
                                const itemDate = new Date(item.date);
                                return itemDate >= today;
                            });
                            if (parsedRadar.length !== data.radar.length) needsSave = true;
                        }

                        // Migraci√≥ Dates (Moure els diumenges a dilluns)
                        const shiftDate = (dateStr) => {
                            if (!dateStr || typeof dateStr !== 'string') return dateStr;
                            const parts = dateStr.split('-');
                            if (parts.length !== 3) return dateStr;
                            const dObj = new Date(parts[0], parts[1] - 1, parts[2], 12, 0, 0);
                            if (dObj.getDay() === 0) {
                                dObj.setDate(dObj.getDate() + 1);
                                return `${dObj.getFullYear()}-${String(dObj.getMonth() + 1).padStart(2, '0')}-${String(dObj.getDate()).padStart(2, '0')}`;
                            }
                            return dateStr;
                        };

                        if (data.weeksData) {
                            const newWeeksData = {};
                            for (const [key, val] of Object.entries(data.weeksData)) {
                                const newKey = shiftDate(key);
                                newWeeksData[newKey] = val;
                                if (newKey !== key) needsSave = true;
                            }
                            data.weeksData = newWeeksData;
                        }

                        if (data.completedWeeks) {
                            const newComp = data.completedWeeks.map(shiftDate);
                            if (newComp.join(',') !== data.completedWeeks.join(',')) {
                                data.completedWeeks = newComp;
                                needsSave = true;
                            }
                        }
                        
                        if (data.holidayWeeks) {
                            const newHol = data.holidayWeeks.map(shiftDate);
                            if (newHol.join(',') !== data.holidayWeeks.join(',')) {
                                data.holidayWeeks = newHol;
                                needsSave = true;
                            }
                        }

                        if(data.config) setConfig(data.config);
                        setRadar(parsedRadar);
                        if(data.weeksData) setWeeksData(data.weeksData);
                        if(data.completedWeeks) setCompletedWeeks(data.completedWeeks);
                        if(data.holidayWeeks) setHolidayWeeks(data.holidayWeeks);
                        if(data.reminders) setReminders(data.reminders);
                        if(data.config?.teacherName) setView('dashboard');

                        if (needsSave) {
                             localStorage.setItem('cfnPlannerData_v23', JSON.stringify({...data, radar: parsedRadar}));
                        }
                    } catch(e) { console.error("Error carregant les dades", e); }
                }
            }, []);

            useEffect(() => { localStorage.setItem('cfnPlannerData_v23', JSON.stringify({ config, radar, weeksData, completedWeeks, holidayWeeks, reminders })); }, [config, radar, weeksData, completedWeeks, holidayWeeks, reminders]);

            const handleUpdateWeekData = (weekId, data) => {
                setWeeksData(prev => ({ ...prev, [weekId]: data }));
            };

            const handleToggleComplete = (wid) => { setCompletedWeeks(prev => prev.includes(wid) ? prev.filter(id => id !== wid) : [...prev, wid]); };
            
            const handleToggleHoliday = (wid) => {
                const isBecomingHoliday = !holidayWeeks.includes(wid);
                setHolidayWeeks(prev => isBecomingHoliday ? [...prev, wid] : prev.filter(id => id !== wid));

                if (isBecomingHoliday) {
                    setWeeksData(prev => {
                        const currentWeekData = prev[wid] || {};
                        const updatedWeekData = { ...currentWeekData };
                        
                        for (let d = 0; d < 5; d++) {
                            for (let s = 0; s < TIME_SLOTS.length; s++) {
                                const slot = TIME_SLOTS[s];
                                if (slot.type === 'class') { 
                                     if (config.schedule[d]?.[slot.id]) {
                                         const key = `${d}-${slot.id}`;
                                         updatedWeekData[key] = { 
                                             ...(updatedWeekData[key] || {}), 
                                             status: 'zzz',
                                             zzzReason: 'Vacances üéâ',
                                             tasks: updatedWeekData[key]?.tasks || [{text: "", time: "", status: null}, {text: "", time: "", status: null}, {text: "", time: "", status: null}]
                                         };
                                     }
                                }
                            }
                        }
                        return { ...prev, [wid]: updatedWeekData };
                    });
                }
            };

            const handleSaveReminder = (dateStr, newReminders) => {
                setReminders(prev => ({
                    ...prev,
                    [dateStr]: newReminders
                }));
            };

            const handleAddToRadar = (text, dayIndex) => {
                const dateStr = dayIndex !== undefined && currentWeekId ? addDays(currentWeekId, dayIndex) : getLocalISODate(new Date());
                const newEntry = {
                    id: Date.now(),
                    text: text,
                    date: dateStr,
                    fromTask: true
                };
                setRadar(prev => [...prev, newEntry]);
            };

            const handleSelectClassView = (cId) => {
                setSelectedClassId(cId);
                setView('class_planner');
            };

            const handleReset = () => { localStorage.removeItem('cfnPlannerData_v23'); setConfig({ teacherName: "", schoolYear: "2025", classes: [], schedule: {}, googleSheetUrl: "", taskTrackingUrl: "", theme: "orange", utDates: [] }); setRadar([]); setWeeksData({}); setCompletedWeeks([]); setHolidayWeeks([]); setReminders({}); setView('config'); };
            const handleExport = () => { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ config, radar, weeksData, completedWeeks, holidayWeeks, reminders })); a.download = `planificador_cfn_${config.schoolYear}.json`; a.click(); };
            const handleImport = (e) => { const fr = new FileReader(); fr.onload = ev => { const d = JSON.parse(ev.target.result); setConfig(d.config || config); setRadar(Array.isArray(d.radar) ? d.radar : []); setWeeksData(d.weeksData || {}); setCompletedWeeks(d.completedWeeks || []); setHolidayWeeks(d.holidayWeeks || []); setReminders(d.reminders || {}); setView('dashboard'); }; fr.readAsText(e.target.files[0]); };

            return (
                <div className="min-h-screen">
                    {view === 'config' && <ConfigScreen config={config} onSave={c => { setConfig(c); setView('dashboard'); }} />}
                    {view === 'dashboard' && <DashboardScreen config={config} radar={radar} setRadar={setRadar} completedWeeks={completedWeeks} onToggleWeekComplete={handleToggleComplete} onSelectWeek={w => { setCurrentWeekId(w); setView('planner'); }} onSelectClassView={handleSelectClassView} onExport={handleExport} onImport={handleImport} goToConfig={() => setView('config')} onReset={handleReset} onSaveConfig={setConfig} holidayWeeks={holidayWeeks} onToggleHoliday={handleToggleHoliday} reminders={reminders} />}
                    {view === 'planner' && <PlannerScreen weekId={currentWeekId} weeksData={weeksData} config={config} onConfigChange={setConfig} onUpdateWeekData={handleUpdateWeekData} onBack={() => setView('dashboard')} onAddToRadar={handleAddToRadar} allWeeks={generateAllWeeks(config.schoolYear)} holidayWeeks={holidayWeeks} reminders={reminders} onSaveReminder={handleSaveReminder} />}
                    {view === 'class_planner' && <ClassPlannerScreen classId={selectedClassId} weeksData={weeksData} config={config} onUpdateWeekData={handleUpdateWeekData} onBack={() => setView('dashboard')} onAddToRadar={handleAddToRadar} allWeeks={generateAllWeeks(config.schoolYear)} holidayWeeks={holidayWeeks} reminders={reminders} onSaveReminder={handleSaveReminder} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
