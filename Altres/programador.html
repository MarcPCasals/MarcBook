<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programació Docent</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel per compilar JSX al navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- SheetJS per generar XLSX real -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fff7ed; /* Fons taronja molt suau, estil agenda docent */
            color: #374151;
        }

        /* Scrollbars personalitzades i netes */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f9fafb; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #fdba74; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f97316; }

        .textarea-auto {
            resize: none;
            overflow: hidden;
            width: 100%;
            background: transparent;
            outline: none;
            transition: background-color 0.2s;
        }

        /* Ocultar fletxes dels inputs de tipus number per a un disseny més net */
        input[type=number].hide-arrows::-webkit-inner-spin-button, 
        input[type=number].hide-arrows::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number].hide-arrows {
            -moz-appearance: textfield;
        }

        .phase-header-0 { background-color: #d1fae5; color: #065f46; border-left: 4px solid #059669; } /* Verd */
        .phase-header-1 { background-color: #e0e7ff; color: #3730a3; border-left: 4px solid #4f46e5; } /* Blau */
        .phase-header-2 { background-color: #fef3c7; color: #92400e; border-left: 4px solid #d97706; } /* Groc */
        .phase-header-3 { background-color: #fee2e2; color: #991b1b; border-left: 4px solid #dc2626; } /* Vermell */
        .phase-header-4 { background-color: #f3e8ff; color: #6b21a8; border-left: 4px solid #9333ea; } /* Lila */
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONES SVG ---
        const IconSave = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
        const IconUndo = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.6L3 13"></path></svg>;
        const IconRedo = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 7v6h-6"></path><path d="M3 17a9 9 0 019-9 9 9 0 016 2.6L21 13"></path></svg>;
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const IconEye = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>;
        const IconEyeOff = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>;
        const IconGripVertical = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="19" r="1"></circle></svg>;

        // --- DADES INICIALS ---
        const generateId = () => Math.random().toString(36).substr(2, 9);

        const initialData = [
            {
                id: generateId(),
                name: 'Nou Curs',
                units: [
                    {
                        id: generateId(),
                        title: 'Nova UT',
                        phases: [
                            { id: generateId(), name: 'FASE DE PREPARACIÓ', collapsed: false, sessions: [] },
                            { id: generateId(), name: 'FASE DE RESOLUCIÓ', collapsed: false, sessions: [] },
                            { id: generateId(), name: "FASE D'INTEGRACIÓ", collapsed: false, sessions: [] }
                        ]
                    }
                ]
            }
        ];

        // --- FUNCIONS DE LOCALSTORAGE ---
        const guardarDades = (coursesToSave) => {
            Object.keys(localStorage).forEach(k => {
                if (k.startsWith('programacio-')) localStorage.removeItem(k);
            });
            coursesToSave.forEach(curs => {
                localStorage.setItem(`programacio-${curs.name}`, JSON.stringify(curs));
            });
        };

        const llegirDades = () => {
            const keys = Object.keys(localStorage).filter(k => k.startsWith('programacio-'));
            return keys.map(k => {
                try { return JSON.parse(localStorage.getItem(k)); } catch (e) { return null; }
            }).filter(Boolean);
        };

        const detectarDades = () => {
            return Object.keys(localStorage).some(k => k.startsWith('programacio-'));
        };

        const migrateData = (courses) => {
            return courses.map(c => ({
                ...c,
                units: c.units.map(u => ({
                    ...u,
                    phases: u.phases.map(p => ({
                        ...p,
                        collapsed: p.collapsed || false,
                        sessions: p.sessions.map(s => {
                            let newS = { ...s };
                            delete newS.space;
                            if (typeof newS.activity === 'string') {
                                newS.activities = newS.activity.split('\n').filter(a=>a.trim()).map(a => ({ id: generateId(), text: a.replace(/^•\s*/, ''), detail: '', time: '', challengeResponse: '', expanded: false }));
                                delete newS.activity;
                            } else if (!newS.activities) {
                                newS.activities = [];
                            } else {
                                // Migració de propietats noves a activitats existents i neteja de "•"
                                newS.activities = newS.activities.map(a => ({
                                    ...a,
                                    text: (a.text || '').replace(/^•\s*/, ''),
                                    time: a.time || '',
                                    challengeResponse: a.challengeResponse || ''
                                }));
                            }
                            
                            if (typeof newS.material === 'string') {
                                newS.materials = newS.material.split('\n').filter(m=>m.trim()).map(m => ({ id: generateId(), name: m, url: '' }));
                                delete newS.material;
                            } else if (!newS.materials) newS.materials = [];
                            return newS;
                        })
                    }))
                }))
            }));
        };

        // --- COMPONENTS ---

        const AutoTextarea = ({ value, onChange, placeholder, className, onFocus }) => {
            const textareaRef = useRef(null);

            const adjustHeight = () => {
                const textarea = textareaRef.current;
                if (textarea) {
                    textarea.style.height = 'auto';
                    textarea.style.height = `${textarea.scrollHeight}px`;
                }
            };

            useEffect(() => {
                adjustHeight();
            }, [value]);

            return (
                <textarea
                    ref={textareaRef}
                    value={value}
                    onChange={(e) => {
                        onChange(e.target.value);
                        adjustHeight();
                    }}
                    onFocus={onFocus}
                    placeholder={placeholder}
                    rows={1}
                    className={`textarea-auto ${className}`}
                />
            );
        };


        const App = () => {
            const [data, setData] = useState(() => {
                let loadedData;
                if (detectarDades()) {
                    loadedData = llegirDades();
                } else {
                    const antic = localStorage.getItem('programacio_docent_data');
                    if (antic) { try { loadedData = JSON.parse(antic); } catch (e) {} }
                }
                return migrateData(loadedData && loadedData.length > 0 ? loadedData : initialData);
            });

            const [activeCourseId, setActiveCourseId] = useState(data[0]?.id);
            const [activeUnitId, setActiveUnitId] = useState(data[0]?.units[0]?.id);
            const [toastMsg, setToastMsg] = useState('');
            
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [skipHistory, setSkipHistory] = useState(false);

            const [showPasteModal, setShowPasteModal] = useState(false);
            const [pasteRows, setPasteRows] = useState(() => Array.from({length: 5}, () => ['', '', '', '']));
            const [pastePhaseId, setPastePhaseId] = useState("");

            // Estats per Modal d'Exportar
            const [showExportModal, setShowExportModal] = useState(false);
            const [exportCourseId, setExportCourseId] = useState("");
            const [exportUnitId, setExportUnitId] = useState("");
            
            const [showCompleted, setShowCompleted] = useState(false);

            // REQ 5: URL de l'Agenda Docent
            const [agendaUrl, setAgendaUrl] = useState(() => localStorage.getItem('programacio_agenda_url') || '');

            useEffect(() => {
                localStorage.setItem('programacio_agenda_url', agendaUrl);
            }, [agendaUrl]);

            // --- SINCRONITZACIÓ AMB AGENDA (POSTMESSAGE I LOCALSTORAGE) ---
            useEffect(() => {
                const processarDadesAgenda = (payload) => {
                    if (!payload || payload.action !== 'SYNC_TABLE') return;
                    console.log("Dades rebudes de l'Agenda per integrar a l'estat:", payload);

                    // Analitzar l'HTML i convertir-lo en l'estructura de dades de React
                    const parser = new DOMParser();
                    const doc = parser.parseFromString('<table>' + payload.html + '</table>', 'text/html');
                    const rows = doc.querySelectorAll('tr');
                    const newSessions = [];

                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 3) {
                            // Parsejar Activitats
                            const actDivs = cells[0].querySelectorAll('div');
                            const activities = [];
                            if (actDivs.length > 0) {
                                actDivs.forEach(div => {
                                    let text = div.textContent.trim().replace(/^•\s*/, '');
                                    if (text) activities.push({ id: generateId(), text: text, detail: '', time: '', challengeResponse: '', expanded: false });
                                });
                            } else {
                                let text = cells[0].textContent.trim().replace(/^•\s*/, '');
                                if (text) activities.push({ id: generateId(), text: text, detail: '', time: '', challengeResponse: '', expanded: false });
                            }

                            // Parsejar Materials i Enllaços
                            const materials = [];
                            const contentCol1 = cells[1].innerHTML;
                            const splitParts = contentCol1.split(/<b>Enllaços:<\/b>/i);
                            const textMaterials = splitParts[0].replace(/<br\s*[\/]?>/gi, '\n');
                            const matDoc = parser.parseFromString(textMaterials, 'text/html');
                            matDoc.body.textContent.split('\n').forEach(line => {
                                if (line.trim()) materials.push({ id: generateId(), name: line.trim(), url: "" });
                            });

                            const links = cells[1].querySelectorAll('a');
                            links.forEach(a => {
                                materials.push({ id: generateId(), name: a.textContent.trim(), url: a.href });
                            });

                            // Parsejar Comentaris
                            const commentsHtml = cells[2].innerHTML.replace(/<br\s*[\/]?>/gi, '\n');
                            const comments = parser.parseFromString(commentsHtml, 'text/html').body.textContent.trim();

                            newSessions.push({
                                id: generateId(),
                                activities: activities,
                                materials: materials,
                                comments: comments,
                                completed: false
                            });
                        }
                    });

                    if (newSessions.length === 0) return;

                    setData(prevData => {
                        let newData = JSON.parse(JSON.stringify(prevData)); 
                        
                        // 1. Cercar o crear el Curs sol·licitat
                        let course = newData.find(c => c.name.trim().toLowerCase() === (payload.curs || "").trim().toLowerCase());
                        if (!course) {
                            course = { id: generateId(), name: payload.curs || "Nou Curs Importat", units: [] };
                            newData.push(course);
                        }
                        
                        // 2. Cercar o crear la UT sol·licitada
                        let unit = course.units.find(u => u.title.trim().toLowerCase() === (payload.ut || "").trim().toLowerCase());
                        if (!unit) {
                            unit = { 
                                id: generateId(), 
                                title: payload.ut || "Nova UT", 
                                phases: [
                                    { id: generateId(), name: 'FASE DE PREPARACIÓ', collapsed: false, sessions: [] },
                                    { id: generateId(), name: 'FASE DE RESOLUCIÓ', collapsed: false, sessions: [] },
                                    { id: generateId(), name: "FASE D'INTEGRACIÓ", collapsed: false, sessions: [] }
                                ] 
                            };
                            course.units.push(unit);
                        }

                        // 3. Cercar la Fase
                        let phase = unit.phases.find(p => p.name.trim().toLowerCase() === (payload.fase || "").trim().toLowerCase());
                        if (!phase) phase = unit.phases[0]; // Si no troba la fase exacta, es col·locarà a la primera

                        // 4. Afegir les noves sessions a la fase (s'apilaran correctament abans del botó d'afegir)
                        phase.sessions.push(...newSessions);

                        // Actualitzar les pestanyes actives automàticament per portar-te al lloc on s'han importat
                        setTimeout(() => {
                            setActiveCourseId(course.id);
                            setActiveUnitId(unit.id);
                            showToast(`Dades afegides a: ${course.name} > ${unit.title} > ${phase.name}`);
                        }, 100);

                        return newData;
                    });
                };

                // Escoltar missatges de tipus postMessage
                const handleMessage = (event) => {
                    const originValid = event.origin.includes("marcpcasals.github.io") || 
                                        event.origin.includes("localhost") || 
                                        event.origin.includes("127.0.0.1");
                    if (!originValid && event.origin !== window.location.origin) return;
                    
                    if (event.data && event.data.action === 'SYNC_TABLE') {
                        processarDadesAgenda(event.data);
                    }
                };
                window.addEventListener("message", handleMessage);

                // Intents d'obrir per localStorage
                const savedPayloadStr = localStorage.getItem('cfn_sync_payload');
                if (savedPayloadStr) {
                    try {
                        const savedPayload = JSON.parse(savedPayloadStr);
                        processarDadesAgenda(savedPayload);
                        localStorage.removeItem('cfn_sync_payload'); 
                    } catch(e) {
                        console.error("Error processant dades del localStorage:", e);
                    }
                }

                // Neteja
                return () => window.removeEventListener("message", handleMessage);
            }, []);

            useEffect(() => {
                guardarDades(data);
                if (skipHistory) {
                    setSkipHistory(false);
                    return;
                }
                setHistory(prev => {
                    const newHistory = prev.slice(0, historyIndex + 1);
                    newHistory.push(data);
                    setHistoryIndex(newHistory.length - 1);
                    return newHistory;
                });
            }, [data]);

            const activeCourse = data.find(c => c.id === activeCourseId) || data[0];
            useEffect(() => {
                if (activeCourse && (!activeUnitId || !activeCourse.units.find(u => u.id === activeUnitId))) {
                    setActiveUnitId(activeCourse.units[0]?.id);
                }
            }, [activeCourseId, data]);

            const activeUnit = activeCourse?.units.find(u => u.id === activeUnitId);

            const showToast = (msg) => {
                setToastMsg(msg);
                setTimeout(() => setToastMsg(''), 3000);
            };

            const undo = () => {
                if (historyIndex > 0) {
                    setSkipHistory(true);
                    setHistoryIndex(historyIndex - 1);
                    setData(history[historyIndex - 1]);
                }
            };
            const redo = () => {
                if (historyIndex < history.length - 1) {
                    setSkipHistory(true);
                    setHistoryIndex(historyIndex + 1);
                    setData(history[historyIndex + 1]);
                }
            };

            const reorderCoursesNode = (draggedId, targetId) => {
                if (draggedId === targetId) return;
                setData(prev => {
                    const newData = [...prev];
                    const draggedIndex = newData.findIndex(c => c.id === draggedId);
                    const targetIndex = newData.findIndex(c => c.id === targetId);
                    if (draggedIndex === -1 || targetIndex === -1) return prev;
                    const [draggedItem] = newData.splice(draggedIndex, 1);
                    newData.splice(targetIndex, 0, draggedItem);
                    return newData;
                });
            };

            const deleteCourse = (courseId) => {
                if(confirm("Segur que vols eliminar tot aquest curs? Aquesta acció no es pot desfer.")) {
                    setData(prev => {
                        const newData = prev.filter(c => c.id !== courseId);
                        if (newData.length > 0 && activeCourseId === courseId) {
                            setActiveCourseId(newData[0].id);
                        }
                        return newData;
                    });
                }
            };

            const deleteUnit = (courseId, unitId) => {
                if(confirm("Segur que vols eliminar aquesta unitat temporal? Aquesta acció no es pot desfer.")) {
                    setData(prev => prev.map(c => {
                        if (c.id !== courseId) return c;
                        const newUnits = c.units.filter(u => u.id !== unitId);
                        if (activeUnitId === unitId && newUnits.length > 0) {
                            setActiveUnitId(newUnits[0].id);
                        } else if (activeUnitId === unitId) {
                            setActiveUnitId(null);
                        }
                        return { ...c, units: newUnits };
                    }));
                }
            };

            // --- LÒGICA DE DADES ---
            
            const updateSession = (courseId, unitId, phaseId, sessionId, field, value) => {
                setData(prev => prev.map(course => {
                    if (course.id !== courseId) return course;
                    return {
                        ...course,
                        units: course.units.map(unit => {
                            if (unit.id !== unitId) return unit;
                            return {
                                ...unit,
                                phases: unit.phases.map(phase => {
                                    if (phase.id !== phaseId) return phase;
                                    return {
                                        ...phase,
                                        sessions: phase.sessions.map(session => 
                                            session.id === sessionId ? { ...session, [field]: value } : session
                                        )
                                    };
                                })
                            };
                        })
                    };
                }));
            };

            const updateSessionArray = (courseId, unitId, phaseId, sessionId, arrayName, action, itemData) => {
                setData(prev => prev.map(c => c.id !== courseId ? c : {
                    ...c, units: c.units.map(u => u.id !== unitId ? u : {
                        ...u, phases: u.phases.map(p => p.id !== phaseId ? p : {
                            ...p, sessions: p.sessions.map(s => {
                                if (s.id !== sessionId) return s;
                                let newArray = [...s[arrayName]];
                                if (action === 'add') newArray.push(itemData);
                                else if (action === 'delete') newArray = newArray.filter(i => i.id !== itemData);
                                else if (action === 'update') {
                                    const { itemId, field, value } = itemData;
                                    newArray = newArray.map(i => i.id !== itemId ? i : { ...i, [field]: value });
                                }
                                return { ...s, [arrayName]: newArray };
                            })
                        })
                    })
                }));
            };

            const reorderActivities = (courseId, unitId, phaseId, sessionId, draggedId, targetId) => {
                if (draggedId === targetId) return;
                setData(prev => prev.map(c => c.id !== courseId ? c : {
                    ...c, units: c.units.map(u => u.id !== unitId ? u : {
                        ...u, phases: u.phases.map(p => p.id !== phaseId ? p : {
                            ...p, sessions: p.sessions.map(s => {
                                if (s.id !== sessionId) return s;
                                const newActivities = [...s.activities];
                                const draggedIndex = newActivities.findIndex(a => a.id === draggedId);
                                const targetIndex = newActivities.findIndex(a => a.id === targetId);
                                if (draggedIndex === -1 || targetIndex === -1) return s;
                                const [draggedItem] = newActivities.splice(draggedIndex, 1);
                                newActivities.splice(targetIndex, 0, draggedItem);
                                return { ...s, activities: newActivities };
                            })
                        })
                    })
                }));
            };

            const reorderSessions = (courseId, unitId, draggedSessionId, targetSessionId) => {
                if (draggedSessionId === targetSessionId) return;
                
                setData(prev => prev.map(course => {
                    if (course.id !== courseId) return course;
                    return {
                        ...course,
                        units: course.units.map(unit => {
                            if (unit.id !== unitId) return unit;
                            
                            let draggedSession = null;
                            
                            // Extreure la sessió origen
                            const newPhases = unit.phases.map(phase => {
                                const sessionIndex = phase.sessions.findIndex(s => s.id === draggedSessionId);
                                if (sessionIndex > -1) {
                                    draggedSession = phase.sessions[sessionIndex];
                                    const newSessions = [...phase.sessions];
                                    newSessions.splice(sessionIndex, 1);
                                    return { ...phase, sessions: newSessions };
                                }
                                return phase;
                            });
                            
                            if (!draggedSession) return unit;
                            
                            // Inserir-la en el lloc destí
                            const finalPhases = newPhases.map(phase => {
                                const targetIndex = phase.sessions.findIndex(s => s.id === targetSessionId);
                                if (targetIndex > -1) {
                                    const newSessions = [...phase.sessions];
                                    newSessions.splice(targetIndex, 0, draggedSession);
                                    return { ...phase, sessions: newSessions };
                                }
                                return phase;
                            });
                            
                            return { ...unit, phases: finalPhases };
                        })
                    };
                }));
            };

            const updatePhase = (courseId, unitId, phaseId, field, value) => {
                setData(prev => prev.map(course => {
                    if (course.id !== courseId) return course;
                    return {
                        ...course,
                        units: course.units.map(unit => {
                            if (unit.id !== unitId) return unit;
                            return {
                                ...unit,
                                phases: unit.phases.map(phase => {
                                    if (phase.id !== phaseId) return phase;
                                    return { ...phase, [field]: value };
                                })
                            };
                        })
                    };
                }));
            };

            const addPhase = (courseId, unitId) => {
                setData(prev => prev.map(course => {
                    if (course.id !== courseId) return course;
                    return {
                        ...course,
                        units: course.units.map(unit => {
                            if (unit.id !== unitId) return unit;
                            return {
                                ...unit,
                                phases: [...unit.phases, {
                                    id: generateId(),
                                    name: 'NOVA FASE',
                                    collapsed: false,
                                    sessions: []
                                }]
                            };
                        })
                    };
                }));
                showToast("Nova fase afegida.");
            };

            const deletePhase = (courseId, unitId, phaseId) => {
                if(!confirm("Segur que vols eliminar aquesta fase i TOTES les seves sessions? Aquesta acció no es pot desfer.")) return;
                setData(prev => prev.map(course => {
                    if (course.id !== courseId) return course;
                    return {
                        ...course,
                        units: course.units.map(unit => {
                            if (unit.id !== unitId) return unit;
                            return {
                                ...unit,
                                phases: unit.phases.filter(p => p.id !== phaseId)
                            };
                        })
                    };
                }));
                showToast("Fase eliminada.");
            };

            const areAllExpanded = activeUnit?.phases.every(p => p.sessions.every(s => s.activities.every(a => a.expanded)));
            
            const toggleAllDetails = () => {
                const newState = !areAllExpanded; 
                setData(prev => prev.map(c => c.id !== activeCourse.id ? c : {
                    ...c, units: c.units.map(u => u.id !== activeUnit.id ? u : {
                        ...u, phases: u.phases.map(p => ({
                            ...p, sessions: p.sessions.map(s => ({
                                ...s, activities: s.activities.map(a => ({ ...a, expanded: newState }))
                            }))
                        }))
                    })
                }));
            };

            const addSession = (courseId, unitId, phaseId) => {
                setData(prev => prev.map(course => {
                    if (course.id !== courseId) return course;
                    return {
                        ...course,
                        units: course.units.map(unit => {
                            if (unit.id !== unitId) return unit;
                            return {
                                ...unit,
                                phases: unit.phases.map(phase => {
                                    if (phase.id !== phaseId) return phase;
                                    return {
                                        ...phase,
                                        sessions: [...phase.sessions, {
                                            id: generateId(),
                                            activities: [],
                                            materials: [],
                                            comments: "",
                                            completed: false
                                        }]
                                    };
                                })
                            };
                        })
                    };
                }));
            };

            const deleteSession = (courseId, unitId, phaseId, sessionId) => {
                if(!confirm("Segur que vols eliminar aquesta sessió? Aquesta acció no es pot desfer.")) return;
                
                setData(prev => prev.map(course => {
                    if (course.id !== courseId) return course;
                    return {
                        ...course,
                        units: course.units.map(unit => {
                            if (unit.id !== unitId) return unit;
                            return {
                                ...unit,
                                phases: unit.phases.map(phase => {
                                    if (phase.id !== phaseId) return phase;
                                    return {
                                        ...phase,
                                        sessions: phase.sessions.filter(s => s.id !== sessionId)
                                    };
                                })
                            };
                        })
                    };
                }));
            };

            const resetUnit = (courseId, unitId) => {
                if(!confirm("Segur que vols REINICIAR aquesta unitat? S'eliminaran TOTES les sessions de totes les fases. Aquesta acció no es pot desfer.")) return;
                setData(prev => prev.map(course => {
                    if (course.id !== courseId) return course;
                    return {
                        ...course,
                        units: course.units.map(unit => {
                            if (unit.id !== unitId) return unit;
                            return {
                                ...unit,
                                phases: unit.phases.map(phase => ({ ...phase, sessions: [] }))
                            };
                        })
                    };
                }));
                showToast("Programació reiniciada correctament.");
            };

            const resetUnitState = (courseId, unitId) => {
                if(!confirm("Segur que vols reiniciar l'estat d'aquesta unitat? Totes les sessions es marcaran com a pendents (no fetes).")) return;
                setData(prev => prev.map(course => {
                    if (course.id !== courseId) return course;
                    return {
                        ...course,
                        units: course.units.map(unit => {
                            if (unit.id !== unitId) return unit;
                            return {
                                ...unit,
                                phases: unit.phases.map(phase => ({
                                    ...phase,
                                    sessions: phase.sessions.map(s => ({ ...s, completed: false }))
                                }))
                            };
                        })
                    };
                }));
                showToast("Estat de les sessions reiniciat.");
            };

            const addUnit = (courseId) => {
                const newUnitId = generateId();
                setData(prev => prev.map(course => {
                    if(course.id !== courseId) return course;
                    return {
                        ...course,
                        units: [...course.units, {
                            id: newUnitId,
                            title: 'Nova Unitat Temporal',
                            phases: [
                                { id: generateId(), name: 'FASE DE PREPARACIÓ', collapsed: false, sessions: [] },
                                { id: generateId(), name: 'FASE DE RESOLUCIÓ', collapsed: false, sessions: [] },
                                { id: generateId(), name: "FASE D'INTEGRACIÓ", collapsed: false, sessions: [] }
                            ]
                        }]
                    };
                }));
                setActiveUnitId(newUnitId);
            };

            // Funcions per Desar i Carregar JSON
            const exportJSON = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
                const link = document.createElement("a");
                link.setAttribute("href", dataStr);
                link.setAttribute("download", `programacio_docent_${new Date().toISOString().split('T')[0]}.json`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportJSON = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        setData(migrateData(importedData));
                        setActiveCourseId(importedData[0]?.id);
                        showToast("Dades JSON importades correctament.");
                    } catch (err) {
                        alert("El fitxer no té un format JSON vàlid.");
                    }
                };
                reader.readAsText(file);
            };

            // Nou mètode d'exportació XLSX utilitzant SheetJS
            const executeExportXLSX = () => {
                const targetCourse = data.find(c => c.id === exportCourseId);
                const targetUnit = targetCourse?.units.find(u => u.id === exportUnitId);
                
                if (!targetCourse || !targetUnit) return;

                const exportData = [];
                let exportCounter = 1;

                targetUnit.phases.forEach(p => {
                    p.sessions.forEach(s => {
                        const actText = s.activities.map(a => `${a.time ? a.time + "' - " : ""}${a.text}`).join('\n');
                        const matText = s.materials.map(m => m.name + (m.url ? ` (${m.url})` : '')).join('\n');
                        const comments = s.comments || "";
                        exportData.push({
                            "Sessió": exportCounter++,
                            "Fase": p.name,
                            "Activitats": actText,
                            "Materials": matText,
                            "Comentaris": comments,
                            "Estat": s.completed ? 'Completada' : 'Pendent'
                        });
                    });
                });

                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Programació");
                
                // Generar nom del fitxer netejat
                const safeCourseName = targetCourse.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const safeUnitName = targetUnit.title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                
                XLSX.writeFile(wb, `programacio_${safeCourseName}_${safeUnitName}.xlsx`);
                setShowExportModal(false);
                showToast("Excel descarregat correctament.");
            };

            const openPasteModal = () => {
                setPasteRows(Array.from({length: 5}, () => ['', '', '', '']));
                setPastePhaseId("");
                setShowPasteModal(true);
            };

            const handlePasteToGrid = (e, startRow, startCol) => {
                e.preventDefault();
                const pasteDataStr = e.clipboardData.getData('text/plain');
                
                let rows = [];
                let currentRow = [];
                let currentCell = "";
                let inQuotes = false;

                for (let i = 0; i < pasteDataStr.length; i++) {
                    const char = pasteDataStr[i];
                    if (inQuotes) {
                        if (char === '"') {
                            if (pasteDataStr[i + 1] === '"') {
                                currentCell += '"';
                                i++;
                            } else {
                                inQuotes = false;
                            }
                        } else {
                            currentCell += char;
                        }
                    } else {
                        if (char === '"') {
                            inQuotes = true;
                        } else if (char === '\t') {
                            currentRow.push(currentCell);
                            currentCell = "";
                        } else if (char === '\n') {
                            currentRow.push(currentCell);
                            rows.push(currentRow);
                            currentRow = [];
                            currentCell = "";
                        } else if (char !== '\r') {
                            currentCell += char;
                        }
                    }
                }
                if (currentCell || currentRow.length > 0) {
                    currentRow.push(currentCell);
                    rows.push(currentRow);
                }

                setPasteRows(prev => {
                    const newRows = [...prev];
                    rows.forEach((row, i) => {
                        const targetRow = startRow + i;
                        while (targetRow >= newRows.length) {
                            newRows.push(['', '', '', '']);
                        }
                        row.forEach((cell, j) => {
                            const targetCol = startCol + j;
                            if (targetCol < 4) {
                                newRows[targetRow][targetCol] = cell;
                            }
                        });
                    });
                    return newRows;
                });
            };

            const handlePasteSubmit = () => {
                if (!pastePhaseId) return;
                
                const newSessions = pasteRows.filter(r => r.some(c => c.trim() !== '')).map(cols => {
                    return {
                        id: generateId(),
                        // Netejar les viñetes copiades prèviament al fer l'split
                        activities: cols[1] ? cols[1].split('\n').filter(x=>x.trim()).map(a => ({ id: generateId(), text: a.trim().replace(/^•\s*/, ''), detail: "", time: "", challengeResponse: "", expanded: false })) : [],
                        materials: cols[2] ? cols[2].split('\n').filter(x=>x.trim()).map(m => ({ id: generateId(), name: m.trim(), url: "" })) : [],
                        comments: cols[3] || "",
                        completed: false
                    };
                });

                if (newSessions.length === 0) return;

                setData(prev => prev.map(c => c.id !== activeCourse.id ? c : {
                    ...c, units: c.units.map(u => u.id !== activeUnit?.id ? u : {
                        ...u, phases: u.phases.map(p => {
                            if (p.id !== pastePhaseId) return p;
                            return { ...p, sessions: [...p.sessions, ...newSessions] };
                        })
                    })
                }));
                
                setShowPasteModal(false);
                showToast("Dades importades a la taula correctament.");
            };

            // Pre-càlcul absolutament robust de tots els números de sessió per la vista actual
            const sessionNumbers = {};
            if (activeUnit) {
                let sessionCounter = 1;
                activeUnit.phases.forEach(phase => {
                    phase.sessions.forEach(session => {
                        sessionNumbers[session.id] = sessionCounter++;
                    });
                });
            }

            return (
                <div className="min-h-screen pb-20">
                    {/* Header Principal */}
                    <header className="bg-white border-b border-orange-200 shadow-sm sticky top-0 z-30">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center">
                                    <div className="bg-orange-500 text-white p-2 rounded-lg mr-3 shadow-sm hidden sm:block">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
                                    </div>
                                    <h1 className="text-xl font-bold text-gray-800 truncate max-w-[150px] sm:max-w-none">Programador Docent</h1>
                                    
                                    {/* Caixeta URL Agenda */}
                                    <div className="hidden md:flex items-center ml-4 pl-4 border-l-2 border-orange-200">
                                        <span className="text-sm font-semibold text-gray-500 mr-2">La meva agenda:</span>
                                        {agendaUrl ? (
                                            <div className="flex items-center bg-orange-50 px-2 py-1 rounded border border-orange-100">
                                                <a href={agendaUrl} target="_blank" rel="noopener noreferrer" className="text-sm font-medium text-blue-600 hover:text-blue-800 underline max-w-[150px] truncate" title={agendaUrl}>Obrir Agenda</a>
                                                <button onClick={() => {const url = prompt("Nova URL de l'Agenda Docent:", agendaUrl); if(url !== null) setAgendaUrl(url);}} className="ml-2 text-xs text-gray-400 hover:text-orange-500" title="Editar URL">✏️</button>
                                            </div>
                                        ) : (
                                            <button onClick={() => {const url = prompt("Introdueix l'URL de la teva Agenda Docent:"); if(url) setAgendaUrl(url);}} className="text-sm text-orange-500 hover:text-orange-700 underline font-medium">Configurar URL</button>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="flex items-center space-x-2 sm:space-x-3">
                                    <div className="flex bg-gray-100 rounded-md p-0.5 shadow-sm">
                                         <button onClick={undo} disabled={historyIndex <= 0} className="p-1 sm:p-1.5 text-gray-500 hover:text-gray-800 disabled:opacity-30 rounded hover:bg-white transition-all" title="Desfer"> <IconUndo /> </button>
                                         <button onClick={redo} disabled={historyIndex >= history.length - 1} className="p-1 sm:p-1.5 text-gray-500 hover:text-gray-800 disabled:opacity-30 rounded hover:bg-white transition-all" title="Refer"> <IconRedo /> </button>
                                    </div>

                                    {/* Botons per exportar/importar JSON restablerts */}
                                    <label className="flex items-center px-2 sm:px-3 py-1.5 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors cursor-pointer" title="Carregar JSON">
                                        <IconUpload /> <span className="ml-2 hidden lg:inline">Obrir JSON</span>
                                        <input type="file" accept=".json" className="hidden" onChange={handleImportJSON} />
                                    </label>
                                    <button onClick={exportJSON} className="flex items-center px-2 sm:px-3 py-1.5 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors" title="Desar còpia de seguretat en format JSON">
                                        <IconSave /> <span className="ml-2 hidden lg:inline">Desar JSON</span>
                                    </button>
                                    
                                    <button 
                                        onClick={() => {
                                            setExportCourseId(activeCourseId);
                                            setExportUnitId(activeUnitId);
                                            setShowExportModal(true);
                                        }} 
                                        className="flex items-center px-2 sm:px-3 py-1.5 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors" title="Exportar a Excel"
                                    >
                                        <IconDownload /> <span className="ml-2 hidden lg:inline">Exportar Excel</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Tabs de Cursos amb Reordenació sense Fletxes */}
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <nav className="flex space-x-2 overflow-x-auto custom-scroll pb-1 pt-2">
                                {data.map((course) => (
                                    <button
                                        key={course.id}
                                        onClick={() => setActiveCourseId(course.id)}
                                        draggable
                                        onDragStart={(e) => {
                                            e.dataTransfer.setData('course/plain', course.id);
                                        }}
                                        onDragOver={(e) => {
                                            e.preventDefault();
                                            if(e.dataTransfer.types.includes('course/plain')) {
                                                e.currentTarget.classList.add('border-l-4', 'border-orange-500');
                                            }
                                        }}
                                        onDragLeave={(e) => {
                                            e.currentTarget.classList.remove('border-l-4', 'border-orange-500');
                                        }}
                                        onDrop={(e) => {
                                            e.preventDefault();
                                            e.currentTarget.classList.remove('border-l-4', 'border-orange-500');
                                            const draggedId = e.dataTransfer.getData('course/plain');
                                            if (draggedId) {
                                                reorderCoursesNode(draggedId, course.id);
                                            }
                                        }}
                                        className={`whitespace-nowrap py-2 px-2 border-b-2 font-medium text-sm transition-colors flex items-center group relative ${
                                            activeCourseId === course.id
                                                ? 'border-orange-500 text-orange-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        <span className="text-gray-300 hover:text-gray-500 cursor-grab active:cursor-grabbing mr-1 opacity-50 group-hover:opacity-100 transition-opacity">
                                            <IconGripVertical />
                                        </span>
                                        
                                        <input 
                                            type="text" 
                                            value={course.name}
                                            onChange={e => {
                                                const nom = e.target.value;
                                                setData(prev => prev.map(c => c.id !== course.id ? c : { ...c, name: nom }));
                                            }}
                                            className={`bg-transparent border-none outline-none w-auto max-w-[120px] cursor-pointer text-center ${activeCourseId === course.id ? 'font-bold' : ''}`}
                                        />

                                        {activeCourseId === course.id && (
                                            <div onClick={(e) => { e.stopPropagation(); deleteCourse(course.id); }} className="text-gray-400 hover:text-red-500 p-1 ml-1 hover:bg-red-50 rounded" title="Eliminar curs sencer"><IconTrash /></div>
                                        )}
                                    </button>
                                ))}
                                <button 
                                    onClick={() => {
                                        const nom = prompt("Nom del nou curs:");
                                        if (nom) {
                                            const newCourse = { id: generateId(), name: nom, units: [] };
                                            setData([...data, newCourse]);
                                            setActiveCourseId(newCourse.id);
                                        }
                                    }}
                                    className="whitespace-nowrap py-3 px-4 font-medium text-sm text-gray-400 hover:text-orange-500 flex items-center"
                                >
                                    <IconPlus /> <span className="ml-1">Nou Curs</span>
                                </button>
                            </nav>
                        </div>
                    </header>

                    {/* Cos Principal */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        
                        {activeCourse && (
                            <div className="flex space-x-2 mb-4 overflow-x-auto custom-scroll pb-2 border-b border-orange-200">
                                {activeCourse.units.map(u => (
                                    <div key={u.id} className={`flex items-center px-4 py-2 rounded-t-lg border-b-2 transition-colors ${activeUnit?.id === u.id ? 'border-orange-500 bg-white text-orange-700 shadow-sm' : 'border-transparent bg-orange-50/50 text-gray-500 hover:bg-orange-50 cursor-pointer'}`} onClick={() => setActiveUnitId(u.id)}>
                                        <input 
                                            type="text" 
                                            value={u.title}
                                            onChange={(e) => {
                                                const newTitle = e.target.value;
                                                setData(prev => prev.map(c => c.id !== activeCourse.id ? c : {
                                                    ...c, units: c.units.map(unit => unit.id !== u.id ? unit : { ...unit, title: newTitle })
                                                }));
                                            }}
                                            className={`bg-transparent border-none outline-none w-32 ${activeUnit?.id === u.id ? 'font-bold' : ''}`}
                                        />
                                        {activeUnit?.id === u.id && (
                                            <div onClick={(e) => { e.stopPropagation(); deleteUnit(activeCourse.id, u.id); }} className="text-gray-400 hover:text-red-500 p-1 ml-2 hover:bg-red-50 rounded" title="Eliminar unitat temporal"><IconTrash /></div>
                                        )}
                                    </div>
                                ))}
                                <button onClick={() => addUnit(activeCourse.id)} className="px-4 py-2 text-sm font-medium text-orange-600 hover:bg-orange-100 rounded-t-lg transition-colors flex items-center">
                                    <IconPlus /> <span className="ml-1">Nova UT</span>
                                </button>
                            </div>
                        )}

                        {activeUnit && (() => {
                            const totalSessions = activeUnit.phases.reduce((acc, phase) => acc + phase.sessions.length, 0);
                            const completedSessions = activeUnit.phases.reduce((acc, phase) => acc + phase.sessions.filter(s => s.completed).length, 0);
                            const progressPercent = totalSessions === 0 ? 0 : Math.round((completedSessions / totalSessions) * 100);

                            return (
                                <div key={activeUnit.id} className="bg-white rounded-xl shadow-sm border border-orange-200 mb-8 animate-[fadeIn_0.3s_ease-out] flex flex-col">
                                    
                                    {/* Capçalera Unitat */}
                                    <div className="bg-orange-50/50 p-4 sm:p-6 border-b border-orange-200 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                                        <div className="flex-1">
                                            <h2 className="text-xl font-bold text-gray-800 mb-1">{activeUnit.title}</h2>
                                            <div className="flex items-center text-sm text-gray-500">
                                                <span className="font-medium mr-3">{totalSessions} sessions previstes</span>
                                                <div className="w-32 h-2.5 bg-gray-200 rounded-full overflow-hidden hidden sm:block">
                                                    <div className="h-full bg-green-500 transition-all duration-500" style={{ width: `${progressPercent}%` }}></div>
                                                </div>
                                                <span className="ml-2 text-xs font-semibold">{progressPercent}% completat</span>
                                            </div>
                                        </div>
                                        
                                        <div className="flex flex-wrap gap-2">
                                            <button onClick={openPasteModal} className="flex items-center px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium rounded-lg shadow-sm transition-colors" title="Pujar taula d'Excel">
                                                <IconUpload /> <span className="ml-2 hidden sm:inline">Pujar taula</span>
                                            </button>
                                            <button 
                                                onClick={toggleAllDetails}
                                                className="flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg shadow-sm transition-colors"
                                            >
                                                {areAllExpanded ? <IconEyeOff /> : <IconEye />}
                                                <span className="ml-2 hidden sm:inline">{areAllExpanded ? 'Ocultar tots els detalls' : 'Mostrar tots els detalls'}</span>
                                            </button>
                                            <button 
                                                onClick={() => resetUnitState(activeCourse.id, activeUnit.id)}
                                                className="flex items-center px-4 py-2 bg-yellow-50 hover:bg-yellow-100 text-yellow-700 border border-yellow-200 font-medium rounded-lg shadow-sm transition-all transform active:scale-95"
                                            >
                                                <IconEye />
                                                <span className="ml-2 hidden sm:inline">Reiniciar Estat</span>
                                            </button>
                                            <button 
                                                onClick={() => resetUnit(activeCourse.id, activeUnit.id)}
                                                className="flex items-center px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 font-medium rounded-lg shadow-sm transition-all transform active:scale-95"
                                            >
                                                <IconTrash />
                                                <span className="ml-2 hidden sm:inline">Reiniciar programació</span>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Taula Completa */}
                                    <div className="overflow-y-auto max-h-[75vh] custom-scroll relative">
                                        <table className="w-full text-left border-collapse min-w-[1000px] table-fixed">
                                            <thead className="sticky top-0 z-20 bg-gray-50 shadow-sm">
                                                <tr className="border-b border-gray-200 text-xs uppercase tracking-wider text-gray-500">
                                                    {/* Eliminada columna Accions, espai traslladat a Descripció (ara w-[50%]) */}
                                                    <th className="p-3 w-20 text-center font-semibold border-r border-gray-200">Sessió</th>
                                                    <th className="p-3 w-[50%] font-semibold border-r border-gray-200">Descripció d'activitats</th>
                                                    <th className="p-3 w-[20%] font-semibold border-r border-gray-200">Materials</th>
                                                    <th className="p-3 w-[20%] font-semibold border-r border-gray-200">Comentaris / Observacions</th>
                                                    <th className="p-3 w-16 text-center font-semibold">Estat</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {(() => {
                                                    const completedCount = activeUnit.phases.reduce((acc, p) => acc + p.sessions.filter(s => s.completed).length, 0);
                                                    if (completedCount > 0) {
                                                        return (
                                                            <tr className="bg-gray-100/80 border-b border-gray-200 cursor-pointer hover:bg-gray-200 transition-colors" onClick={() => setShowCompleted(!showCompleted)}>
                                                                <td colSpan="5" className="p-2 text-center text-sm font-semibold text-gray-600">
                                                                    {showCompleted ? '▼ Ocultar sessions acabades' : `▶ Mostrar sessions acabades (${completedCount})`}
                                                                </td>
                                                            </tr>
                                                        );
                                                    }
                                                    return null;
                                                })()}

                                                {activeUnit.phases.map((phase, pIndex) => (
                                                    <React.Fragment key={phase.id}>
                                                        <tr className={`border-b border-gray-200 ${`phase-header-${pIndex % 5}`}`}>
                                                            <td colSpan="5" className="p-2">
                                                                <div className="flex items-center group">
                                                                    <button
                                                                        onClick={() => updatePhase(activeCourse.id, activeUnit.id, phase.id, 'collapsed', !phase.collapsed)}
                                                                        className="mr-2 text-current opacity-70 hover:opacity-100 focus:outline-none font-bold text-xs"
                                                                        title={phase.collapsed ? "Desplegar fase" : "Col·lapsar fase"}
                                                                    >
                                                                        {phase.collapsed ? '▶' : '▼'}
                                                                    </button>
                                                                    <input 
                                                                        type="text"
                                                                        value={phase.name}
                                                                        onChange={(e) => updatePhase(activeCourse.id, activeUnit.id, phase.id, 'name', e.target.value)}
                                                                        className="font-bold text-sm bg-transparent border-none w-full outline-none"
                                                                    />
                                                                    <div 
                                                                        onClick={(e) => { e.stopPropagation(); deletePhase(activeCourse.id, activeUnit.id, phase.id); }} 
                                                                        className="text-current opacity-0 group-hover:opacity-50 hover:!opacity-100 p-1 ml-2 rounded cursor-pointer transition-opacity" 
                                                                        title="Eliminar fase completa"
                                                                    >
                                                                        <IconTrash />
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        
                                                        {!phase.collapsed && phase.sessions.map((session, sIndex) => {

                                                            if (session.completed && !showCompleted) return null;

                                                            const sessionNum = sessionNumbers[session.id];
                                                            const isEvenRow = sessionNum % 2 === 0;
                                                            const baseRowColor = isEvenRow ? 'bg-gray-100/60' : 'bg-white';
                                                            const rowBgClass = session.completed ? 'bg-gray-200 hover:bg-gray-300' : `${baseRowColor} hover:bg-orange-50/50`;
                                                            const totalSessionTime = session.activities.reduce((acc, act) => acc + (parseInt(act.time) || 0), 0);

                                                            return (
                                                                <tr 
                                                                    key={session.id} 
                                                                    draggable
                                                                    onDragStart={(e) => {
                                                                        e.dataTransfer.setData('session/plain', session.id);
                                                                    }}
                                                                    onDragOver={(e) => {
                                                                        e.preventDefault();
                                                                        if(e.dataTransfer.types.includes('session/plain')) {
                                                                            e.currentTarget.classList.add('border-t-4', 'border-orange-500');
                                                                        }
                                                                    }}
                                                                    onDragLeave={(e) => {
                                                                        e.currentTarget.classList.remove('border-t-4', 'border-orange-500');
                                                                    }}
                                                                    onDrop={(e) => {
                                                                        e.preventDefault();
                                                                        e.currentTarget.classList.remove('border-t-4', 'border-orange-500');
                                                                        const draggedId = e.dataTransfer.getData('session/plain');
                                                                        if (draggedId) {
                                                                            reorderSessions(activeCourse.id, activeUnit.id, draggedId, session.id);
                                                                        }
                                                                    }}
                                                                    className={`border-b border-gray-100 transition-colors ${rowBgClass}`}
                                                                >
                                                                    
                                                                    <td className="p-2 align-top border-r border-gray-200 group/session relative">
                                                                        <div className="flex flex-col items-center justify-start h-full mt-1">
                                                                            <span className="text-gray-300 hover:text-gray-500 cursor-grab active:cursor-grabbing mb-1 opacity-0 group-hover/session:opacity-100 transition-opacity" title="Arrossega per moure la sessió">
                                                                                <IconGripVertical />
                                                                            </span>
                                                                            <span className={`w-full text-center font-bold text-gray-700 block ${session.completed ? 'opacity-50' : ''}`}>
                                                                                {sessionNum}
                                                                            </span>
                                                                            {totalSessionTime > 0 && (
                                                                                <div className="text-sm text-red-600 font-bold mt-1 text-center" title="Temps total de la sessió">
                                                                                    {totalSessionTime}'
                                                                                </div>
                                                                            )}
                                                                            <button onClick={() => deleteSession(activeCourse.id, activeUnit.id, phase.id, session.id)} className="mt-2 p-1 text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors opacity-0 group-hover/session:opacity-100" title="Eliminar sessió">
                                                                                <IconTrash />
                                                                            </button>
                                                                        </div>
                                                                    </td>
                                                                    
                                                                    <td className="p-3 align-top border-r border-gray-200 relative">
                                                                        {session.activities.map((act) => {
                                                                            const hasDetailOrChallenge = (act.detail && act.detail.trim() !== '') || (act.challengeResponse && act.challengeResponse.trim() !== '');
                                                                            return (
                                                                                <div 
                                                                                    key={act.id} 
                                                                                    className="mb-2 last:mb-0 group relative transition-all"
                                                                                    draggable
                                                                                    onDragStart={(e) => {
                                                                                        e.stopPropagation(); // Evitar arrossegar tota la fila
                                                                                        e.dataTransfer.setData('activity/plain', act.id);
                                                                                        e.currentTarget.style.opacity = '0.5';
                                                                                    }}
                                                                                    onDragEnd={(e) => {
                                                                                        e.currentTarget.style.opacity = '1';
                                                                                    }}
                                                                                    onDragOver={(e) => {
                                                                                        e.preventDefault();
                                                                                        e.stopPropagation();
                                                                                        if(e.dataTransfer.types.includes('activity/plain')) {
                                                                                            e.currentTarget.classList.add('border-t-2', 'border-orange-400');
                                                                                        }
                                                                                    }}
                                                                                    onDragLeave={(e) => {
                                                                                        e.currentTarget.classList.remove('border-t-2', 'border-orange-400');
                                                                                    }}
                                                                                    onDrop={(e) => {
                                                                                        e.preventDefault();
                                                                                        e.stopPropagation();
                                                                                        e.currentTarget.classList.remove('border-t-2', 'border-orange-400');
                                                                                        const draggedId = e.dataTransfer.getData('activity/plain');
                                                                                        if(draggedId) reorderActivities(activeCourse.id, activeUnit.id, phase.id, session.id, draggedId, act.id);
                                                                                    }}
                                                                                >
                                                                                    <div className="flex items-start">
                                                                                        <span className="text-gray-300 hover:text-gray-500 cursor-grab active:cursor-grabbing mr-1 mt-1.5 opacity-0 group-hover:opacity-100 transition-opacity"><IconGripVertical /></span>
                                                                                        <span 
                                                                                            className={`${hasDetailOrChallenge ? 'text-orange-500 hover:text-orange-700' : 'text-gray-300 hover:text-gray-400'} mr-1 mt-1.5 cursor-pointer select-none text-xs transition-colors shrink-0`} 
                                                                                            onClick={() => updateSessionArray(activeCourse.id, activeUnit.id, phase.id, session.id, 'activities', 'update', { itemId: act.id, field: 'expanded', value: !act.expanded })}
                                                                                        >
                                                                                            {act.expanded ? '▼' : '▶'}
                                                                                        </span>
                                                                                        
                                                                                        {/* Caixetí del Temps */}
                                                                                        <div className={`flex items-center mr-2 mt-0.5 shrink-0 rounded px-1 transition-colors ${act.time ? '' : 'opacity-30 group-hover:opacity-100 focus-within:opacity-100'}`}>
                                                                                            <input 
                                                                                                type="number" 
                                                                                                value={act.time || ''} 
                                                                                                onChange={(e) => updateSessionArray(activeCourse.id, activeUnit.id, phase.id, session.id, 'activities', 'update', { itemId: act.id, field: 'time', value: e.target.value })}
                                                                                                className="w-6 bg-transparent text-right outline-none text-red-600 font-bold text-sm hide-arrows placeholder-red-300 focus:bg-red-50 focus:rounded"
                                                                                                placeholder="0"
                                                                                            />
                                                                                            <span className="text-red-600 font-bold text-sm ml-px">'</span>
                                                                                        </div>

                                                                                        <AutoTextarea 
                                                                                            value={act.text} 
                                                                                            onChange={(val) => updateSessionArray(activeCourse.id, activeUnit.id, phase.id, session.id, 'activities', 'update', { itemId: act.id, field: 'text', value: val })}
                                                                                            onFocus={() => {
                                                                                                if (act.text === 'Nova activitat') {
                                                                                                    updateSessionArray(activeCourse.id, activeUnit.id, phase.id, session.id, 'activities', 'update', { itemId: act.id, field: 'text', value: '' });
                                                                                                }
                                                                                            }}
                                                                                            className={`text-sm font-medium mt-0.5 w-full ${session.completed ? 'text-gray-500' : 'text-gray-800'}`}
                                                                                        />
                                                                                        <button onClick={() => updateSessionArray(activeCourse.id, activeUnit.id, phase.id, session.id, 'activities', 'delete', act.id)} className="ml-1 opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 px-1 font-bold mt-0.5">×</button>
                                                                                    </div>
                                                                                    
                                                                                    {act.expanded && (
                                                                                        <div className="ml-5 mt-2 mb-2 relative animate-[fadeIn_0.2s_ease-out]">
                                                                                            <div className="border-l-4 border-orange-400 bg-orange-50/80 rounded-r-lg shadow-sm p-3 flex flex-col space-y-3">
                                                                                                <AutoTextarea 
                                                                                                    value={act.detail} 
                                                                                                    onChange={(val) => updateSessionArray(activeCourse.id, activeUnit.id, phase.id, session.id, 'activities', 'update', { itemId: act.id, field: 'detail', value: val })} 
                                                                                                    placeholder="Descriu detalls de la dinàmica, pautes, agrupament..." 
                                                                                                    className="text-sm text-gray-800 w-full leading-relaxed placeholder-gray-400" 
                                                                                                />
                                                                                                
                                                                                                {/* Resposta al Repte Adaptada (Transparent) */}
                                                                                                <div className={`transition-all duration-300 rounded border flex flex-col p-2 ${act.challengeResponse && act.challengeResponse.trim() !== '' ? 'border-green-500 bg-transparent' : 'border-gray-200 bg-transparent hover:border-gray-300'}`}>
                                                                                                    <span className="font-bold text-sm text-gray-800 mb-1">Resposta a repte:</span>
                                                                                                    <AutoTextarea
                                                                                                        value={act.challengeResponse || ''}
                                                                                                        onChange={(val) => updateSessionArray(activeCourse.id, activeUnit.id, phase.id, session.id, 'activities', 'update', { itemId: act.id, field: 'challengeResponse', value: val })}
                                                                                                        placeholder="Escriu com es respon al repte..."
                                                                                                        className={`w-full bg-transparent outline-none resize-none ${act.challengeResponse && act.challengeResponse.trim() !== '' ? 'text-sm text-gray-800 leading-relaxed' : 'text-xs text-gray-400 h-6 min-h-[24px]'}`}
                                                                                                    />
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                    )}
                                                                                </div>
                                                                            );
                                                                        })}
                                                                        <button onClick={() => updateSessionArray(activeCourse.id, activeUnit.id, phase.id, session.id, 'activities', 'add', { id: generateId(), text: "Nova activitat", detail: "", time: "", challengeResponse: "", expanded: true })} className="text-xs text-orange-500 hover:text-orange-700 mt-2 flex items-center">
                                                                            <IconPlus /><span className="ml-1">Afegir activitat</span>
                                                                        </button>
                                                                    </td>
                                                                    
                                                                    {/* Hack de CSS (h-[1px] a la taula, h-full al div interior) */}
                                                                    <td className="p-0 align-top border-r border-gray-200 relative h-[1px]">
                                                                        <div className="h-full w-full overflow-y-auto custom-scroll p-3 flex flex-col">
                                                                            <ul className="space-y-2">
                                                                                {session.materials.map((mat) => (
                                                                                    <li key={mat.id} className={`text-sm group flex items-start ${session.completed ? 'opacity-70' : ''}`}>
                                                                                        <span className="text-gray-400 mr-2 mt-1 select-none">•</span>
                                                                                        <div className="flex-1 flex flex-col min-w-0">
                                                                                            <div className="flex items-center space-x-1">
                                                                                                {mat.url ? (
                                                                                                    <a href={mat.url} target="_blank" rel="noopener noreferrer" className="flex-1 text-sm text-blue-600 hover:text-blue-800 underline font-medium truncate" title={`Obrir: ${mat.url}`}>
                                                                                                        {mat.name || 'Enllaç'}
                                                                                                    </a>
                                                                                                ) : (
                                                                                                    <AutoTextarea 
                                                                                                        value={mat.name} 
                                                                                                        onChange={(v) => updateSessionArray(activeCourse.id, activeUnit.id, phase.id, session.id, 'materials', 'update', { itemId: mat.id, field: 'name', value: v })} 
                                                                                                        className="flex-1 text-sm text-gray-700 font-medium" 
                                                                                                        placeholder="Nom del material" 
                                                                                                    />
                                                                                                )}
                                                                                                
                                                                                                {mat.url && (
                                                                                                    <button 
                                                                                                        onClick={() => { const newName = prompt("Edita el nom del material:", mat.name); if(newName !== null) updateSessionArray(activeCourse.id, activeUnit.id, phase.id, session.id, 'materials', 'update', { itemId: mat.id, field: 'name', value: newName }); }} 
                                                                                                        className="text-xs px-1 opacity-0 group-hover:opacity-100 text-gray-400 hover:text-gray-700 transition-opacity" title="Editar Nom"
                                                                                                    >✏️</button>
                                                                                                )}

                                                                                                <button 
                                                                                                    onClick={() => { const url = prompt("Introdueix l'enllaç del material (deixa en blanc per eliminar-lo):", mat.url); if(url !== null) updateSessionArray(activeCourse.id, activeUnit.id, phase.id, session.id, 'materials', 'update', { itemId: mat.id, field: 'url', value: url }); }} 
                                                                                                    className={`text-xs px-1 hover:scale-110 transition-transform ${mat.url ? 'text-blue-600' : 'text-gray-300 hover:text-blue-400'}`} title="Afegir/Editar Enllaç"
                                                                                                >🔗</button>
                                                                                                <button onClick={() => updateSessionArray(activeCourse.id, activeUnit.id, phase.id, session.id, 'materials', 'delete', mat.id)} className="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 px-1 font-bold">×</button>
                                                                                            </div>
                                                                                        </div>
                                                                                    </li>
                                                                                ))}
                                                                            </ul>
                                                                            <button onClick={() => updateSessionArray(activeCourse.id, activeUnit.id, phase.id, session.id, 'materials', 'add', { id: generateId(), name: "", url: "" })} className="text-xs text-orange-500 hover:text-orange-700 mt-3 flex items-center">
                                                                                <IconPlus /><span className="ml-1">Afegir material</span>
                                                                            </button>
                                                                        </div>
                                                                    </td>
                                                                    
                                                                    <td className="p-0 align-top border-r border-gray-200 h-[1px]">
                                                                        <div className="h-full w-full overflow-y-auto custom-scroll p-3 flex flex-col">
                                                                            <AutoTextarea 
                                                                                value={session.comments}
                                                                                onChange={(val) => updateSession(activeCourse.id, activeUnit.id, phase.id, session.id, 'comments', val)}
                                                                                placeholder="Notes d'aplicació..."
                                                                                className={`text-sm italic flex-1 ${session.completed ? 'text-gray-600 opacity-80' : 'text-orange-800'}`}
                                                                            />
                                                                        </div>
                                                                    </td>

                                                                    <td className="p-3 align-middle text-center">
                                                                        <input 
                                                                            type="checkbox" 
                                                                            checked={session.completed}
                                                                            onChange={(e) => updateSession(activeCourse.id, activeUnit.id, phase.id, session.id, 'completed', e.target.checked)}
                                                                            className="w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-green-500 cursor-pointer accent-green-600"
                                                                        />
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}

                                                        {!phase.collapsed && (
                                                            <tr className="bg-gray-50/50">
                                                                <td colSpan="5" className="p-2 text-center">
                                                                    <button 
                                                                        onClick={() => addSession(activeCourse.id, activeUnit.id, phase.id)}
                                                                        className="inline-flex items-center px-3 py-1 text-sm text-gray-500 hover:text-orange-600 hover:bg-orange-100 rounded-full transition-colors font-medium"
                                                                    >
                                                                        <IconPlus /> <span className="ml-1">Afegir sessió a "{phase.name}"</span>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        )}
                                                    </React.Fragment>
                                                ))}
                                                
                                                {/* Botó per afegir nova fase al final de la taula */}
                                                <tr className="bg-white">
                                                    <td colSpan="5" className="p-4 text-center border-t border-gray-200">
                                                        <button 
                                                            onClick={() => addPhase(activeCourse.id, activeUnit.id)}
                                                            className="inline-flex items-center px-4 py-2 text-sm text-gray-500 border border-dashed border-gray-300 hover:border-orange-500 hover:text-orange-600 rounded-lg transition-colors font-medium bg-gray-50 hover:bg-orange-50"
                                                        >
                                                            <IconPlus /> <span className="ml-2">Afegir nova fase</span>
                                                        </button>
                                                    </td>
                                                </tr>

                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            );
                        })()}
                        
                        {!activeCourse && (
                            <div className="text-center py-20 text-gray-500">
                                No hi ha cap curs actiu. Crea'n un al menú superior.
                            </div>
                        )}
                    </main>

                    {/* Modal per Enganxar des de l'Excel (Existent) */}
                    {showPasteModal && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-[fadeIn_0.2s_ease-out]">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-5xl">
                                <h2 className="text-xl font-bold mb-2 text-gray-800">Pujar taula (Des d'Excel)</h2>
                                <p className="text-sm text-gray-600 mb-4 bg-blue-50 p-2 rounded border border-blue-100">
                                    Copia les cel·les del teu Excel/Numbers i <b>fés Ctrl+V (Enganxar) directament dins d'aquesta graella</b>. L'eina distribuirà cada text a la seva columna corresponent.
                                </p>
                                
                                <div className="border border-gray-300 rounded-lg overflow-hidden flex flex-col mb-5">
                                    <div className="overflow-y-auto max-h-72 bg-gray-50">
                                        <table className="w-full border-collapse table-fixed">
                                            <thead className="bg-gray-100 border-b border-gray-300 shadow-sm sticky top-0 z-10">
                                                <tr>
                                                    <th className="p-2 font-bold text-xs text-gray-600 border-r border-gray-300 text-center w-[10%]">Sessió</th>
                                                    <th className="p-2 font-bold text-xs text-gray-600 border-r border-gray-300 text-left w-[40%]">Activitat</th>
                                                    <th className="p-2 font-bold text-xs text-gray-600 border-r border-gray-300 text-left w-[25%]">Material</th>
                                                    <th className="p-2 font-bold text-xs text-gray-600 text-left w-[25%]">Comentaris</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {pasteRows.map((row, rIndex) => (
                                                    <tr key={rIndex} className="bg-white border-b border-gray-200 hover:bg-orange-50/30 transition-colors">
                                                        {row.map((cell, cIndex) => (
                                                            <td key={cIndex} className={`p-1 align-top border-r border-gray-200 last:border-r-0 ${cIndex === 0 ? 'w-[10%]' : cIndex === 1 ? 'w-[40%]' : 'w-[25%]'}`}>
                                                                <textarea
                                                                    className="w-full text-sm p-1.5 outline-none resize-none bg-transparent focus:bg-orange-50 focus:ring-1 focus:ring-orange-300 rounded overflow-hidden"
                                                                    rows={Math.max(1, cell.split('\n').length)}
                                                                    value={cell}
                                                                    onChange={e => {
                                                                        const newRows = [...pasteRows];
                                                                        newRows[rIndex][cIndex] = e.target.value;
                                                                        setPasteRows(newRows);
                                                                    }}
                                                                    onPaste={(e) => handlePasteToGrid(e, rIndex, cIndex)}
                                                                    placeholder={rIndex === 0 && cIndex === 1 ? "Ctrl+V aquí..." : ""}
                                                                />
                                                            </td>
                                                        ))}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        <div className="p-1">
                                            <button onClick={() => setPasteRows(prev => [...prev, ['', '', '', '']])} className="w-full py-2 text-xs text-gray-500 hover:bg-gray-200 hover:text-gray-700 font-medium transition-colors rounded">
                                                + Afegir fila manualment
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                                    <label className="text-sm font-semibold text-gray-700">Afegir a la fase:</label>
                                    <select value={pastePhaseId} onChange={e=>setPastePhaseId(e.target.value)} className="border border-gray-300 rounded p-1.5 text-sm bg-white focus:ring-orange-500 w-full sm:w-auto">
                                        <option value="">-- Selecciona la fase de destí --</option>
                                        {activeUnit?.phases.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                    </select>
                                </div>
                                <div className="mt-6 flex justify-end space-x-3">
                                    <button onClick={() => setShowPasteModal(false)} className="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors">Cancel·lar</button>
                                    <button 
                                        onClick={handlePasteSubmit} 
                                        disabled={!pastePhaseId || pasteRows.every(r => r.every(c => !c.trim()))} 
                                        className="px-5 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed font-medium transition-colors"
                                    >
                                        Afegir dades
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal per Exportar Excel */}
                    {showExportModal && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-[fadeIn_0.2s_ease-out]">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
                                <h2 className="text-xl font-bold mb-4 text-gray-800">Exportar Excel (.xlsx)</h2>
                                <p className="text-sm text-gray-600 mb-6">Selecciona el Curs i la Unitat Temporal per descarregar les dades de forma estructurada.</p>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-1">Curs a exportar:</label>
                                        <select 
                                            value={exportCourseId} 
                                            onChange={e => {
                                                setExportCourseId(e.target.value);
                                                const firstUnit = data.find(c => c.id === e.target.value)?.units[0]?.id || "";
                                                setExportUnitId(firstUnit);
                                            }} 
                                            className="w-full border border-gray-300 rounded p-2 text-sm bg-white focus:ring-orange-500 outline-none"
                                        >
                                            <option value="">-- Selecciona Curs --</option>
                                            {data.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-1">Unitat a exportar:</label>
                                        <select 
                                            value={exportUnitId} 
                                            onChange={e => setExportUnitId(e.target.value)} 
                                            className="w-full border border-gray-300 rounded p-2 text-sm bg-white focus:ring-orange-500 outline-none"
                                            disabled={!exportCourseId}
                                        >
                                            <option value="">-- Selecciona Unitat --</option>
                                            {data.find(c => c.id === exportCourseId)?.units.map(u => <option key={u.id} value={u.id}>{u.title}</option>)}
                                        </select>
                                    </div>
                                </div>
                                <div className="mt-8 flex justify-end space-x-3">
                                    <button onClick={() => setShowExportModal(false)} className="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors">Cancel·lar</button>
                                    <button 
                                        onClick={executeExportXLSX} 
                                        disabled={!exportCourseId || !exportUnitId} 
                                        className="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium transition-colors flex items-center"
                                    >
                                        <IconDownload /> <span className="ml-2">Descarregar Excel</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {toastMsg && (
                        <div className="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg flex items-center animate-[fadeIn_0.3s_ease-out] z-50">
                            <span className="text-green-400 mr-2">✓</span>
                            {toastMsg}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        // Si s'ha obert des de l'Agenda mitjançant un script de finestres vinculades, enviem avís de retorn
        if (window.opener) {
            window.opener.postMessage({ action: 'PROGRAMACIO_READY' }, "*");
        }
    });
    </script>
</body>
</html>
