<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PigeonEtics: Laboratorio Celular</title>
    
    <!-- Librer√≠as de React y Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; user-select: none; overflow-x: hidden; }
        
        /* Animaciones */
        .chromosome-hover:hover { filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.6)); transform: scale(1.05); cursor: grab; }
        .chromosome-hover:active { cursor: grabbing; }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }

        /* Zonas de arrastre/clic */
        .drop-zone { transition: all 0.2s; cursor: pointer; }
        .drop-zone.active { background-color: rgba(59, 130, 246, 0.1); border-color: #3b82f6; box-shadow: inset 0 0 10px rgba(59, 130, 246, 0.2); }
        .drop-zone.over { background-color: rgba(34, 197, 94, 0.1); border-color: #22c55e; }
        .drop-zone:hover { background-color: rgba(250, 204, 21, 0.05); }

        /* Hilos del huso acrom√°tico */
        .spindle-fibers {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(203, 213, 225, 0.4) 40px, rgba(203, 213, 225, 0.4) 42px);
            pointer-events: none;
            z-index: 0;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- GR√ÅFICO DEL CICLO CELULAR ---
        const CellCycleGraph = ({ type }) => {
            return (
                <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mt-6 w-full max-w-2xl mx-auto shrink-0">
                    <h3 className="font-bold text-slate-700 text-center mb-2">Evoluci√≥n de la Cantidad de ADN (Ciclo Celular)</h3>
                    <div className="relative w-full h-32">
                        <svg viewBox="0 0 400 120" className="w-full h-full overflow-visible">
                            {/* Ejes */}
                            <line x1="40" y1="10" x2="40" y2="90" stroke="#94a3b8" strokeWidth="2" />
                            <line x1="40" y1="90" x2="380" y2="90" stroke="#94a3b8" strokeWidth="2" />
                            
                            {/* Etiquetas Y */}
                            <text x="30" y="25" fontSize="12" textAnchor="end" fill="#64748b" fontWeight="bold">2C</text>
                            <text x="30" y="55" fontSize="12" textAnchor="end" fill="#64748b" fontWeight="bold">C</text>
                            <text x="30" y="85" fontSize="12" textAnchor="end" fill="#64748b" fontWeight="bold">¬ΩC</text>
                            
                            {/* Etiquetas X */}
                            <text x="80" y="110" fontSize="10" textAnchor="middle" fill="#64748b">G1</text>
                            <text x="140" y="110" fontSize="10" textAnchor="middle" fill="#64748b">S (Duplicaci√≥n)</text>
                            <text x="220" y="110" fontSize="10" textAnchor="middle" fill="#64748b">G2</text>
                            <text x="290" y="110" fontSize="10" textAnchor="middle" fill="#64748b">{type === 'meiosis' ? 'Meiosis I' : 'Mitosis'}</text>
                            {type === 'meiosis' && <text x="360" y="110" fontSize="10" textAnchor="middle" fill="#64748b">Meiosis II</text>}
                            
                            {/* L√≠neas Gu√≠a */}
                            <line x1="40" y1="20" x2="380" y2="20" stroke="#e2e8f0" strokeDasharray="4,4" />
                            <line x1="40" y1="50" x2="380" y2="50" stroke="#e2e8f0" strokeDasharray="4,4" />
                            <line x1="40" y1="80" x2="380" y2="80" stroke="#e2e8f0" strokeDasharray="4,4" />
                            
                            {/* Trazo del gr√°fico */}
                            {type === 'mitosis' ? (
                                <path d="M 40 50 L 100 50 L 160 20 L 250 20 L 270 20 L 290 50 L 360 50" fill="none" stroke="#3b82f6" strokeWidth="3" />
                            ) : (
                                <path d="M 40 50 L 100 50 L 160 20 L 250 20 L 270 20 L 290 50 L 320 50 L 350 80 L 380 80" fill="none" stroke="#a855f7" strokeWidth="3" />
                            )}
                        </svg>
                    </div>
                    <p className="text-xs text-slate-500 mt-2 text-center leading-relaxed">
                        C = Cantidad de ADN inicial. En la fase S de la interfase el ADN se duplica (2C). <br/>
                        {type === 'meiosis' 
                            ? 'Tras la Meiosis I la c√©lula vuelve a C. Al final de la Meiosis II, los gametos son HAPLOIDES (n) y tienen la mitad del material original (¬ΩC).' 
                            : 'Al final de la Mitosis, la c√©lula vuelve a tener la cantidad C original y es DIPLOIDE (2n).'}
                    </p>
                </div>
            );
        };

        // --- COMPONENTES VISUALES (CROMOSOMAS Y LOCUS) ---
        const LocusMarker = ({ x, y, allele, color, side }) => {
            if (!allele) return null;
            const isDominant = allele === 'C';
            const fontSize = isDominant ? "16" : "12";
            const fontWeight = isDominant ? "900" : "normal";
            
            if (side === 'left') {
                return (
                    <g>
                        <line x1={x-15} y1={y} x2={x} y2={y} stroke="white" strokeWidth="2.5" />
                        <rect x={x-28} y={y-8} width="14" height="16" rx="2" fill="white" stroke={color} strokeWidth="1.5"/>
                        <text x={x-21} y={y+4} fontSize={fontSize} fill="black" textAnchor="middle" fontWeight={fontWeight} pointerEvents="none">{allele}</text>
                    </g>
                );
            } else {
                return (
                    <g>
                        <line x1={x} y1={y} x2={x+15} y2={y} stroke="white" strokeWidth="2.5" />
                        <rect x={x+14} y={y-8} width="14" height="16" rx="2" fill="white" stroke={color} strokeWidth="1.5"/>
                        <text x={x+21} y={y+4} fontSize={fontSize} fill="black" textAnchor="middle" fontWeight={fontWeight} pointerEvents="none">{allele}</text>
                    </g>
                );
            }
        };

        const ChromosomeSVG = ({ id, type, chromatids, origin, crossedOver, isSelectable, isSelected, alleles, sexLabel }) => {
            const isLarge = type === 'lg';
            const h = isLarge ? 80 : 50;
            const w = 40;
            const mainColor = origin === 'mat' ? '#ef4444' : '#3b82f6'; 
            const altColor = origin === 'mat' ? '#3b82f6' : '#ef4444'; 

            const leftChromatid = crossedOver && origin === 'pat' ? (
                <g>
                    <path d={`M20,${h/2} Q10,${h/4} 15,5 Q25,${h/4} 20,${h/2}`} fill={mainColor} stroke="black" strokeWidth="1"/>
                    <path d={`M20,${h/2} Q10,${h*0.75} 15,${h-5} Q25,${h*0.75} 20,${h/2}`} fill={altColor} stroke="black" strokeWidth="1"/>
                </g>
            ) : (
                <path d={`M20,${h/2} Q10,${h/4} 15,5 Q25,${h/4} 20,${h/2} Q10,${h*0.75} 15,${h-5} Q25,${h*0.75} 20,${h/2}`} fill={mainColor} stroke="black" strokeWidth="1"/>
            );

            const rightChromatid = crossedOver && origin === 'mat' ? (
                <g>
                    <path d={`M20,${h/2} Q30,${h/4} 25,5 Q15,${h/4} 20,${h/2}`} fill={mainColor} stroke="black" strokeWidth="1"/>
                    <path d={`M20,${h/2} Q30,${h*0.75} 25,${h-5} Q15,${h*0.75} 20,${h/2}`} fill={altColor} stroke="black" strokeWidth="1"/>
                </g>
            ) : (
                <path d={`M20,${h/2} Q30,${h/4} 25,5 Q15,${h/4} 20,${h/2} Q30,${h*0.75} 25,${h-5} Q15,${h*0.75} 20,${h/2}`} fill={mainColor} stroke="black" strokeWidth="1"/>
            );

            const singleChromatid = crossedOver ? (
                <g>
                    <path d={`M20,${h/2} Q15,${h/4} 20,5 Q25,${h/4} 20,${h/2}`} fill={mainColor} stroke="black" strokeWidth="1"/>
                    <path d={`M20,${h/2} Q15,${h*0.75} 20,${h-5} Q25,${h*0.75} 20,${h/2}`} fill={altColor} stroke="black" strokeWidth="1"/>
                </g>
            ) : (
                <path d={`M20,${h/2} Q15,${h/4} 20,5 Q25,${h/4} 20,${h/2} Q15,${h*0.75} 20,${h-5} Q25,${h*0.75} 20,${h/2}`} fill={mainColor} stroke="black" strokeWidth="1"/>
            );

            const locusY = 20;

            return (
                <div className={`transition-all rounded-lg ${isSelected ? 'ring-4 ring-yellow-400 bg-yellow-100/50 scale-110 shadow-lg' : ''}`}>
                    <svg width={w} height={h + 20} viewBox={`0 0 ${w} ${h + 20}`} className={`overflow-visible ${isSelectable ? 'chromosome-hover' : ''}`}>
                        {chromatids === 2 ? (
                            <g>
                                <g transform="rotate(-15 20 40)">
                                    {leftChromatid}
                                    {alleles && <LocusMarker x={15} y={locusY} allele={alleles[0]} color={mainColor} side="left" />}
                                </g>
                                <g transform="rotate(15 20 40)">
                                    {rightChromatid}
                                    {alleles && <LocusMarker x={25} y={locusY} allele={alleles[1]} color={crossedOver ? altColor : mainColor} side="right" />}
                                </g>
                                <circle cx="20" cy={h/2} r="4" fill="#fbbf24" stroke="black" strokeWidth="1" />
                                {sexLabel && <text x="20" y={h + 15} fontSize="14" fill="black" textAnchor="middle" fontWeight="bold" pointerEvents="none">{sexLabel}</text>}
                            </g>
                        ) : (
                            <g>
                                {singleChromatid}
                                {alleles && <LocusMarker x={20} y={locusY} allele={alleles[0]} color={mainColor} side="left" />}
                                <circle cx="20" cy={h/2} r="3" fill="#fbbf24" stroke="black" strokeWidth="1" />
                                {sexLabel && <text x="20" y={h + 15} fontSize="14" fill="black" textAnchor="middle" fontWeight="bold" pointerEvents="none">{sexLabel}</text>}
                            </g>
                        )}
                    </svg>
                </div>
            );
        };

        const FragLegSVG = ({ color, inTaller, side, isSelected, onClick }) => {
            const dPath = side === 'left' ? "M20,0 Q0,25 10,45 Q30,25 20,0" : "M0,0 Q20,25 10,45 Q-10,25 0,0";
            return (
                <div 
                    draggable 
                    onClick={onClick}
                    onDragStart={(e) => { e.stopPropagation(); e.dataTransfer.setData('application/json', JSON.stringify({ source: inTaller ? 'taller' : (color === 'red' ? 'redChr' : 'blueChr'), color })); }} 
                    className={`cursor-grab hover:scale-110 transition-all rounded-md ${inTaller ? 'relative z-10 mx-2' : 'absolute top-0'} ${isSelected ? 'ring-4 ring-yellow-400 bg-yellow-100 shadow-md' : ''}`}
                    style={inTaller ? {} : { left: '0px' }}
                >
                    <svg width="20" height="45" viewBox="0 0 20 45" className="overflow-visible">
                        <path d={dPath} fill={color === 'red' ? '#ef4444' : '#3b82f6'} stroke="black" strokeWidth="2"/>
                    </svg>
                </div>
            );
        };

        // --- ESTADO INICIAL (Hembra ZW, heterocig√≥tica Cc) ---
        const getInitialChromosomes = () => [
            { id: 'c1_mat', type: 'lg', origin: 'mat', chromatids: 2, crossedOver: false, zone: 'nucleus', alleles: ['c', 'c'] },
            { id: 'c1_pat', type: 'lg', origin: 'pat', chromatids: 2, crossedOver: false, zone: 'nucleus', alleles: ['C', 'C'] },
            { id: 'c2_mat', type: 'sm', origin: 'mat', chromatids: 2, crossedOver: false, zone: 'nucleus', sexLabel: 'W' },
            { id: 'c2_pat', type: 'sm', origin: 'pat', chromatids: 2, crossedOver: false, zone: 'nucleus', sexLabel: 'Z' }
        ];

        // --- COMPONENTE PRINCIPAL ---
        const App = () => {
            const getSaved = () => {
                try { return JSON.parse(localStorage.getItem('pigeonetics_sim_data_v16')) || {}; }
                catch(e) { return {}; }
            };
            const saved = getSaved();

            const [appMode, setAppMode] = useState(saved.appMode || 'selection'); 
            const [answers, setAnswers] = useState(saved.answers || {});
            const [showFicha, setShowFicha] = useState(false);

            const [mode, setMode] = useState(saved.mode || 'mitosis');
            const [phase, setPhase] = useState(saved.phase || 'profase'); 
            const [spindleActive, setSpindleActive] = useState(saved.spindleActive || false); 
            const [isCondensed, setIsCondensed] = useState(saved.isCondensed || false); 
            const [chromatinZone, setChromatinZone] = useState(saved.chromatinZone || 'toolbox'); 
            const [chromosomes, setChromosomes] = useState(saved.chromosomes || getInitialChromosomes());
            const [health, setHealth] = useState(saved.health ?? 100);
            const [feedback, setFeedback] = useState({ type: 'info', msg: 'Toca o arrastra la cromatina desde la caja de herramientas hacia el citoplasma para empezar.' });
            const [cytokinesisDone, setCytokinesisDone] = useState(saved.cytokinesisDone || false); // NUEVO ESTADO PARA CITOCINESIS
            
            const [selectedItem, setSelectedItem] = useState(null); 
            const [selectedFrag, setSelectedFrag] = useState(null); 
            
            const [showPunnett, setShowPunnett] = useState(false); 
            const [showCrossingModal, setShowCrossingModal] = useState(false); 
            const [punnettTicks, setPunnettTicks] = useState(Array(16).fill(false)); 
            
            const [coFragments, setCoFragments] = useState({ redChr: 'red', blueChr: 'blue', taller: [] });

            const [phaseToast, setPhaseToast] = useState(null);

            useEffect(() => {
                localStorage.setItem('pigeonetics_sim_data_v16', JSON.stringify({ mode, phase, spindleActive, isCondensed, chromatinZone, chromosomes, health, appMode, answers, cytokinesisDone }));
            }, [mode, phase, spindleActive, isCondensed, chromatinZone, chromosomes, health, appMode, answers, cytokinesisDone]);
            
            useEffect(() => {
                let text = '';
                if(phase === 'profase') text = 'El ADN se condensa y se prepara para la divisi√≥n.';
                if(phase === 'metafase') text = 'El material gen√©tico se alinea en el centro (ecuador).';
                if(phase === 'anafase') text = 'El huso separa el material gen√©tico hacia los polos.';
                if(phase === 'telofase' || phase === 'telofase1') text = 'La c√©lula se prepara para dividir el citoplasma.';

                setPhaseToast({ phase, text });
                const timer = setTimeout(() => setPhaseToast(null), 4000);
                return () => clearTimeout(timer);
            }, [phase]);

            const phaseColors = {
                profase: 'text-teal-600 border-teal-500', metafase: 'text-yellow-600 border-yellow-500',
                anafase: 'text-purple-600 border-purple-500', telofase1: 'text-green-600 border-green-500', telofase: 'text-green-600 border-green-500'
            };
            const phaseBgColors = {
                profase: 'bg-teal-500', metafase: 'bg-yellow-500', anafase: 'bg-purple-500', telofase1: 'bg-green-500', telofase: 'bg-green-500'
            };

            const [tutorialPopup, setTutorialPopup] = useState({
                show: true, minimized: false,
                title: 'Bienvenido a PigeonEtics',
                text: <span>Descubriremos c√≥mo heredan las palomas sus caracter√≠sticas.<br/><br/>F√≠jate en la LEYENDA:<br/>El cromosoma ROJO viene de la MADRE.<br/>El cromosoma AZUL viene del PADRE.<br/><br/>Para empezar, experimenta con la <strong className="text-teal-600">MITOSIS</strong>. Toca o arrastra la bola de cromatina de las herramientas al citoplasma libre.</span>
            });

            const clearData = () => {
                if(window.confirm('¬øSeguro que quieres borrar todos los datos guardados y empezar de cero?')) {
                    localStorage.removeItem('pigeonetics_sim_data_v16');
                    window.location.reload();
                }
            };

            const handleAns = (key, val) => setAnswers(prev => ({...prev, [key]: val}));

            const resetSim = (newMode) => {
                setMode(newMode);
                setPhase('profase');
                setSpindleActive(false); 
                setIsCondensed(false);
                setChromatinZone('toolbox');
                setShowPunnett(false);
                setShowCrossingModal(false);
                setPunnettTicks(Array(16).fill(false));
                setCoFragments({ redChr: 'red', blueChr: 'blue', taller: [] });
                setChromosomes(getInitialChromosomes());
                setSelectedItem(null);
                setSelectedFrag(null);
                setCytokinesisDone(false);
                setHealth(100);
                
                if(newMode === 'mitosis') {
                    setFeedback({ type: 'info', msg: 'MITOSIS: Mueve la cromatina de las herramientas al citoplasma.' });
                    setTutorialPopup({ show: true, minimized: false, title: 'Modo Mitosis', text: <span>La <strong className="text-teal-600">mitosis</strong> es el proceso por el cual una c√©lula se divide para formar <strong className="text-teal-600">dos c√©lulas hijas gen√©ticamente id√©nticas (DIPLOIDES)</strong>.<br/><br/>Objetivo: Investiga c√≥mo lograr dividir la c√©lula correctamente paso a paso. ¬°Empieza por la Profase!</span> });
                }
                else if(newMode === 'meiosis') {
                    setFeedback({ type: 'info', msg: 'MEIOSIS I: Mueve la cromatina, condensa el ADN y junta los hom√≥logos uno sobre el otro.' });
                    setTutorialPopup({ show: true, minimized: false, title: 'Modo Meiosis (Hembra ZW)', text: <span>La <strong className="text-teal-600">meiosis</strong> reduce a la mitad la informaci√≥n gen√©tica para crear <strong className="text-teal-600">√≥vulos (HAPLOIDES)</strong>.<br/><br/>En esta paloma hembra (cromosomas ZW), un cromosoma grande lleva el alelo recesivo "c" (Cresta) y el otro el dominante "C" (Sin Cresta).<br/><br/>OBJETIVO: Generar gametos para cruzar con un macho y obtener una cr√≠a hembra con cresta.<br/><br/>Instrucci√≥n inicial: Toca/arrastra la cromatina al citoplasma, cond√©nsala y junta las parejas de cromosomas.</span> });
                }
                else {
                    setFeedback({ type: 'warning', msg: 'RETO: Causa intencionadamente una trisom√≠a en una c√©lula hija.' });
                    setTutorialPopup({ show: true, minimized: false, title: 'Modo Investigador', text: <span>¬øQu√© ocurre cuando la maquinaria de divisi√≥n falla?<br/><br/>Tu objetivo NO es hacerlo bien. Debes provocar intencionadamente un error mec√°nico en la <strong className="text-purple-600">Anafase</strong> para generar una c√©lula con exceso de ADN (Aneuploid√≠a).</span> });
                }
            };

            const handleDragStart = (e, item) => { setSelectedItem(item); };
            const handleDragOver = (e) => { e.preventDefault(); };
            
            const processDrop = (itemToMove, targetZone) => {
                if (!itemToMove) return;

                let isValid = true;
                let msg = '';
                let healthPenalty = 0;

                let actualTargetZone = targetZone;
                let targetChrom = null;
                if (targetZone.startsWith('c_')) {
                    const targetId = targetZone.substring(2);
                    targetChrom = chromosomes.find(c => c.id === targetId);
                    if (targetChrom) actualTargetZone = targetChrom.zone;
                }

                if (phase === 'profase') {
                    if (!isCondensed) {
                        if (actualTargetZone === 'cytoplasm' && itemToMove.type === 'chromatin') {
                            setChromatinZone('cytoplasm');
                            setChromosomes(prev => prev.map(c => ({...c, zone: 'cytoplasm'})));
                            msg = 'Cromatina en el citoplasma. Ahora utiliza la HERRAMIENTA de la derecha para CONDENSAR el ADN.';
                        } else {
                            isValid = false; msg = 'Mueve el ovillo de cromatina al citoplasma primero.'; healthPenalty = 5;
                        }
                    } else if (mode === 'meiosis') {
                        if (actualTargetZone === 'cytoplasm') {
                            const homolog = chromosomes.find(c => c.type === itemToMove.type && c.id !== itemToMove.id && (c.zone === 'cytoplasm' || c.zone === 'nucleus'));
                            if (homolog) {
                                setChromosomes(prev => prev.map(c => 
                                    (c.id === itemToMove.id || c.id === homolog.id) ? { ...c, zone: 'bivalent_' + homolog.type } : c
                                ));
                                msg = '¬°Bivalente formado! Usa las tijeras en la caja de herramientas para realizar el Crossing-Over.';
                                const bivalentsCount = chromosomes.filter(c => c.zone.includes('bivalent')).length;
                                if (bivalentsCount === 0) { 
                                    setTutorialPopup({ show: true, minimized: false, title: 'Bivalentes Formados', text: <span>Has unido los <strong className="text-teal-600">cromosomas hom√≥logos</strong>.<br/><br/>Para que la Meiosis genere variabilidad, deben intercambiar fragmentos (<strong className="text-teal-600">Crossing-Over</strong>).<br/><br/>Abre el taller de recombinaci√≥n a la derecha.</span> });
                                }
                                if(msg) setFeedback({ type: 'success', msg });
                                return;
                            } else {
                                setChromosomes(prev => prev.map(c => c.id === itemToMove.id ? { ...c, zone: 'cytoplasm' } : c));
                            }
                        } else if (targetChrom && targetChrom.type === itemToMove.type && targetChrom.id !== itemToMove.id) {
                            setChromosomes(prev => prev.map(c => 
                                (c.id === itemToMove.id || c.id === targetChrom.id) ? { ...c, zone: 'bivalent_' + targetChrom.type } : c
                            ));
                            msg = '¬°Bivalente formado! Usa las tijeras en la caja de herramientas para realizar el Crossing-Over.';
                        } else {
                            isValid = false; msg = '¬°Error! Solo los cromosomas HOM√ìLOGOS (mismo tama√±o) se pueden emparejar.'; healthPenalty = 10;
                        }
                    } else {
                        if (itemToMove.id) {
                            setChromosomes(prev => prev.map(c => c.id === itemToMove.id ? { ...c, zone: actualTargetZone } : c));
                        }
                    }
                } 
                else if (phase === 'metafase') {
                    if (actualTargetZone === 'equator') {
                        const item = chromosomes.find(c => c.id === itemToMove.id);
                        if (item.zone.startsWith('bivalent')) {
                            const newZone = item.zone.replace('bivalent', 'equator_bivalent');
                            setChromosomes(prev => prev.map(c => c.zone === item.zone ? { ...c, zone: newZone } : c));
                        } else {
                            setChromosomes(prev => prev.map(c => c.id === itemToMove.id ? { ...c, zone: 'equator' } : c));
                        }
                    } else {
                        isValid = false; msg = 'En la Metafase, los cromosomas deben alinearse en la PLACA ECUATORIAL.'; healthPenalty = 5;
                    }
                }
                else if (phase === 'anafase') {
                    if (!spindleActive) {
                        isValid = false; msg = '¬°Debes activar el Huso Mit√≥tico (caja de herramientas) para poder mover los cromosomas a los polos!'; healthPenalty = 5;
                    } else {
                        const item = chromosomes.find(c => c.id === itemToMove.id);
                        if (mode === 'mitosis') {
                            if (item.chromatids === 2) {
                                isValid = false; msg = '¬°Error! En la Mitosis, debes romper el centr√≥mero primero (haz clic sobre √©l) para separar las CROM√ÅTIDAS HERMANAS.'; healthPenalty = 15;
                            } else {
                                setChromosomes(prev => prev.map(c => c.id === itemToMove.id ? { ...c, zone: actualTargetZone } : c));
                            }
                        } else if (mode === 'meiosis') { 
                            if (item.zone.startsWith('equator_bivalent')) {
                                isValid = false; msg = '¬°Error! En la Meiosis I, debes separar los hom√≥logos primero.'; healthPenalty = 10;
                            } else if (item.chromatids === 1) {
                                isValid = false; msg = '¬°Error Grave! En la Meiosis I se separan CROMOSOMAS HOM√ìLOGOS enteros (2 crom√°tidas), no crom√°tidas individuales.'; healthPenalty = 20;
                            } else {
                                setChromosomes(prev => prev.map(c => c.id === itemToMove.id ? { ...c, zone: actualTargetZone } : c));
                            }
                        } else if (mode === 'repte') {
                            setChromosomes(prev => prev.map(c => c.id === itemToMove.id ? { ...c, zone: actualTargetZone } : c));
                            msg = 'Has movido material gen√©tico hacia un polo... veamos el resultado.';
                        }
                    }
                }

                if (!isValid) {
                    setHealth(h => Math.max(0, h - healthPenalty));
                    setFeedback({ type: 'error', msg });
                } else {
                    if(msg) setFeedback({ type: 'success', msg });
                }
            };

            const handleDrop = (e, targetZone) => {
                e.preventDefault(); e.stopPropagation();
                processDrop(selectedItem, targetZone);
                setSelectedItem(null);
            };

            const handleZoneClick = (targetZone, e) => {
                if(e) { e.preventDefault(); e.stopPropagation(); }
                if (selectedItem) {
                    processDrop(selectedItem, targetZone);
                    setSelectedItem(null);
                }
            };

            const handleChromClick = (e, chrom) => {
                e.stopPropagation(); e.preventDefault();
                
                if (phase === 'anafase' && spindleActive) {
                    if (mode === 'meiosis' && chrom.zone.startsWith('equator_bivalent')) {
                        setChromosomes(prev => prev.map(ch => ch.zone === chrom.zone ? { ...ch, zone: 'equator' } : ch));
                        setFeedback({ type: 'success', msg: '¬°Bivalente separado por el huso! Ahora mueve un hom√≥logo a cada polo.' });
                        setSelectedItem(null);
                        return;
                    }
                    if (mode !== 'meiosis' && chrom.chromatids === 2 && chrom.zone === 'equator') {
                        const newChroms = chromosomes.filter(ch => ch.id !== chrom.id);
                        const leftAllele = chrom.alleles ? chrom.alleles[0] : null;
                        const rightAllele = chrom.alleles ? chrom.alleles[1] : null;
                        
                        newChroms.push({ ...chrom, id: chrom.id + '_L', chromatids: 1, alleles: leftAllele ? [leftAllele, null] : null });
                        newChroms.push({ ...chrom, id: chrom.id + '_R', chromatids: 1, alleles: rightAllele ? [rightAllele, null] : null });
                        setChromosomes(newChroms);
                        setFeedback({ type: 'success', msg: '¬°Centr√≥mero dividido! Ahora mueve una crom√°tida hermana a cada polo.' });
                        setSelectedItem(null);
                        return;
                    }
                } else if (phase === 'anafase' && !spindleActive && chrom.zone.includes('equator')) {
                    setFeedback({ type: 'error', msg: '¬°Debes activar el Huso Mit√≥tico en la caja de herramientas primero!' });
                    setHealth(h => Math.max(0, h - 5));
                    return;
                }

                if (selectedItem && selectedItem.id !== chrom.id) {
                    handleZoneClick(`c_${chrom.id}`, e); 
                } else {
                    setSelectedItem(selectedItem?.id === chrom.id ? null : chrom); 
                }
            };

            useEffect(() => {
                checkPhaseCompletion(chromosomes);
            }, [chromosomes, isCondensed]);

            const checkPhaseCompletion = (currentChroms) => {
                if (phase === 'profase') {
                    if (mode === 'mitosis' || mode === 'repte') {
                        const allOut = currentChroms.every(c => c.zone === 'cytoplasm' || c.zone === 'equator');
                        if (isCondensed && allOut && currentChroms.length > 0) { 
                            setPhase('metafase'); 
                            setFeedback({ type: 'info', msg: '¬°Metafase! Mueve los cromosomas a la placa ecuatorial.' }); 
                            setTutorialPopup({ show: true, minimized: false, title: '¬øPor qu√© alinearlos en el centro?', text: <span>Acabas de entrar en la <strong className="text-yellow-600">Metafase</strong>.<br/><br/>Ahora tu objetivo es mover todos los cromosomas al <strong className="text-yellow-600">ecuador celular</strong>.<br/><br/>Organizarlos perfectamente en el medio asegura que, al dividirse, cada lado recibir√° exactamente el mismo material.</span> });
                        }
                    } else if (mode === 'meiosis') {
                        const bivalents = currentChroms.filter(c => c.zone.startsWith('bivalent'));
                        const allCrossed = bivalents.every(c => c.crossedOver);
                        if (bivalents.length === 4 && allCrossed) { 
                            setPhase('metafase'); 
                            setFeedback({ type: 'info', msg: 'Profase I Completada. Ahora mueve los bivalentes a la placa ecuatorial.' }); 
                            setTutorialPopup({ show: true, minimized: false, title: 'Metafase I', text: <span>Profase completada.<br/><br/>Ahora debes mover los <strong className="text-yellow-600">bivalentes enteros</strong> (las parejas) al centro de la c√©lula.<br/><br/>A diferencia de la mitosis, aqu√≠ los cromosomas hom√≥logos se alinean juntos porque no queremos romperlos, sino separar el padre de la madre.</span> });
                        }
                    }
                }
                else if (phase === 'metafase') {
                    const allEq = currentChroms.every(c => c.zone === 'equator' || c.zone.startsWith('equator_bivalent'));
                    if (allEq && currentChroms.length > 0) {
                        setFeedback({ type: 'info', msg: 'Alineaci√≥n correcta. ¬°Anafase! Activa el Huso Mit√≥tico para separar el material.' });
                        setPhase('anafase'); 
                    }
                }
            };

            const validateResult = () => {
                const poleTop = chromosomes.filter(c => c.zone === 'poleTop');
                const poleBottom = chromosomes.filter(c => c.zone === 'poleBottom');

                if (poleTop.length + poleBottom.length !== chromosomes.length) {
                    setFeedback({ type: 'warning', msg: 'Todav√≠a quedan cromosomas sin asignar a un polo.' });
                    return;
                }

                if (mode === 'mitosis') {
                    const isValidTop = poleTop.length === 4 && poleTop.every(c => c.chromatids === 1);
                    const isValidBottom = poleBottom.length === 4 && poleBottom.every(c => c.chromatids === 1);
                    
                    const topOrigins = poleTop.map(c => c.id.replace('_L', '').replace('_R', ''));
                    const bottomOrigins = poleBottom.map(c => c.id.replace('_L', '').replace('_R', ''));
                    const hasDuplicateOriginTop = new Set(topOrigins).size !== topOrigins.length;
                    const hasDuplicateOriginBottom = new Set(bottomOrigins).size !== bottomOrigins.length;

                    if (isValidTop && isValidBottom && !hasDuplicateOriginTop && !hasDuplicateOriginBottom && health > 0) {
                        setPhase('telofase');
                        setCytokinesisDone(false);
                        setFeedback({ type: 'info', msg: 'Anafase correcta. Activa el Anillo Contr√°ctil para dividir la c√©lula.' });
                        setTutorialPopup({ show: true, minimized: false, title: 'Llegando a la Telofase', text: <span>Los cromosomas han llegado a los polos y se est√°n descondensando.<br/><br/>Ahora necesitas dividir f√≠sicamente el citoplasma en dos. Busca la herramienta del <strong className="text-pink-600">Anillo Contr√°ctil</strong> en el men√∫ de herramientas.</span>});
                    } else if (isValidTop && isValidBottom && (hasDuplicateOriginTop || hasDuplicateOriginBottom)) {
                        setFeedback({ type: 'error', msg: '¬°Cuidado! Has puesto dos crom√°tidas del MISMO cromosoma inicial (mismo color) en el mismo polo. Las c√©lulas tendr√°n informaci√≥n duplicada.' });
                    } else {
                        setFeedback({ type: 'error', msg: 'Error en la divisi√≥n. Las c√©lulas resultantes tienen anomal√≠as cromos√≥micas.' });
                    }
                } 
                else if (mode === 'meiosis') {
                    const topLg = poleTop.filter(c => c.type === 'lg');
                    const topSm = poleTop.filter(c => c.type === 'sm');
                    const botLg = poleBottom.filter(c => c.type === 'lg');
                    const botSm = poleBottom.filter(c => c.type === 'sm');

                    if (topLg.length === 1 && topSm.length === 1 && botLg.length === 1 && botSm.length === 1 && poleTop.every(c => c.chromatids === 2)) {
                        setPhase('telofase1');
                        setCytokinesisDone(false);
                        setFeedback({ type: 'info', msg: 'Anafase I completada. Activa el Anillo Contr√°ctil para dividir la c√©lula.' });
                        setTutorialPopup({ show: true, minimized: false, title: 'Llegando a la Telofase I', text: <span>Los cromosomas hom√≥logos han llegado a los polos.<br/><br/>Para finalizar esta primera divisi√≥n, debes dividir el citoplasma usando el <strong className="text-pink-600">Anillo Contr√°ctil</strong> en las herramientas.</span>});
                    } else {
                        setFeedback({ type: 'error', msg: 'Fallo en la disyunci√≥n hom√≥loga. Se generar√≠an gametos inviables.' });
                    }
                }
                else if (mode === 'repte') {
                    const topCount = poleTop.length;
                    const botCount = poleBottom.length;
                    if (topCount !== botCount) {
                        setPhase('telofase');
                        setCytokinesisDone(false);
                        setFeedback({ type: 'info', msg: 'Anafase completada. Activa el Anillo Contr√°ctil para dividir la c√©lula.' });
                        setTutorialPopup({ show: true, minimized: false, title: 'Llegando a la Telofase', text: <span>Usa el <strong className="text-pink-600">Anillo Contr√°ctil</strong> para dividir la c√©lula y ver el resultado de tu experimento de no-disyunci√≥n.</span>});
                    } else {
                        setFeedback({ type: 'error', msg: 'Divisi√≥n equitativa detectada. No has logrado modelizar la trisom√≠a. ¬°Vuelve a intentarlo!' });
                    }
                }
            };

            const triggerMeiosisII = () => {
                setPhase('telofase');
                setCytokinesisDone(true); // Se asume autom√°tica en la M2 para simplificar la simulaci√≥n
                setFeedback({ type: 'success', msg: '¬°Meiosis II finalizada! Gametos Haploides generados.' });
                setTutorialPopup({ show: true, minimized: false, title: 'El milagro de la Meiosis', text: <span>¬°Impresionante! Has completado la Meiosis II.<br/><br/>An√°lisis y Simplificaci√≥n:<br/>En clase simulamos con un solo par, pero recuerda que el ADN se duplic√≥ antes en la Interfase (C a 2C). La Meiosis I separ√≥ los hom√≥logos. La Meiosis II es similar a una mitosis, pero ocurre en c√©lulas haploides, separando las crom√°tidas hermanas.<br/><br/>El resultado final son <strong className="text-green-600">4 √≥vulos HAPLOIDES (n) gen√©ticamente diferentes</strong>. Cada uno tiene un <strong className="text-green-600">CROMOSOMA ENTERO SIMPLE (cantidad ¬ΩC)</strong>. ¬°No son cromosomas rotos, son cromosomas simples maduros!<br/><br/>Abre la fase de fecundaci√≥n para el paso final.</span> });
            };

            const processDropCO = (target, fragObj) => {
                if(!fragObj) return;
                setCoFragments(prev => {
                    const next = { ...prev };
                    
                    if (fragObj.source === 'redChr') next.redChr = null;
                    if (fragObj.source === 'blueChr') next.blueChr = null;
                    if (fragObj.source === 'taller') {
                        const index = next.taller.indexOf(fragObj.color);
                        if (index > -1) next.taller.splice(index, 1);
                    }

                    if (target === 'taller') {
                        next.taller.push(fragObj.color);
                    } else if (target === 'redChr') {
                        if (next.redChr) next.taller.push(next.redChr);
                        next.redChr = fragObj.color;
                    } else if (target === 'blueChr') {
                        if (next.blueChr) next.taller.push(next.blueChr);
                        next.blueChr = fragObj.color;
                    }
                    return next;
                });
            };

            const handleDropCO = (target, e) => {
                e.preventDefault(); e.stopPropagation();
                const dataStr = e.dataTransfer.getData('application/json');
                if (!dataStr) return;
                processDropCO(target, JSON.parse(dataStr));
                setSelectedFrag(null);
            };

            const handleZoneClickCO = (target, e) => {
                if(e) { e.preventDefault(); e.stopPropagation(); }
                if(selectedFrag) {
                    processDropCO(target, selectedFrag);
                    setSelectedFrag(null);
                }
            };

            const applyCrossingOver = () => {
                if (coFragments.redChr === 'blue' && coFragments.blueChr === 'red') {
                    const newChroms = chromosomes.map(c => {
                        if (c.zone.includes('bivalent') && c.type === 'lg') {
                            if (c.origin === 'mat') return {...c, crossedOver: true, alleles: ['c', 'C']};
                            if (c.origin === 'pat') return {...c, crossedOver: true, alleles: ['C', 'c']};
                        }
                        if (c.zone.includes('bivalent') && c.type === 'sm') {
                            return {...c, crossedOver: true}; 
                        }
                        return c;
                    });
                    setChromosomes(newChroms);
                    setShowCrossingModal(false);
                    setFeedback({ type: 'success', msg: '¬°Crossing-Over realizado manualmente con √©xito! Has intercambiado los fragmentos.' });
                    setTutorialPopup({ show: true, minimized: false, title: 'Crossing-Over Exitoso', text: <span>¬°Has actuado como la enzima de recombinaci√≥n!<br/><br/>Al intercambiar fragmentos entre <strong className="text-teal-600">crom√°tidas no hermanas de cromosomas hom√≥logos</strong> (materno y paterno), has mezclado su informaci√≥n gen√©tica y creado <strong className="text-teal-600">variabilidad gen√©tica</strong>.<br/><br/>Ahora, la crom√°tida derecha roja lleva el alelo "C" y la azul lleva el "c".</span> });
                }
            };

            const togglePunnettTick = (idx) => {
                const newTicks = [...punnettTicks];
                newTicks[idx] = !newTicks[idx];
                setPunnettTicks(newTicks);
            };

            const renderZone = (zoneName, label) => {
                const inZone = chromosomes.filter(c => c.zone === zoneName);
                return (
                    <div 
                        className={`border-2 border-dashed rounded-xl p-4 min-h-[120px] w-full max-w-[95%] mx-auto flex justify-center items-center gap-6 flex-wrap drop-zone relative`} 
                        onDragOver={handleDragOver} 
                        onDrop={(e) => handleDrop(e, zoneName)}
                        onClick={(e) => handleZoneClick(zoneName, e)}
                    >
                        <span className="absolute inset-0 flex items-center justify-center text-xl font-black text-slate-200 uppercase tracking-widest pointer-events-none text-center">{label}</span>
                        {inZone.map(c => (
                            <div 
                                key={c.id} 
                                draggable 
                                className="relative z-10 pointer-events-auto p-2 cursor-pointer" 
                                onDragStart={(e) => handleDragStart(e, c)}
                                onClick={(e) => handleChromClick(e, c)}
                            >
                                <ChromosomeSVG {...c} isSelectable={true} isSelected={selectedItem?.id === c.id} />
                            </div>
                        ))}
                    </div>
                );
            };

            const generarTextoFicha = () => {
                return `üß¨ Cuaderno de Laboratorio: Misi√≥n PigeonEtics

--- Parte 1: Modo MITOSIS (El arte de la clonaci√≥n celular) ---
1. Profase: Preparando el material
P: ¬øPor qu√© se condensa el ADN antes de la divisi√≥n?
R: ${answers.mit_pro_2 || ''}

P: ¬øCu√°ntos cromosomas hay ahora mismo en el n√∫cleo de la c√©lula?
R: ${answers.mit_pro_3 || ''}

P: Define con tus palabras la diferencia entre "Cromatina" y "Cromosoma".
R: ${answers.mit_pro_1 || ''}

2. Metafase: Orden en la sala
P: ¬øPor qu√© es tan importante que los cromosomas se alineen perfectamente en el centro (ecuador) antes de dividirse?
R: ${answers.mit_met_1 || ''}

3. Anafase y Telofase: La separaci√≥n
P: ¬øQu√© es el huso mit√≥tico y c√≥mo funciona como "cables de arrastre"?
R: ${answers.mit_ana_1 || ''}

P: ¬øLas c√©lulas resultantes son id√©nticas o diferentes a la c√©lula madre original? ¬øQu√© significa que sean DIPLOIDES (2n)?
R: ${answers.mit_tel_1 || ''}

P: An√°lisis del Gr√°fico: ¬øQu√© ocurre con la cantidad de ADN en la fase S de la interfase? ¬øCon cu√°nta cantidad de ADN termina la c√©lula al final de la mitosis?
R: ${answers.mit_tel_2 || ''}

--- Parte 2: Modo MEIOSIS (La f√°brica de gametos) ---
1. Profase I y la Mesa de Recombinaci√≥n
P: ¬øQu√© es el Crossing-over y por qu√© es una ventaja evolutiva tan importante para las especies?
R: ${answers.mei_pro_1 || ''}

2. Metafase I y Anafase I
P: A diferencia de la mitosis, ¬øqu√© est√°s separando al activar el huso en la Anafase I?
R: ${answers.mei_ana_1 || ''}

3. Meiosis II y Resultado Final
P: ¬øCu√°ntas c√©lulas finales (√≥vulos) has obtenido? ¬øSon id√©nticas entre s√≠? ¬øQu√© significa que sean HAPLOIDES (n)?
R: ${answers.mei_tel_1 || ''}

P: An√°lisis del Gr√°fico: Al final de la Meiosis II, ¬øcu√°nta cantidad de ADN tiene cada gameto (√≥vulo) respecto a la c√©lula original?
R: ${answers.mei_tel_2 || ''}

--- Parte 3: Fase de Fecundaci√≥n (Cuadro de Punnett) ---
P: ¬øCu√°l ha sido la probabilidad (fracci√≥n) obtenida de hembras con cresta?
R: ${answers.punnett_1 || ''}

--- Parte 4: Reto Investigador (Errores en la Matrix) ---
P: ¬øC√≥mo se llama el error de no separar correctamente los cromosomas? ¬øQu√© s√≠ndrome humano conocido se produce si esto ocurre en el par de cromosomas 21?
R: ${answers.reto_1 || ''}
`;
            };

            const topLg = chromosomes.find(c => c.zone === 'poleTop' && c.type === 'lg');
            const topSm = chromosomes.find(c => c.zone === 'poleTop' && c.type === 'sm');
            const botLg = chromosomes.find(c => c.zone === 'poleBottom' && c.type === 'lg');
            const botSm = chromosomes.find(c => c.zone === 'poleBottom' && c.type === 'sm');

            const generatedEggs = (topLg && topSm && botLg && botSm) ? [
                { id: 'egg1', lg: {...topLg, chromatids: 1, crossedOver: false, alleles: [topLg.alleles[0]]}, sm: {...topSm, chromatids: 1, crossedOver: false} },
                { id: 'egg2', lg: {...topLg, chromatids: 1, crossedOver: topLg.crossedOver, alleles: [topLg.alleles[1]]}, sm: {...topSm, chromatids: 1, crossedOver: topSm.crossedOver} },
                { id: 'egg3', lg: {...botLg, chromatids: 1, crossedOver: false, alleles: [botLg.alleles[0]]}, sm: {...botSm, chromatids: 1, crossedOver: false} },
                { id: 'egg4', lg: {...botLg, chromatids: 1, crossedOver: botLg.crossedOver, alleles: [botLg.alleles[1]]}, sm: {...botSm, chromatids: 1, crossedOver: botSm.crossedOver} }
            ] : [];

            const maleSperms = [1, 2, 3, 4].map(i => ({
                id: `sperm${i}`,
                lg: { type: 'lg', chromatids: 1, origin: 'pat', alleles: ['c'], crossedOver: false },
                sm: { type: 'sm', chromatids: 1, origin: 'pat', sexLabel: 'Z', crossedOver: false }
            }));

            const tickedCount = punnettTicks.filter(Boolean).length;

            if (appMode === 'selection') {
                return (
                    <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6 text-slate-100">
                        <h1 className="text-4xl font-black mb-8 text-center text-white flex items-center gap-3">
                            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                <path d="M16 7h.01"/><path d="M3.4 18H12a8 8 0 0 0 8-8V7a4 4 0 0 0-7.28-2.3L2 20h3.4z"/><path d="m20 7 2 .5-2 .5"/><path d="M10 18v3"/><path d="M14 17.75V21"/><path d="M7 18a6 6 0 0 0 3.84-10.61"/>
                            </svg>
                            PigeonEtics: Divisi√≥n Celular
                        </h1>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl w-full">
                            <div onClick={() => setAppMode('aprendizaje')} className="bg-slate-800 border-2 border-blue-500 rounded-3xl p-8 cursor-pointer hover:bg-slate-700 hover:scale-105 transition-all shadow-[0_0_30px_rgba(59,130,246,0.3)]">
                                <div className="bg-blue-500 text-white w-14 h-14 rounded-2xl flex items-center justify-center mb-6">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                                </div>
                                <h2 className="text-2xl font-bold mb-3">Simulador de Aprendizaje</h2>
                                <p className="text-slate-400 leading-relaxed">Modo guiado paso a paso. Incluye explicaciones te√≥ricas, tutoriales interactivos y un <b>Cuaderno de Laboratorio</b> integrado para anotar tus respuestas y generar una ficha de estudio.</p>
                            </div>
                            <div onClick={() => setAppMode('laboratorio')} className="bg-slate-800 border-2 border-purple-500 rounded-3xl p-8 cursor-pointer hover:bg-slate-700 hover:scale-105 transition-all shadow-[0_0_30px_rgba(168,85,247,0.3)]">
                                <div className="bg-purple-500 text-white w-14 h-14 rounded-2xl flex items-center justify-center mb-6">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 2v2"/><path d="M15 2v2"/><path d="M12 2v2"/><path d="M2 12h20"/><path d="M4 12v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-6"/><path d="M9 22v-2"/><path d="M15 22v-2"/><path d="M12 22v-2"/></svg>
                                </div>
                                <h2 className="text-2xl font-bold mb-3">Simulador Laboratorio</h2>
                                <p className="text-slate-400 leading-relaxed">Modo de simulaci√≥n libre. Sin interrupciones te√≥ricas ni preguntas. Ideal para repetir los experimentos r√°pidamente o si ya dominas la teor√≠a.</p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-screen overflow-hidden bg-[#f8fafc] relative">
                    
                    {/* ENCABEZADO Y PUNTUACI√ìN */}
                    <header className="flex flex-col bg-white px-4 py-3 md:px-6 md:py-4 shadow-sm border-b border-slate-200 shrink-0 z-40">
                        <div className="flex flex-col md:flex-row justify-between items-center w-full mb-2">
                            <div className="flex items-center justify-between w-full md:w-auto">
                                <div>
                                    <h1 className="text-xl md:text-2xl font-extrabold text-slate-800 flex items-center gap-2">
                                        <span className="bg-blue-600 text-white p-2 rounded-lg">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <path d="M16 7h.01"/><path d="M3.4 18H12a8 8 0 0 0 8-8V7a4 4 0 0 0-7.28-2.3L2 20h3.4z"/><path d="m20 7 2 .5-2 .5"/><path d="M10 18v3"/><path d="M14 17.75V21"/><path d="M7 18a6 6 0 0 0 3.84-10.61"/>
                                            </svg>
                                        </span>
                                        PigeonEtics: Laboratorio Celular
                                        <button onClick={() => setAppMode('selection')} className="ml-2 md:ml-4 text-[10px] md:text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 md:px-3 md:py-1.5 rounded hover:bg-blue-100 transition-colors shadow-sm border border-blue-200">
                                            Cambiar Modo
                                        </button>
                                    </h1>
                                    <p className="text-slate-500 text-xs mt-1 hidden md:block">Sigue la herencia de la Cresta de los progenitores desde la Meiosis.</p>
                                </div>
                            </div>
                            
                            <div className="flex flex-col items-end gap-2 mt-3 md:mt-0 w-full md:w-auto">
                                <div className="flex gap-2 bg-slate-100 p-1 rounded-lg w-full md:w-auto overflow-x-auto custom-scrollbar">
                                    <button onClick={clearData} className="px-3 py-1 md:py-2 rounded-md font-bold text-slate-400 hover:bg-red-100 hover:text-red-600 transition-all shrink-0" title="Borrar y Reiniciar Todo">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                    </button>
                                    <button onClick={() => resetSim(mode)} className="px-3 py-1 md:py-2 rounded-md font-bold text-slate-400 hover:bg-blue-100 hover:text-blue-600 transition-all shrink-0" title="Reiniciar Fase Actual">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                                    </button>
                                    <button onClick={() => resetSim('mitosis')} className={`px-3 py-1 md:py-2 rounded-md font-bold text-xs md:text-sm transition-all shrink-0 ${mode==='mitosis' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>Mitosis</button>
                                    <button onClick={() => resetSim('meiosis')} className={`px-3 py-1 md:py-2 rounded-md font-bold text-xs md:text-sm transition-all shrink-0 ${mode==='meiosis' ? 'bg-white shadow text-purple-600' : 'text-slate-500 hover:text-slate-700'}`}>Meiosis I & II</button>
                                    <button onClick={() => resetSim('repte')} className={`px-3 py-1 md:py-2 rounded-md font-bold text-xs md:text-sm transition-all shrink-0 ${mode==='repte' ? 'bg-white shadow text-red-600' : 'text-slate-500 hover:text-slate-700'}`}>üïµÔ∏è Investigador</button>
                                </div>
                            </div>
                        </div>
                        {/* BARRA DE PROGRESO DE FASES */}
                        <div className="w-full flex justify-between items-center relative pt-2 md:pt-4 border-t border-slate-100">
                            <div className="absolute left-0 top-[18px] md:top-[26px] w-full h-1 bg-slate-200 -z-10"></div>
                            {['profase', 'metafase', 'anafase', 'telofase1', 'telofase'].map((step, idx) => {
                                if (step === 'telofase1' && mode !== 'meiosis') return null;
                                const stepLabel = step === 'telofase1' ? 'Meiosis I' : (step === 'telofase' && mode === 'meiosis' ? 'Gametos' : step);
                                let stateIdx = ['profase', 'metafase', 'anafase'];
                                if(mode === 'meiosis') stateIdx.push('telofase1');
                                stateIdx.push('telofase');
                                const currentIndex = stateIdx.indexOf(phase);
                                const myIndex = stateIdx.indexOf(step);
                                const isActive = phase === step;
                                const isPast = currentIndex > myIndex;
                                return (
                                    <div key={step} className={`flex flex-col items-center gap-1 bg-white px-1 md:px-3 ${isActive || isPast ? '' : 'opacity-50'}`}>
                                        <div className={`w-3 h-3 md:w-4 md:h-4 rounded-full ${isActive ? phaseBgColors[step] : isPast ? 'bg-slate-400' : 'bg-slate-200'} transition-colors shadow-sm`}></div>
                                        <span className={`text-[8px] md:text-[10px] font-bold uppercase tracking-wider ${isActive ? phaseColors[step].split(' ')[0] : 'text-slate-400'}`}>{stepLabel}</span>
                                    </div>
                                );
                            })}
                        </div>
                    </header>

                    <main className="flex flex-col md:flex-row gap-4 p-4 md:p-6 flex-1 min-h-0 overflow-hidden relative">
                        {/* PANEL LATERAL (FIJO/SCROLLABLE) */}
                        <aside className="w-full md:w-[340px] flex flex-col gap-4 shrink-0 overflow-y-auto custom-scrollbar pb-2">
                            
                            {/* OVERLAY POPUP EDUCATIVO EN APRENDIZAJE */}
                            {appMode === 'aprendizaje' && tutorialPopup.show && (
                                <div className={`bg-white border-l-4 ${phaseColors[phase] ? phaseColors[phase].split(' ')[1] : 'border-blue-500'} rounded-xl shadow-sm p-4 animate-[slideDown_0.3s_ease-out]`}>
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className="text-yellow-500"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg></span>
                                        <h3 className="font-bold text-sm text-slate-800">{tutorialPopup.title}</h3>
                                    </div>
                                    <div className="text-slate-600 text-xs leading-relaxed mb-3">{tutorialPopup.text}</div>
                                    <button onClick={() => setTutorialPopup({ ...tutorialPopup, show: false })} className="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-bold py-1.5 rounded-lg transition-colors">¬°Entendido!</button>
                                </div>
                            )}

                            <div className={`p-3 rounded-xl border-l-4 shadow-sm bg-white ${feedback.type === 'error' ? 'border-red-500 bg-red-50' : feedback.type === 'success' ? 'border-green-500 bg-green-50' : feedback.type === 'warning' ? 'border-yellow-500 bg-yellow-50' : 'border-blue-500'}`}>
                                <h3 className={`font-bold text-xs uppercase mb-1 flex items-center gap-1 ${phaseColors[phase] ? phaseColors[phase].split(' ')[0] : 'text-slate-700'}`}>
                                    {feedback.type === 'error' ? '‚ö†Ô∏è An√°lisis de Error' : feedback.type === 'success' ? '‚úÖ Correcto' : '‚ÑπÔ∏è Informaci√≥n'}
                                </h3>
                                <p className="text-xs text-slate-600 leading-relaxed">{feedback.msg}</p>
                            </div>

                            {/* BOTONES DE ACCI√ìN PRINCIPALES SOBRE EL CUADERNO */}
                            {phase === 'anafase' && (
                                <button onClick={validateResult} className="w-full py-3 rounded-xl font-extrabold text-white text-base shadow-lg transition-transform hover:scale-105 bg-gradient-to-r from-blue-600 to-indigo-600">
                                    Evaluar Resultado
                                </button>
                            )}
                            
                            {phase === 'telofase1' && mode === 'meiosis' && (
                                <button onClick={triggerMeiosisII} className="w-full py-3 rounded-xl font-extrabold text-white text-base shadow-lg transition-transform hover:scale-105 bg-gradient-to-r from-pink-500 to-rose-600 animate-pulse">
                                    Simular Meiosis II
                                </button>
                            )}

                            {phase === 'telofase' && mode === 'meiosis' && (
                                <button onClick={() => setShowPunnett(true)} className="w-full py-3 rounded-xl font-extrabold text-white text-md shadow-lg transition-transform hover:scale-105 bg-purple-600 animate-bounce">
                                    üìä Fase de Fecundaci√≥n
                                </button>
                            )}

                            {/* CONDICIONAL: Cuaderno de Laboratorio o Gu√≠a Normal */}
                            {appMode === 'aprendizaje' ? (
                                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col gap-4">
                                    <h3 className="font-bold text-slate-800 border-b pb-2 text-sm flex items-center gap-2">üß¨ Cuaderno de Laboratorio</h3>
                                    
                                    {mode === 'mitosis' && (
                                        <div className="space-y-4">
                                            <div className={`p-3 rounded-xl border transition-opacity ${phase === 'profase' ? 'bg-teal-50 border-teal-300 opacity-100' : 'bg-white border-slate-200 opacity-60'}`}>
                                                <h4 className="font-bold text-teal-800 text-xs mb-1">1. Profase: Preparando el material</h4>
                                                
                                                <label className="text-[10px] font-bold text-teal-900 block mt-2">¬øPor qu√© se condensa el ADN antes de la divisi√≥n?</label>
                                                <input type="text" className="w-full mt-1 p-1.5 border border-teal-200 rounded text-xs outline-none focus:ring-1 focus:ring-teal-500" value={answers.mit_pro_2 || ''} onChange={e=>handleAns('mit_pro_2', e.target.value)} />
                                                
                                                <label className="text-[10px] font-bold text-teal-900 block mt-2">¬øCu√°ntos cromosomas hay ahora mismo en el n√∫cleo de la c√©lula?</label>
                                                <input type="text" className="w-full mt-1 p-1.5 border border-teal-200 rounded text-xs outline-none focus:ring-1 focus:ring-teal-500" value={answers.mit_pro_3 || ''} onChange={e=>handleAns('mit_pro_3', e.target.value)} />

                                                <label className="text-[10px] font-bold text-teal-900 block mt-2">Anota en tu Sites: Define la diferencia entre "Cromatina" y "Cromosoma".</label>
                                                <textarea className="w-full mt-1 p-1.5 border border-teal-200 rounded text-xs outline-none focus:ring-1 focus:ring-teal-500 resize-none h-16" value={answers.mit_pro_1 || ''} onChange={e=>handleAns('mit_pro_1', e.target.value)} />
                                            </div>

                                            <div className={`p-3 rounded-xl border transition-opacity ${phase === 'metafase' ? 'bg-yellow-50 border-yellow-300 opacity-100' : 'bg-white border-slate-200 opacity-60'}`}>
                                                <h4 className="font-bold text-yellow-800 text-xs mb-1">2. Metafase: Orden en la sala</h4>
                                                <label className="text-[10px] font-bold text-yellow-900 block mt-2">¬øPor qu√© es tan importante que los cromosomas se alineen perfectamente en el centro antes de dividirse?</label>
                                                <textarea className="w-full mt-1 p-1.5 border border-yellow-200 rounded text-xs outline-none focus:ring-1 focus:ring-yellow-500 resize-none h-16" value={answers.mit_met_1 || ''} onChange={e=>handleAns('mit_met_1', e.target.value)} />
                                            </div>

                                            <div className={`p-3 rounded-xl border transition-opacity ${(phase === 'anafase' || phase === 'telofase') ? 'bg-purple-50 border-purple-300 opacity-100' : 'bg-white border-slate-200 opacity-60'}`}>
                                                <h4 className="font-bold text-purple-800 text-xs mb-1">3. Anafase y Telofase: La separaci√≥n</h4>
                                                <label className="text-[10px] font-bold text-purple-900 block mt-2">¬øQu√© es el huso mit√≥tico y c√≥mo funciona como "cables de arrastre"?</label>
                                                <textarea className="w-full mt-1 p-1.5 border border-purple-200 rounded text-xs outline-none focus:ring-1 focus:ring-purple-500 resize-none h-12" value={answers.mit_ana_1 || ''} onChange={e=>handleAns('mit_ana_1', e.target.value)} />
                                                
                                                <label className="text-[10px] font-bold text-purple-900 block mt-2">¬øLas c√©lulas resultantes son id√©nticas o diferentes? ¬øQu√© significa que sean DIPLOIDES (2n)?</label>
                                                <textarea className="w-full mt-1 p-1.5 border border-purple-200 rounded text-xs outline-none focus:ring-1 focus:ring-purple-500 resize-none h-16" value={answers.mit_tel_1 || ''} onChange={e=>handleAns('mit_tel_1', e.target.value)} />
                                                
                                                <label className="text-[10px] font-bold text-purple-900 block mt-2">Gr√°fico: ¬øQu√© ocurre en la fase S de la interfase? ¬øCon cu√°nta cantidad de ADN termina la c√©lula al final de la mitosis?</label>
                                                <textarea className="w-full mt-1 p-1.5 border border-purple-200 rounded text-xs outline-none focus:ring-1 focus:ring-purple-500 resize-none h-16" value={answers.mit_tel_2 || ''} onChange={e=>handleAns('mit_tel_2', e.target.value)} />
                                            </div>
                                        </div>
                                    )}

                                    {mode === 'meiosis' && (
                                        <div className="space-y-4">
                                            <div className={`p-3 rounded-xl border transition-opacity ${phase === 'profase' ? 'bg-teal-50 border-teal-300 opacity-100' : 'bg-white border-slate-200 opacity-60'}`}>
                                                <h4 className="font-bold text-teal-800 text-xs mb-1">1. Profase I y Recombinaci√≥n</h4>
                                                <label className="text-[10px] font-bold text-teal-900 block mt-2">¬øQu√© es el Crossing-over y por qu√© es una ventaja evolutiva tan importante?</label>
                                                <textarea className="w-full mt-1 p-1.5 border border-teal-200 rounded text-xs outline-none focus:ring-1 focus:ring-teal-500 resize-none h-16" value={answers.mei_pro_1 || ''} onChange={e=>handleAns('mei_pro_1', e.target.value)} />
                                            </div>

                                            <div className={`p-3 rounded-xl border transition-opacity ${(phase === 'metafase' || phase === 'anafase') ? 'bg-yellow-50 border-yellow-300 opacity-100' : 'bg-white border-slate-200 opacity-60'}`}>
                                                <h4 className="font-bold text-yellow-800 text-xs mb-1">2. Metafase I y Anafase I</h4>
                                                <label className="text-[10px] font-bold text-yellow-900 block mt-2">A diferencia de la mitosis, ¬øqu√© est√°s separando al activar el huso en la Anafase I?</label>
                                                <textarea className="w-full mt-1 p-1.5 border border-yellow-200 rounded text-xs outline-none focus:ring-1 focus:ring-yellow-500 resize-none h-12" value={answers.mei_ana_1 || ''} onChange={e=>handleAns('mei_ana_1', e.target.value)} />
                                            </div>

                                            <div className={`p-3 rounded-xl border transition-opacity ${(phase === 'telofase1' || phase === 'telofase') ? 'bg-green-50 border-green-300 opacity-100' : 'bg-white border-slate-200 opacity-60'}`}>
                                                <h4 className="font-bold text-green-800 text-xs mb-1">3. Meiosis II y Resultado Final</h4>
                                                <label className="text-[10px] font-bold text-green-900 block mt-2">¬øCu√°ntas c√©lulas finales (√≥vulos) has obtenido? ¬øSon id√©nticas? ¬øQu√© significa HAPLOIDES (n)?</label>
                                                <textarea className="w-full mt-1 p-1.5 border border-green-200 rounded text-xs outline-none focus:ring-1 focus:ring-green-500 resize-none h-16" value={answers.mei_tel_1 || ''} onChange={e=>handleAns('mei_tel_1', e.target.value)} />
                                                
                                                <label className="text-[10px] font-bold text-green-900 block mt-2">Gr√°fico: Al final de la Meiosis II, ¬øcu√°nta cantidad de ADN tiene cada gameto respecto a la original?</label>
                                                <input type="text" className="w-full mt-1 p-1.5 border border-green-200 rounded text-xs outline-none focus:ring-1 focus:ring-green-500" value={answers.mei_tel_2 || ''} onChange={e=>handleAns('mei_tel_2', e.target.value)} />
                                            </div>
                                        </div>
                                    )}

                                    {mode === 'repte' && (
                                        <div className="space-y-4">
                                            <div className="bg-red-50 border border-red-300 p-3 rounded-xl opacity-100">
                                                <h4 className="font-bold text-red-800 text-xs mb-1">üïµÔ∏è Reto Investigador</h4>
                                                <label className="text-[10px] font-bold text-red-900 block mt-2">¬øC√≥mo se llama el error de no separar correctamente los cromosomas? ¬øQu√© s√≠ndrome humano se produce si ocurre en el par 21?</label>
                                                <textarea className="w-full mt-1 p-1.5 border border-red-200 rounded text-xs outline-none focus:ring-1 focus:ring-red-500 resize-none h-16" value={answers.reto_1 || ''} onChange={e=>handleAns('reto_1', e.target.value)} />
                                            </div>
                                        </div>
                                    )}

                                    <button onClick={() => setShowFicha(true)} className="w-full py-3 mt-4 rounded-xl font-extrabold text-indigo-700 bg-indigo-100 hover:bg-indigo-200 border border-indigo-300 transition-colors shadow-sm text-sm">
                                        üìÑ Generar Ficha Completa
                                    </button>
                                </div>
                            ) : (
                                <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex-1 flex flex-col">
                                    <h3 className="font-bold text-slate-800 mb-3 border-b pb-2 text-sm">Gu√≠a de Laboratorio</h3>
                                    
                                    {mode === 'mitosis' && (
                                        <ul className="text-xs text-slate-600 space-y-3 mb-4">
                                            <li><strong className="text-slate-800">Objetivo:</strong> 2 c√©lulas hijas DIPLOIDES (2n) id√©nticas.</li>
                                            <li><strong className="text-slate-800">1. Profase:</strong> Toca/mueve la cromatina y cond√©nsala.</li>
                                            <li><strong className="text-slate-800">2. Metafase:</strong> Alin√©alos en el ecuador.</li>
                                            <li><strong className="text-slate-800">3. Anafase:</strong> Activa el Huso Mit√≥tico para separar las crom√°tidas hermanas autom√°ticamente.</li>
                                        </ul>
                                    )}

                                    {mode === 'meiosis' && (
                                        <ul className="text-xs text-slate-600 space-y-3 mb-4">
                                            <li><strong className="text-slate-800">Objetivo:</strong> Generar gametos HAPLOIDES (n) para obtener una cr√≠a hembra con cresta.</li>
                                            <li><strong className="text-slate-800">1. Profase I:</strong> Condensa el ADN, empareja los hom√≥logos y utiliza las tijeras para el <i>Crossing-over</i>.</li>
                                            <li><strong className="text-slate-800">2. Metafase I:</strong> Alinea los bivalentes en el ecuador.</li>
                                            <li><strong className="text-slate-800">3. Anafase I:</strong> Activa el huso, CLIC en los bivalentes para separarlos y mueve cromosomas <b>enteros</b> a los polos.</li>
                                        </ul>
                                    )}

                                    {mode === 'repte' && (
                                        <div className="text-xs text-slate-600 space-y-3 mb-4">
                                            <div className="bg-red-100 text-red-800 p-2 rounded text-[10px] font-bold uppercase tracking-wide">Caso Cl√≠nico: Trisom√≠a 21</div>
                                            <p>Un paciente presenta S√≠ndrome de Down (3 copias del cromosoma 21 en lugar de 2).</p>
                                            <p><b>Tu misi√≥n:</b> Modeliza c√≥mo un error mec√°nico genera un gameto con exceso de material gen√©tico.</p>
                                        </div>
                                    )}

                                    {/* LEYENDA */}
                                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 shadow-sm mt-auto">
                                        <h4 className="font-bold text-[10px] uppercase text-slate-400 mb-2">Leyenda de Alelos</h4>
                                        <div className="flex flex-col gap-2 text-xs font-bold text-slate-600">
                                            <div className="flex items-center gap-2">
                                                <div className="w-3 h-3 rounded-full bg-blue-500 border-2 border-white shadow-sm"></div>
                                                <span>C = Dominante (Sin cresta)</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <div className="w-3 h-3 rounded-full bg-red-500 border-2 border-white shadow-sm"></div>
                                                <span>c = Recesivo (Cresta)</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </aside>

                        {/* ESCENARIO PRINCIPAL CON CONTENEDOR DE SCROLL PARA IPAD */}
                        <div className="flex-1 flex flex-col min-h-0 relative overflow-hidden">
                            
                            {/* TOAST CHIVATO DE FASE FLOTANTE ARRIBA */}
                            {phaseToast && (
                                <div className="absolute top-4 left-1/2 transform -translate-x-1/2 z-50 bg-slate-800 text-white px-6 py-3 rounded-2xl shadow-2xl animate-[fadeInOut_4s_ease-in-out] flex flex-col items-center border-b-4 border-yellow-400 min-w-[300px] text-center pointer-events-none">
                                    <span className="uppercase text-[10px] font-black tracking-widest text-yellow-400 mb-1">Entrando en {phaseToast.phase}</span>
                                    <span className="text-sm font-medium">{phaseToast.text}</span>
                                </div>
                            )}

                            {/* CAJA DE HERRAMIENTAS */}
                            <div className="absolute top-4 right-4 z-40 flex flex-col gap-2 pointer-events-auto">
                                {/* Bola de cromatina inicial */}
                                {phase === 'profase' && !isCondensed && chromatinZone === 'toolbox' && (
                                    <div className="bg-white/90 backdrop-blur p-2 rounded-xl border border-slate-300 shadow-sm flex flex-col items-center animate-[pulse_2s_infinite]">
                                        <span className="text-[10px] font-bold text-slate-500 uppercase mb-2">Herram.</span>
                                        <div 
                                            draggable 
                                            onClick={(e) => { e.stopPropagation(); setSelectedItem({ type: 'chromatin', id: 'chromatin' }); }}
                                            onDragStart={(e) => handleDragStart(e, { type: 'chromatin', id: 'chromatin' })} 
                                            className={`relative w-12 h-12 md:w-16 md:h-16 rounded-full bg-pink-100 border-2 border-pink-300 flex items-center justify-center cursor-pointer shadow-md overflow-hidden hover:scale-105 transition-transform ${selectedItem?.type === 'chromatin' ? 'ring-4 ring-yellow-400 bg-yellow-200' : ''}`}
                                            title="Toca y luego toca el citoplasma"
                                        >
                                            <svg width="40" height="40" viewBox="0 0 100 100">
                                                <path d="M10,50 Q30,10 50,50 T90,50 Q70,90 50,50 T10,50 Z" fill="none" stroke="#ef4444" strokeWidth="3" strokeDasharray="4,4"/>
                                                <path d="M20,30 Q40,70 60,30 T80,80 Q50,40 20,30 Z" fill="none" stroke="#3b82f6" strokeWidth="3" strokeDasharray="4,4"/>
                                            </svg>
                                        </div>
                                    </div>
                                )}
                                {/* Herramienta Condensar */}
                                {phase === 'profase' && !isCondensed && chromatinZone === 'cytoplasm' && (
                                    <div className="bg-white/90 backdrop-blur p-2 rounded-xl border border-slate-300 shadow-sm flex flex-col items-center animate-[pulse_2s_infinite]">
                                        <span className="text-[10px] font-bold text-slate-500 uppercase mb-2">Herram.</span>
                                        <button 
                                            onClick={() => {
                                                setIsCondensed(true);
                                                setFeedback({ type: 'success', msg: '¬°ADN condensado en cromosomas! Ahora puedes ver los alelos.' });
                                                setTutorialPopup({ show: true, minimized: false, title: 'ADN Condensado', text: <span>El ADN se ha empaquetado en forma de <strong className="text-teal-600">X (cromosomas duplicados)</strong>.<br/><br/>F√≠jate en las cajas blancas junto a los cromosomas grandes:<br/>Letra "C": Alelo dominante (Sin Cresta).<br/>Letra "c": Alelo recesivo (Con Cresta).</span> });
                                                if (mode === 'mitosis' || mode === 'repte') checkPhaseCompletion(chromosomes);
                                            }}
                                            className="flex flex-col items-center p-2 rounded-lg transition-all border-2 bg-slate-50 border-slate-300 hover:bg-teal-50 hover:text-teal-600 hover:border-teal-400 text-slate-600"
                                            title="Condensar Cromatina"
                                        >
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                            <span className="text-[10px] mt-1 font-bold">Condensar</span>
                                        </button>
                                    </div>
                                )}
                                {/* Herramienta Crossing Over (TIJERAS) */}
                                {phase === 'profase' && mode === 'meiosis' && isCondensed && chromosomes.some(c => c.zone.includes('bivalent') && !c.crossedOver) && (
                                    <div className="bg-white/90 backdrop-blur p-2 rounded-xl border border-slate-300 shadow-sm flex flex-col items-center animate-[pulse_2s_infinite]">
                                        <span className="text-[10px] font-bold text-slate-500 uppercase mb-2">Herram.</span>
                                        <button 
                                            onClick={() => setShowCrossingModal(true)}
                                            className="flex flex-col items-center p-2 rounded-lg transition-all border-2 bg-purple-50 border-purple-300 text-purple-700 hover:bg-purple-100"
                                        >
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="6" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><line x1="20" y1="4" x2="8.12" y2="15.88"></line><line x1="14.47" y1="14.48" x2="20" y2="20"></line><line x1="8.12" y1="8.12" x2="12" y2="12"></line></svg>
                                            <span className="text-[10px] mt-1 font-bold">Recombinar</span>
                                        </button>
                                    </div>
                                )}
                                {/* Herramienta Huso Mit√≥tico y Anillo contr√°ctil */}
                                {(phase === 'metafase' || phase === 'anafase') && (
                                    <div className="bg-white/90 backdrop-blur p-2 rounded-xl border border-slate-300 shadow-sm flex flex-col items-center">
                                        <span className="text-[10px] font-bold text-slate-500 uppercase mb-2">Herram.</span>
                                        <button 
                                            onClick={() => {
                                                setSpindleActive(true);
                                                setFeedback({ type: 'success', msg: '¬°Huso mit√≥tico activado! Cromosomas separados autom√°ticamente.' });
                                                
                                                // AUTO SEPARACI√ìN 
                                                if (phase === 'anafase') {
                                                    if (mode === 'mitosis' || mode === 'repte') {
                                                        let newChroms = [];
                                                        chromosomes.forEach(c => {
                                                            if (c.chromatids === 2 && c.zone === 'equator') {
                                                                const leftAllele = c.alleles ? c.alleles[0] : null;
                                                                const rightAllele = c.alleles ? c.alleles[1] : null;
                                                                newChroms.push({ ...c, id: c.id + '_L', chromatids: 1, alleles: leftAllele ? [leftAllele, null] : null });
                                                                newChroms.push({ ...c, id: c.id + '_R', chromatids: 1, alleles: rightAllele ? [rightAllele, null] : null });
                                                            } else {
                                                                newChroms.push(c);
                                                            }
                                                        });
                                                        setChromosomes(newChroms);
                                                    } else if (mode === 'meiosis') {
                                                        let newChroms = chromosomes.map(c => {
                                                            if (c.zone.startsWith('equator_bivalent')) return { ...c, zone: 'equator' };
                                                            return c;
                                                        });
                                                        setChromosomes(newChroms);
                                                    }
                                                }

                                                setTutorialPopup({ show: true, minimized: false, title: 'El Huso Acrom√°tico', text: <span>Has activado el <strong className="text-purple-600">huso mit√≥tico</strong>.<br/><br/>Estas l√≠neas funcionan como cables de arrastre: se enganchan a los centr√≥meros y tiran mec√°nicamente del material gen√©tico.<br/><br/>¬°Para facilitarlo en iPad, <strong className="text-purple-600">los cromosomas se han separado autom√°ticamente</strong>! Ahora mueve las partes a los polos opuestos.</span> });
                                            }}
                                            className={`flex flex-col items-center p-2 rounded-lg transition-all border-2 ${spindleActive ? 'bg-blue-50 border-blue-400 text-blue-600' : 'bg-slate-50 border-slate-200 text-slate-400 hover:bg-slate-100 hover:text-slate-600'}`}
                                            title="Activar Huso Mit√≥tico"
                                        >
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 2v20M8 6l8 12M16 6l-8 12"/></svg>
                                            <span className="text-[10px] mt-1 font-bold">Huso</span>
                                        </button>
                                    </div>
                                )}
                                {/* Anillo Contr√°ctil al terminar Anafase */}
                                {(phase === 'telofase' || phase === 'telofase1') && !cytokinesisDone && (
                                    <div className="bg-white/90 backdrop-blur p-2 rounded-xl border border-slate-300 shadow-sm flex flex-col items-center animate-[pulse_2s_infinite]">
                                        <span className="text-[10px] font-bold text-slate-500 uppercase mb-2">Herram.</span>
                                        <button 
                                            onClick={() => {
                                                setCytokinesisDone(true);
                                                if (mode === 'mitosis') {
                                                    setFeedback({ type: 'success', msg: '¬°Excelente! Has creado dos c√©lulas hijas.' });
                                                    setTutorialPopup({ show: true, minimized: false, title: '¬°Citocinesis y Mitosis Finalizada!', text: <span>El <strong className="text-pink-600">anillo de prote√≠nas contr√°ctiles (actina y miosina)</strong> ha estrangulado el citoplasma de la c√©lula madre hasta dividirla f√≠sicamente (Citocinesis).<br/><br/>F√≠jate en el resultado: tienes 2 c√©lulas hijas.<br/><br/>Las crom√°tidas simples que separaste ahora se consideran <strong className="text-green-600">NUEVOS CROMOSOMAS COMPLETOS</strong>.<br/><br/>Estas c√©lulas son <strong className="text-green-600">DIPLOIDES (2n)</strong>, conservando la totalidad de la informaci√≥n gen√©tica original.</span> });
                                                } else if (mode === 'meiosis') {
                                                    setFeedback({ type: 'success', msg: '¬°Meiosis I superada! Has reducido el n√∫mero cromos√≥mico.' });
                                                    setTutorialPopup({ show: true, minimized: false, title: '¬°Citocinesis y Meiosis I Completada!', text: <span>El <strong className="text-pink-600">anillo de actina y miosina</strong> ha dividido la c√©lula.<br/><br/>Has separado los <strong className="text-green-600">cromosomas hom√≥logos</strong>. Ahora tienes 2 c√©lulas con la cantidad original de ADN (C).<br/><br/>Para formar los gametos definitivos, pulsa "Simular Meiosis II" en el cuaderno.</span> });
                                                } else {
                                                    setFeedback({ type: 'success', msg: '¬°Reto Conseguido! Has modelizado una no-disyunci√≥n.' });
                                                    setTutorialPopup({ show: true, minimized: false, title: 'Diagn√≥stico Cl√≠nico', text: <span>Has logrado forzar un error de "No-disyunci√≥n".<br/><br/>Al mover mal los cromosomas a prop√≥sito, has visto c√≥mo una c√©lula hija se queda con material de m√°s.<br/><br/>Si fuera un gameto humano, originar√≠a s√≠ndromes gen√©ticos, como la Trisom√≠a 21.</span> });
                                                }
                                            }}
                                            className={`flex flex-col items-center p-2 rounded-lg transition-all border-2 bg-pink-50 border-pink-400 text-pink-600 hover:bg-pink-100 hover:text-pink-700`}
                                            title="Activar Anillo Contr√°ctil"
                                        >
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M22 12h-4"/><path d="M2 12h4"/><path d="M12 2v4"/><path d="M12 22v-4"/></svg>
                                            <span className="text-[10px] mt-1 font-bold leading-tight text-center">Anillo<br/>Contr√°ctil</span>
                                        </button>
                                    </div>
                                )}
                            </div>

                            {/* CONTENEDOR SCROLLABLE PARA ASEGURAR VISIBILIDAD DEL CITOPLASMA */}
                            <div className="w-full h-full flex flex-col overflow-y-auto custom-scrollbar pb-4 pr-2">
                                
                                {/* VISUALIZACI√ìN DE RESULTADOS FINALES E INTERMEDIOS */}
                                {((phase === 'telofase' || phase === 'telofase1') && cytokinesisDone) ? (
                                    <div className="w-full flex-1 flex flex-col items-center justify-start bg-slate-50 rounded-[40px] md:rounded-[60px] border-4 border-slate-200 relative z-20 min-h-[500px]">
                                        <h2 className="text-base md:text-lg font-black text-slate-700 uppercase tracking-widest mt-4 md:mt-6 mb-2 md:mb-4">{phase === 'telofase1' ? 'Resultado Meiosis I' : 'Resultado Final'}</h2>
                                        
                                        {(mode === 'mitosis' || mode === 'repte' || phase === 'telofase1') ? (
                                            <div className="flex flex-col md:flex-row w-full gap-4 md:gap-8 items-center justify-center pt-2 px-2 md:px-4">
                                                <div className="w-40 h-40 md:w-64 md:h-64 bg-blue-50/60 rounded-[30px] md:rounded-[60px] border-4 border-blue-300 shadow-xl flex flex-col items-center justify-center relative">
                                                    <span className="absolute top-2 md:top-4 text-[10px] md:text-xs font-bold text-slate-600 uppercase">C√©lula 1</span>
                                                    <div className="flex gap-2 md:gap-4 mb-2 bg-white/50 p-2 md:p-3 rounded-xl border border-slate-300 mt-4">
                                                        <div className="flex gap-1 md:gap-2 items-end transform scale-75 md:scale-100">
                                                            {chromosomes.filter(c => c.zone === 'poleTop' && c.type === 'lg').map(c => <ChromosomeSVG key={c.id} {...c} isSelectable={false} />)}
                                                        </div>
                                                        <div className="flex gap-1 md:gap-2 items-end transform scale-75 md:scale-100">
                                                            {chromosomes.filter(c => c.zone === 'poleTop' && c.type === 'sm').map(c => <ChromosomeSVG key={c.id} {...c} isSelectable={false} />)}
                                                        </div>
                                                    </div>
                                                    <span className="text-[8px] md:text-[10px] font-bold text-green-700 bg-green-100 px-2 py-1 rounded-md text-center shadow-sm">
                                                        {mode === 'mitosis' ? '2n (Diploide)' : 'n (Haploide duplicado)'}
                                                    </span>
                                                </div>
                                                <div className="w-40 h-40 md:w-64 md:h-64 bg-blue-50/60 rounded-[30px] md:rounded-[60px] border-4 border-blue-300 shadow-xl flex flex-col items-center justify-center relative">
                                                    <span className="absolute top-2 md:top-4 text-[10px] md:text-xs font-bold text-slate-600 uppercase">C√©lula 2</span>
                                                    <div className="flex gap-2 md:gap-4 mb-2 bg-white/50 p-2 md:p-3 rounded-xl border border-slate-300 mt-4">
                                                        <div className="flex gap-1 md:gap-2 items-end transform scale-75 md:scale-100">
                                                            {chromosomes.filter(c => c.zone === 'poleBottom' && c.type === 'lg').map(c => <ChromosomeSVG key={c.id} {...c} isSelectable={false} />)}
                                                        </div>
                                                        <div className="flex gap-1 md:gap-2 items-end transform scale-75 md:scale-100">
                                                            {chromosomes.filter(c => c.zone === 'poleBottom' && c.type === 'sm').map(c => <ChromosomeSVG key={c.id} {...c} isSelectable={false} />)}
                                                        </div>
                                                    </div>
                                                    <span className="text-[8px] md:text-[10px] font-bold text-green-700 bg-green-100 px-2 py-1 rounded-md text-center shadow-sm">
                                                        {mode === 'mitosis' ? '2n (Diploide)' : 'n (Haploide duplicado)'}
                                                    </span>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="flex flex-wrap w-full gap-2 md:gap-4 items-center justify-center pt-2 px-2 md:px-4 pb-4">
                                                {generatedEggs.map((egg, i) => (
                                                    <div key={i} className="w-28 h-32 md:w-48 md:h-52 bg-purple-50/60 rounded-[30px] md:rounded-[40px] border-4 border-purple-300 shadow-xl flex flex-col items-center justify-center relative">
                                                        <span className="absolute top-2 md:top-3 text-[8px] md:text-[10px] font-bold text-slate-600 uppercase">√ìvulo {i+1}</span>
                                                        <div className="flex gap-2 md:gap-3 transform scale-50 md:scale-100 mt-2 mb-4">
                                                            <ChromosomeSVG {...egg.lg} isSelectable={false} />
                                                            <ChromosomeSVG {...egg.sm} isSelectable={false} />
                                                        </div>
                                                        <div className="absolute bottom-[-16px] bg-white border border-purple-200 px-2 md:px-3 py-1 rounded-xl shadow-md flex flex-col items-center text-[8px] md:text-[10px] leading-tight z-10 w-max">
                                                            <span className="font-black text-purple-700 text-[10px] md:text-xs">n = 2 (Haploide)</span>
                                                            <span className="font-bold text-slate-600">ADN = ¬ΩC</span>
                                                            <span className="text-slate-400 text-[8px] hidden md:block">(Cromosoma simple)</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        {(mode === 'mitosis' || mode === 'repte') && (
                                            <div className="mt-6 bg-blue-50 border border-blue-200 p-3 rounded-xl text-xs md:text-sm text-blue-800 shadow-sm max-w-3xl text-center mx-4">
                                                <strong className="block mb-1">¬°F√≠jate en los cromosomas de las c√©lulas hijas!</strong>
                                                Ahora cada cromosoma tiene <strong>una sola crom√°tide</strong> (es un cromosoma simple de cantidad C). No volver√° a tener su cl√°sica forma de "X" hasta que la c√©lula pase por la <strong>fase S</strong> de la interfase y duplique su material gen√©tico para la pr√≥xima divisi√≥n celular.
                                            </div>
                                        )}

                                        {/* Gr√°fico del Ciclo Celular al Final de la divisi√≥n */}
                                        {(phase === 'telofase' && (mode === 'mitosis' || mode === 'meiosis')) && (
                                            <div className="px-2 md:px-4 pb-8 w-full mt-4">
                                                <CellCycleGraph type={mode} />
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    /* RENDERIZADO C√âLULA NORMAL (Fases Activas o Telofase sin dividir) */
                                    <div className="flex-1 bg-blue-50/30 rounded-[40px] md:rounded-[80px] border-4 border-blue-100 flex flex-col relative min-h-[400px] shrink-0 overflow-hidden">
                                        {/* Capa oculta solo para que el huso no se salga de la c√©lula */}
                                        <div className="absolute inset-0 z-0 overflow-hidden rounded-[36px] md:rounded-[76px] pointer-events-none">
                                            {(phase === 'metafase' || phase === 'anafase' || (!cytokinesisDone && (phase === 'telofase' || phase === 'telofase1'))) && <div className={`spindle-fibers ${spindleActive ? 'opacity-100' : 'opacity-30'}`}></div>}
                                        </div>
                                        
                                        <div className="flex-1 p-2 md:p-6 z-10 flex flex-col justify-end">{renderZone('poleTop', 'Polo Norte Celular')}</div>
                                        
                                        {/* Placa Ecuatorial */}
                                        <div 
                                            className="min-h-[100px] md:min-h-[140px] w-full bg-yellow-50/50 border-y-2 border-dashed border-yellow-300 z-10 relative flex flex-col justify-center items-center drop-zone" 
                                            onDragOver={handleDragOver} 
                                            onDrop={(e) => handleDrop(e, 'equator')}
                                            onClick={(e) => handleZoneClick('equator', e)}
                                        >
                                            <div className="absolute top-1/2 left-0 w-full border-t border-red-300 border-dashed transform -translate-y-1/2 z-0 opacity-50 pointer-events-none"></div>
                                            <div className="w-full h-full absolute inset-0 z-0"></div> {/* Capa transparente para capturar el drop */}
                                            <div className="w-full h-full flex flex-wrap justify-center items-center gap-4 md:gap-6 relative z-10 pointer-events-none p-2 md:p-4">
                                                {mode === 'meiosis' && phase === 'profase' ? (
                                                    <span className="text-[10px] md:text-xs text-yellow-600 font-bold z-10 text-center opacity-50">Toca para formar los bivalentes en el citoplasma</span>
                                                ) : (
                                                    chromosomes.filter(c => c.zone === 'equator' || c.zone.startsWith('equator_bivalent')).map((c, i) => {
                                                        if(c.zone.includes('bivalent')) {
                                                            const pair = chromosomes.filter(ch => ch.zone === c.zone);
                                                            if(pair[0] && pair[0].id === c.id) {
                                                                return (
                                                                    <div 
                                                                        key={c.zone} 
                                                                        draggable 
                                                                        onDragStart={(e) => handleDragStart(e, c)} 
                                                                        className={`flex items-center gap-1 chromosome-hover bg-white/80 p-1 md:p-2 rounded-lg border border-purple-300 pointer-events-auto transition-all cursor-pointer ${selectedItem?.id === c.id ? 'ring-4 ring-yellow-400 scale-110 shadow-lg' : ''}`} 
                                                                        onClick={(e) => handleChromClick(e, pair[0])}
                                                                    >
                                                                        <div className="transform scale-75 md:scale-100 flex gap-1"><ChromosomeSVG {...pair[0]} isSelectable={false} /><ChromosomeSVG {...pair[1] || pair[0]} isSelectable={false} /></div>
                                                                    </div>
                                                                );
                                                            }
                                                            return null;
                                                        }
                                                        return (
                                                            <div 
                                                                key={c.id} 
                                                                draggable 
                                                                onDragStart={(e) => handleDragStart(e, c)} 
                                                                className="relative z-10 pointer-events-auto p-1 md:p-2 cursor-pointer transform scale-75 md:scale-100"
                                                                onClick={(e) => handleChromClick(e, c)}
                                                            >
                                                                <ChromosomeSVG {...c} isSelectable={true} isSelected={selectedItem?.id === c.id} />
                                                            </div>
                                                        );
                                                    })
                                                )}
                                            </div>
                                        </div>
                                        <div className="flex-1 p-2 md:p-6 z-10 flex flex-col justify-start">{renderZone('poleBottom', 'Polo Sur Celular')}</div>
                                    </div>
                                )}

                                {/* CITOPLASMA LIBRE (Siempre visible hasta Telofase) */}
                                {(phase !== 'telofase' && phase !== 'telofase1') && (
                                    <div 
                                        className="mt-4 md:mt-6 h-28 md:h-36 bg-slate-100 border-2 border-slate-300 rounded-xl p-2 relative flex justify-center items-center gap-2 md:gap-4 drop-zone shrink-0" 
                                        onDragOver={handleDragOver} 
                                        onDrop={(e) => handleDrop(e, 'cytoplasm')}
                                        onClick={(e) => handleZoneClick('cytoplasm', e)}
                                    >
                                        <span className="absolute inset-0 flex items-center justify-center text-sm md:text-xl font-black text-slate-200 uppercase tracking-widest pointer-events-none text-center">Citoplasma Libre</span>
                                        
                                        {!isCondensed ? (
                                            chromatinZone === 'cytoplasm' ? (
                                                <div 
                                                    draggable 
                                                    onClick={(e) => { e.stopPropagation(); setSelectedItem({ type: 'chromatin', id: 'chromatin' }); }}
                                                    onDragStart={(e) => handleDragStart(e, { type: 'chromatin', id: 'chromatin' })} 
                                                    className={`relative z-10 w-20 h-20 md:w-24 md:h-24 rounded-full bg-pink-100 border-2 border-pink-300 flex items-center justify-center cursor-pointer shadow-md overflow-hidden hover:scale-105 transition-transform ${selectedItem?.type === 'chromatin' ? 'ring-4 ring-yellow-400 bg-yellow-200' : ''}`}
                                                >
                                                    <svg width="60" height="60" viewBox="0 0 100 100" className="md:w-[70px] md:h-[70px]">
                                                        <path d="M10,50 Q30,10 50,50 T90,50 Q70,90 50,50 T10,50 Z" fill="none" stroke="#ef4444" strokeWidth="4" strokeDasharray="4,4"/>
                                                        <path d="M20,30 Q40,70 60,30 T80,80 Q50,40 20,30 Z" fill="none" stroke="#3b82f6" strokeWidth="4" strokeDasharray="4,4"/>
                                                    </svg>
                                                    <span className="absolute text-[8px] md:text-[10px] font-bold text-slate-700 bg-white/80 px-2 py-1 rounded">Cromatina</span>
                                                </div>
                                            ) : null
                                        ) : (
                                            <div className="flex flex-wrap justify-center items-center gap-2 md:gap-6 relative z-10 pointer-events-none">
                                                {chromosomes.filter(c => c.zone === 'nucleus' || c.zone === 'cytoplasm' || (c.zone.startsWith('bivalent') && !c.zone.startsWith('equator'))).map((c, i) => {
                                                    if(c.zone.includes('bivalent')) {
                                                        const pair = chromosomes.filter(ch => ch.zone === c.zone);
                                                        if(pair.length >= 2 && pair[0].id === c.id) {
                                                            return (
                                                                <div 
                                                                    key={c.zone} 
                                                                    draggable 
                                                                    onDragStart={(e) => handleDragStart(e, c)} 
                                                                    className={`flex items-center gap-1 chromosome-hover bg-white/80 p-1 md:p-2 rounded-lg border border-purple-300 pointer-events-auto transition-all cursor-pointer ${selectedItem?.id === c.id ? 'ring-4 ring-yellow-400 scale-110 shadow-lg' : ''}`} 
                                                                    onClick={(e) => handleChromClick(e, pair[0])}
                                                                >
                                                                    <div className="transform scale-75 md:scale-100 flex gap-1"><ChromosomeSVG {...pair[0]} isSelectable={false} /><ChromosomeSVG {...pair[1]} isSelectable={false} /></div>
                                                                </div>
                                                            );
                                                        }
                                                        return null;
                                                    }
                                                    return (
                                                        <div 
                                                            key={c.id} 
                                                            draggable 
                                                            onDragStart={(e) => handleDragStart(e, c)} 
                                                            className="relative z-10 pointer-events-auto p-1 md:p-4 cursor-pointer transform scale-75 md:scale-100"
                                                            onClick={(e) => handleChromClick(e, c)}
                                                        >
                                                            <ChromosomeSVG {...c} isSelectable={true} isSelected={selectedItem?.id === c.id} />
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>

                    {/* MODAL TALLER CROSSING OVER (SOPORTE IPAD) */}
                    {showCrossingModal && (
                        <div className="fixed inset-0 z-[120] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-[slideDown_0.3s_ease-out] overflow-y-auto py-12">
                            <div className="max-w-3xl w-full flex flex-col items-center bg-white p-6 md:p-8 rounded-3xl shadow-2xl mt-auto mb-auto">
                                <h2 className="text-2xl md:text-3xl font-black text-slate-800 mb-2">Laboratorio de Recombinaci√≥n</h2>
                                <p className="text-slate-600 mb-4 text-center max-w-lg text-sm md:text-base">Toca o arrastra los fragmentos inferiores (crom√°tidas interiores) a la "Mesa de Trabajo" y luego interc√°mbialos.</p>
                                
                                <div className="bg-blue-50 border border-blue-200 p-4 rounded-xl w-full text-xs md:text-sm text-blue-800 text-left mb-6 shadow-sm">
                                    <strong className="block mb-1 text-blue-900">¬øQu√© es el Crossing-over y por qu√© es importante?</strong>
                                    Es el proceso por el cual <strong className="text-blue-900">crom√°tidas no hermanas de cromosomas hom√≥logos</strong> intercambian fragmentos de ADN de forma natural durante la Profase I. Su gran ventaja evolutiva es generar una inmensa <b>variabilidad gen√©tica</b> en la descendencia, haciendo que cada gameto sea √∫nico y permitiendo a las especies adaptarse mejor a los cambios del entorno a lo largo del tiempo.
                                </div>
                                
                                <div className="flex gap-8 md:gap-16 items-start relative p-4 md:p-6 bg-slate-50 border-4 border-slate-200 rounded-3xl w-full justify-center">
                                    {/* Cromosoma Materno (Rojo) */}
                                    <div className="flex flex-col items-center gap-1">
                                        <div className="text-red-600 font-bold mb-2 text-sm md:text-base">MADRE (c)</div>
                                        <div className="relative w-[60px] h-[75px] md:w-[80px] md:h-[100px] transform scale-75 md:scale-100 origin-top">
                                            <svg width="80" height="100" viewBox="0 0 80 100" className="absolute top-0 left-0 overflow-visible">
                                                <path d="M40,50 Q20,25 30,5 Q50,25 40,50" fill="#ef4444" stroke="black" strokeWidth="2"/>
                                                <path d="M40,50 Q60,25 50,5 Q30,25 40,50" fill="#ef4444" stroke="black" strokeWidth="2"/>
                                                <path d="M40,50 Q20,75 30,95 Q50,75 40,50" fill="#ef4444" stroke="black" strokeWidth="2"/>
                                                <LocusMarker x={30} y={30} allele="c" color="#ef4444" side="left" />
                                                <LocusMarker x={50} y={30} allele="c" color="#ef4444" side="right" />
                                                <circle cx="40" cy="50" r="6" fill="#fbbf24" stroke="black" strokeWidth="2" />
                                            </svg>
                                            <div 
                                                onDragOver={e=>e.preventDefault()} 
                                                onDrop={(e) => handleDropCO('redChr', e)}
                                                onClick={(e) => handleZoneClickCO('redChr', e)}
                                                className={`absolute top-[50px] left-[40px] w-[20px] h-[45px] border-2 border-dashed rounded-b-full flex items-center justify-center transition-colors cursor-pointer ${coFragments.redChr ? 'border-transparent' : 'border-red-400 bg-red-50/50 hover:bg-red-100'}`}
                                            >
                                                {coFragments.redChr === 'red' && <FragLegSVG color="red" side="right" isSelected={selectedFrag?.color === 'red' && selectedFrag?.source === 'redChr'} onClick={(e) => { e.stopPropagation(); setSelectedFrag({source: 'redChr', color: 'red'}); }} />}
                                                {coFragments.redChr === 'blue' && <FragLegSVG color="blue" side="right" isSelected={selectedFrag?.color === 'blue' && selectedFrag?.source === 'redChr'} onClick={(e) => { e.stopPropagation(); setSelectedFrag({source: 'redChr', color: 'blue'}); }} />}
                                            </div>
                                        </div>
                                    </div>

                                    {/* Cromosoma Paterno (Azul) */}
                                    <div className="flex flex-col items-center gap-1">
                                        <div className="text-blue-600 font-bold mb-2 text-sm md:text-base">PADRE (C)</div>
                                        <div className="relative w-[60px] h-[75px] md:w-[80px] md:h-[100px] transform scale-75 md:scale-100 origin-top">
                                            <svg width="80" height="100" viewBox="0 0 80 100" className="absolute top-0 left-0 overflow-visible">
                                                <path d="M40,50 Q20,25 30,5 Q50,25 40,50" fill="#3b82f6" stroke="black" strokeWidth="2"/>
                                                <path d="M40,50 Q60,25 50,5 Q30,25 40,50" fill="#3b82f6" stroke="black" strokeWidth="2"/>
                                                <path d="M40,50 Q60,75 50,95 Q30,75 40,50" fill="#3b82f6" stroke="black" strokeWidth="2"/>
                                                <LocusMarker x={30} y={30} allele="C" color="#3b82f6" side="left" />
                                                <LocusMarker x={50} y={30} allele="C" color="#3b82f6" side="right" />
                                                <circle cx="40" cy="50" r="6" fill="#fbbf24" stroke="black" strokeWidth="2" />
                                            </svg>
                                            <div 
                                                onDragOver={e=>e.preventDefault()} 
                                                onDrop={(e) => handleDropCO('blueChr', e)}
                                                onClick={(e) => handleZoneClickCO('blueChr', e)}
                                                className={`absolute top-[50px] left-[20px] w-[20px] h-[45px] border-2 border-dashed rounded-b-full flex items-center justify-center transition-colors cursor-pointer ${coFragments.blueChr ? 'border-transparent' : 'border-blue-400 bg-blue-50/50 hover:bg-blue-100'}`}
                                            >
                                                {coFragments.blueChr === 'red' && <FragLegSVG color="red" side="left" isSelected={selectedFrag?.color === 'red' && selectedFrag?.source === 'blueChr'} onClick={(e) => { e.stopPropagation(); setSelectedFrag({source: 'blueChr', color: 'red'}); }} />}
                                                {coFragments.blueChr === 'blue' && <FragLegSVG color="blue" side="left" isSelected={selectedFrag?.color === 'blue' && selectedFrag?.source === 'blueChr'} onClick={(e) => { e.stopPropagation(); setSelectedFrag({source: 'blueChr', color: 'blue'}); }} />}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Mesa de Trabajo */}
                                <div 
                                    className="w-full mt-4 md:mt-6 bg-slate-100 border-4 border-slate-300 rounded-xl p-4 min-h-[100px] md:min-h-[120px] flex flex-col items-center justify-center gap-4 relative cursor-pointer hover:bg-slate-200 transition-colors"
                                    onDragOver={e=>e.preventDefault()} 
                                    onDrop={(e) => handleDropCO('taller', e)}
                                    onClick={(e) => handleZoneClickCO('taller', e)}
                                >
                                    <span className="absolute text-slate-400 font-bold uppercase tracking-widest text-[10px] md:text-xs top-2 left-2 md:left-4 pointer-events-none">Mesa de Trabajo</span>
                                    <div className="flex gap-4">
                                        {coFragments.taller.includes('red') && <FragLegSVG color="red" inTaller side="right" isSelected={selectedFrag?.color === 'red' && selectedFrag?.source === 'taller'} onClick={(e) => { e.stopPropagation(); setSelectedFrag({source: 'taller', color: 'red'}); }} />}
                                        {coFragments.taller.includes('blue') && <FragLegSVG color="blue" inTaller side="left" isSelected={selectedFrag?.color === 'blue' && selectedFrag?.source === 'taller'} onClick={(e) => { e.stopPropagation(); setSelectedFrag({source: 'taller', color: 'blue'}); }} />}
                                        {coFragments.taller.length === 0 && <span className="text-slate-400 italic text-xs md:text-sm pointer-events-none mt-4">Toca aqu√≠ para dejar un fragmento</span>}
                                    </div>
                                </div>

                                <div className="mt-6 md:mt-8 flex gap-4 w-full max-w-md">
                                    <button onClick={() => setShowCrossingModal(false)} className="flex-1 py-3 bg-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-300 text-sm md:text-base">Cancelar</button>
                                    <button 
                                        onClick={applyCrossingOver} 
                                        disabled={!(coFragments.redChr === 'blue' && coFragments.blueChr === 'red')}
                                        className={`flex-1 py-3 font-bold rounded-xl transition shadow-md text-white text-sm md:text-base ${coFragments.redChr === 'blue' && coFragments.blueChr === 'red' ? 'bg-green-600 hover:bg-green-700 animate-pulse' : 'bg-slate-300 opacity-50 cursor-not-allowed'}`}
                                    >
                                        Aplicar Cambios
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL CUADRO DE PUNNETT FINAL (4x4 Libre) */}
                    {showPunnett && (
                        <div className="fixed inset-0 z-[140] bg-slate-900/60 backdrop-blur flex items-start justify-center overflow-y-auto w-full py-10">
                            <div className="bg-white p-4 md:p-8 w-full min-h-screen md:min-h-0 md:max-w-6xl md:rounded-2xl text-center shadow-2xl border-t-8 border-purple-500 flex flex-col items-center">
                                
                                <h2 className="text-2xl md:text-3xl font-black mb-2 md:mb-4 text-slate-800">Cuadro de Punnett de 16 combinaciones</h2>
                                <p className="mb-4 text-slate-600 max-w-4xl mx-auto leading-relaxed text-xs md:text-base px-2">
                                    Calcula las probabilidades de <b>todas</b> las combinaciones posibles. Has simulado la Meiosis de una <b>hembra (ZW, Cc)</b> y obtenido 4 √≥vulos haploides. Ahora los cruzaremos con los 4 espermatozoides de un <b>macho recesivo (ZZ, cc)</b>. Escribe los resultados de genotipo y fenotipo. Selecciona las casillas que cumplan el objetivo.
                                </p>
                                
                                {/* Contador de Probabilidad Arriba (Fracci√≥n Fija sin recortes) */}
                                <div className="mb-4 md:mb-6 flex flex-col items-center py-2 shrink-0">
                                    <span className="text-slate-600 font-bold mb-2 md:mb-3 uppercase tracking-wide text-xs md:text-sm">Probabilidad (Hembra con cresta):</span>
                                    <div className="flex items-center justify-center gap-3 text-2xl md:text-3xl font-black text-orange-600 bg-white p-2 md:p-3 rounded-2xl shadow-sm border border-slate-200">
                                        <div className="bg-orange-100 w-12 h-12 md:w-16 md:h-14 flex items-center justify-center rounded-xl border-2 border-orange-300 shadow-inner leading-none">{tickedCount}</div>
                                        <span className="text-slate-400 font-black text-3xl md:text-5xl leading-none block px-1">/</span>
                                        <div className="bg-slate-100 text-slate-600 w-12 h-12 md:w-16 md:h-14 flex items-center justify-center rounded-xl border-2 border-slate-300 shadow-inner leading-none">16</div>
                                    </div>
                                    
                                    {appMode === 'aprendizaje' && (
                                        <div className="mt-4 w-full max-w-md bg-purple-50 p-3 rounded-xl border border-purple-200 text-left shadow-inner">
                                            <label className="text-[10px] md:text-xs font-bold text-purple-800 uppercase">Escribe la fracci√≥n final obtenida:</label>
                                            <input type="text" className="w-full mt-1 p-2 border border-purple-300 rounded text-sm outline-none focus:ring-2 focus:ring-purple-500" value={answers.punnett_1 || ''} onChange={e=>handleAns('punnett_1', e.target.value)} placeholder="Ej: 4/16" />
                                        </div>
                                    )}
                                </div>

                                {/* Cuadro de Punnett Libre 4x4 */}
                                <div className="flex flex-col items-center w-full overflow-x-auto pb-4 custom-scrollbar shrink-0">
                                    <div className="grid grid-cols-5 gap-1 md:gap-2 text-center text-xs md:text-sm font-bold min-w-[360px] md:min-w-[800px] w-full">
                                        
                                        {/* Fila 1: Cabeceras √ìvulos */}
                                        <div className="bg-slate-100 p-1 md:p-2 rounded-xl flex items-center justify-center text-slate-500 text-[8px] md:text-[10px] uppercase shadow-inner">
                                            ‚ôÇ Macho ‚Üì <br/><br/> ‚ôÄ Hembra ‚Üí
                                        </div>
                                        {generatedEggs.map((egg, idx) => (
                                            <div key={idx} className="bg-pink-100 text-pink-800 p-1 rounded-xl flex flex-col items-center justify-center shadow-sm border border-pink-200">
                                                <span className="text-[8px] md:text-[10px] uppercase mb-1 md:mb-2">√ìvulo {idx+1}</span>
                                                <div className="flex gap-1 md:gap-2 mb-1 md:mb-2 transform scale-50 md:scale-100 origin-bottom">
                                                    <ChromosomeSVG {...egg.lg} isSelectable={false} />
                                                    <ChromosomeSVG {...egg.sm} isSelectable={false} />
                                                </div>
                                                <span className="text-[8px] md:text-xs font-bold bg-white/50 px-1 md:px-2 rounded-md shadow-sm border border-pink-100 mt-1 md:mt-0">{egg.sm.sexLabel} {egg.lg.alleles[0]}</span>
                                            </div>
                                        ))}

                                        {/* Filas 2 a 5: Cabecera Macho + Inputs */}
                                        {maleSperms.map((sperm, rowIdx) => (
                                            <React.Fragment key={rowIdx}>
                                                <div className="bg-blue-100 text-blue-800 p-1 rounded-xl flex flex-col items-center justify-center shadow-sm border border-blue-200">
                                                    <span className="text-[8px] md:text-[10px] uppercase mb-1 md:mb-2">Esperm. {rowIdx+1}</span>
                                                    <div className="flex gap-1 md:gap-2 mb-1 md:mb-2 transform scale-50 md:scale-100 origin-bottom">
                                                        <ChromosomeSVG {...sperm.lg} isSelectable={false} />
                                                        <ChromosomeSVG {...sperm.sm} isSelectable={false} />
                                                    </div>
                                                    <span className="text-[8px] md:text-xs font-bold bg-white/50 px-1 md:px-2 rounded-md shadow-sm border border-blue-100 mt-1 md:mt-0">{sperm.sm.sexLabel} {sperm.lg.alleles[0]}</span>
                                                </div>
                                                {[0,1,2,3].map(colIdx => {
                                                    const cellIdx = rowIdx * 4 + colIdx;
                                                    const isTicked = punnettTicks[cellIdx];
                                                    return (
                                                        <div key={cellIdx} className={`border-2 rounded-xl h-28 md:h-36 relative flex flex-col items-center justify-center p-1 md:p-2 transition-colors ${isTicked ? 'bg-orange-50 border-orange-400 shadow-md' : 'bg-slate-50 border-slate-300 hover:border-purple-400'}`}>
                                                            <button 
                                                                onClick={() => togglePunnettTick(cellIdx)} 
                                                                className={`absolute top-1 right-1 md:top-2 md:right-2 p-1 md:p-1.5 rounded-full transition-colors z-10 shadow-sm ${isTicked ? 'bg-orange-500 text-white hover:bg-orange-600' : 'bg-white text-slate-300 border border-slate-300 hover:bg-slate-100 hover:text-slate-500'}`} 
                                                                title="Marcar celda"
                                                            >
                                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="md:w-[14px] md:h-[14px]"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                                            </button>
                                                            
                                                            <div className="flex gap-1 md:gap-2 w-full justify-center mt-2 md:mt-4">
                                                                <input type="text" maxLength="2" className="w-8 md:w-12 text-center border border-slate-300 rounded text-[10px] md:text-sm font-black text-slate-700 bg-white py-0.5 md:py-1 focus:border-purple-500 outline-none shadow-sm" placeholder="cc" />
                                                                <input type="text" maxLength="2" className="w-8 md:w-12 text-center border border-slate-300 rounded text-[10px] md:text-sm font-black text-slate-700 bg-white py-0.5 md:py-1 focus:border-purple-500 outline-none shadow-sm" placeholder="ZW" />
                                                            </div>
                                                            <div className="flex items-center justify-center w-[95%] md:w-[90%] mt-2 md:mt-3 text-[8px] md:text-xs text-slate-600 font-medium bg-white rounded border border-slate-300 focus-within:border-purple-500 shadow-sm px-0.5 md:px-1 overflow-hidden">
                                                                <span className="text-slate-400 font-bold ml-0.5 md:ml-1">[</span>
                                                                <input type="text" className="w-full text-center bg-transparent outline-none py-0.5 md:py-1 mx-0.5 md:mx-1 placeholder-slate-300" placeholder="Fenotipo" />
                                                                <span className="text-slate-400 font-bold mr-0.5 md:mr-1">]</span>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </React.Fragment>
                                        ))}
                                    </div>
                                </div>

                                <div className="flex flex-col md:flex-row items-center justify-between gap-4 max-w-4xl w-full mt-auto pt-6 border-t border-slate-200 shrink-0">
                                    <div className="bg-yellow-100 border border-yellow-300 text-yellow-800 p-3 md:p-4 rounded-xl font-bold flex-1 flex items-center justify-center gap-3 shadow-sm w-full text-xs md:text-base">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="shrink-0"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                                        ¬°Haz una foto del cuadro resuelto y ponlo en el Google Sites!
                                    </div>
                                    <button onClick={() => setShowPunnett(false)} className="px-8 py-3 md:py-4 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-700 transition-colors shadow-lg whitespace-nowrap w-full md:w-auto text-sm md:text-base">
                                        Cerrar Tabla
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL FICHA DE ESTUDIO COMPLETA */}
                    {showFicha && (
                        <div className="fixed inset-0 z-[200] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4 animate-[slideDown_0.3s_ease-out]">
                            <div className="bg-white rounded-3xl p-6 md:p-8 max-w-4xl w-full h-[85vh] flex flex-col shadow-2xl">
                                <h2 className="text-2xl md:text-3xl font-black text-indigo-800 mb-2">Ficha de Estudio: PigeonEtics</h2>
                                <p className="text-slate-500 text-sm mb-6">Aqu√≠ tienes todas tus respuestas recopiladas. C√≥pialas y p√©galas en tu Google Sites.</p>
                                
                                <textarea 
                                    readOnly 
                                    className="flex-1 w-full bg-slate-50 border border-slate-200 rounded-xl p-4 text-xs md:text-sm font-mono text-slate-700 resize-none outline-none mb-6 custom-scrollbar" 
                                    value={generarTextoFicha()} 
                                />
                                
                                <div className="flex flex-col md:flex-row gap-4 justify-end">
                                    <button onClick={() => { navigator.clipboard.writeText(generarTextoFicha()); alert('¬°Ficha copiada al portapapeles!'); }} className="px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-md text-sm md:text-base flex justify-center items-center gap-2">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                        Copiar Texto
                                    </button>
                                    <button onClick={() => setShowFicha(false)} className="px-6 py-3 bg-slate-200 text-slate-800 font-bold rounded-xl hover:bg-slate-300 text-sm md:text-base">
                                        Cerrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
